<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/mainTemplate">
<head>

    <title>Ofertas</title>

    <!--Jquery Numeric-->
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/numeric/jquery.numeric.min.js'}"></script>

    <!--File Input-->
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-fileinput/css/fileinput.min.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-fileinput/js/fileinput.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-fileinput/js/fileinput_locale_es.js'}"></script>

    <!-- Bootstrap DatePicker -->
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/css/bootstrap-datepicker3.min.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/locales/bootstrap-datepicker.es.min.js'}"></script>

    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/jquery.validate.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/additional-methods.min.js'}"></script>

    <!-- noUiSlider -->
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/noUiSlider/nouislider.min.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/noUiSlider/nouislider.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/wnumb-1.0.2/wNumb.js'}"></script>

    <!--StandoutMe-->
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/standoutme/css/standoutme.min.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/standoutme/js/standoutme.min.js'}"></script>

    <!--Drop Zone-->
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.js'}"></script>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.css'}" rel="stylesheet"/>

    <!--Ekko Lightbox For Images-->
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/ekko-lightbox/dist/ekko-lightbox.min.js'}"></script>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/ekko-lightbox/dist/ekko-lightbox.min.css'}" rel="stylesheet"/>

    <!-- Take Picture -->
    <link rel="stylesheet" th:href="@{/css/take-picture.min.css}"/>
    <script th:src="@{/js/mobile-detect/mobile-detect.js}"></script>
    <script th:src="@{/js/take-picture/take-picture.js}"></script>
    <!-- / Take Picture -->


    <script th:inline="javascript">
        Dropzone.autoDiscover = false;
    </script>

    <script th:inline="javascript" charset="ISO-8859-1">
        /*<![CDATA[*/
        var errorMessage = /*[[${errorMessage}]]*/null;
        var entityRates = /*[[${entityRates}]]*/null;
        var entityRatesJson = JSON.parse(entityRates);
        var v_start = /*[[ ${loanApplication.product.minDaysFirstDueDate} ]]*/null;
        var v_end = /*[[ ${loanApplication.product.maxDaysFirstDueDate} ]]*/null;
        var offerSelected;
        var updModalLoanProductId = /*[[ ${loanApplication.product.id} ]]*/;
        var productAdelantoId = /*[[ ${T(com.affirm.common.model.catalog.Product).SHORT_TERM} ]]*/;
        var dniFront = /*[[${frontDniFile}]]*/null;

        $(document).ready(function () {

            var datebutton = $('#dateSelect');
            // load modal datepicker
            var openDateModal = /*[[ ${loanApplication?.firstDueDate == null} ]]*/;
            if (openDateModal) {
                $('.closeRoundButton').hide();
                $('#endDatePicker').modal({backdrop: 'static', keyboard: false, show: true});
                datebutton.prop("disabled", true);
            } else {
                defaultAjax({
                    url: /*[[@{/__${productUrl}__/__${loanAplicationToken}__/offer/recalculate/json}]]*/,
                    type: 'POST',
                    success: function (data) {
                        $('#offersContainer').replaceWith(data);
                        initializeOffersPanels();
                    }
                });
            }

            //== modal onload ==//
            if ($('#firstDueDate').length > 0) {
                $('#firstDueDate').datepicker({
                    startDate: '+'+v_start+'d',
                    endDate: '+'+v_end+'d',
                    daysOfWeekDisabled: "0,6"
                }).on('changeDate', function (ev) {
                    datebutton.prop("disabled", false);
                    datebutton.removeClass("buttonDisabled");
                });
            }

        });
        $(document).ready(function () {

            $('#editLoanAmmountLink').click(function () {
                $('#text-button').text('Guardar');
                openUpdateoanApplicationModal();
            });

            $.material.init({
                validate: false
            });

            $('#btnSubmit').click(function (e) {
                e.preventDefault();
                if ($('#frmDocuments').valid()) {
                    $('#btnSubmit').loading();
                    defaultAjax({
                        url: /*[[@{/__${productUrl}__/__${loanAplicationToken}__/offer}]]*/null,
                        type: 'POST',
                        form: $('#frmDocuments'),
                        data: $('#frmDocuments').serializeObject(),
                        error: function () {
                            $('#btnSubmit').unloading();
                        }
                    });
                }
            });

            var clone;
            $('#relative1').on('change', function() {

                $('.relative2').attr('disabled', false);
                $('#relative2 option').attr('disabled', false);
                if ($(this).val() != 3) {
                    $('.relative2').attr('disabled', false);
                    $('#relative2 option[value="'+ $(this).val() + '"]').attr('disabled', true);
                }

                console.log(clone);
            });
        });

        function initializeOffersPanels() {
            $('.fa-check').hide();
            $('#loanOfferId').val('');

            $('.title-steps').show();
            if($('.offer-box').length == 1 ) {
                $('.offer-box').addClass("offer-box-active");
                $('#loanOfferId').val($('.offer-box-active').attr('data_offer'));
                if (dniFront) {
                    $('#documentBlock, #frmDocumentsContainer, #docSection').show(300);
                    $("html, body").animate({scrollTop: $("#docSection").offset().top}, 1000);
                } else {
                    $('#documentBlock').show(300);
                }

                $('.title-steps').html('Este es el cr&eacute;dito que tenemos para ti');
            }

            $('.offer-panel').each(function (index, element) {
                $(this).click(function () {
                    $('.offer-panel').each(function () {
                        $(this).removeClass("offer-box-active");
                    });
                    $(this).addClass("offer-box-active");
                    //$(this).find('#checkSelected').show();
                    $('#loanOfferId').val($(this).attr('data_offer'));

                    // Wen selected an offer, open the other part of the form
                    switch ( Number($(this).attr('data_selected')) % 3 ) {
                        case 0:
                            $('.dynamicColor').css({'background': '#26CAD3'});
                            break;
                        case 1:
                            $('.dynamicColor').css({'background': '#FDDB33'});
                            break;
                        case 2:
                            $('.dynamicColor').css({'background': '#F7323F'});
                            break;
                    }


                    $('#frmDocumentsContainer, #documentBlock').show(300);
                    $("html, body").animate({scrollTop: $("#documentBlock").offset().top}, 1000);

                    // validate if Icar is active
                    // if false show document section unless icar section
                    if (!$('#icarIsActive').length) {
                        $('#docSection').show(300);
                    }


                });

                $(this).find('.anchorButton').click(function (e) {
                    $($(this).data('target')).modal('show');
                    e.stopPropagation();
                })

            });
            $('#loadingoffer').css({'display': 'none'});
        }

        function recalculate() {
            $('[name=installmentAmmount]').each(function () {
                $(this).html("");
            });
            $('[name=commission]').each(function () {
                $(this).html("");
            });
            $('[name=offerAmmount]').each(function () {
                $(this).html("");
            });
            $('[name=effectiveAnnualRate]').each(function () {
                $(this).html("");
            });

            $('#udtModal').loading();

            defaultAjax({
                url: /*[[@{/__${productUrl}__/__${loanAplicationToken}__/offer/recalculate/json}]]*/,
                type: 'POST',
                data: {
                    ammount: $('#loanApplicationHowMany-input').val(),
                    installments: $('#loanApplicationPeriodMonths-input').length > 0 ? $('#loanApplicationPeriodMonths-input').val() : ($('#loanApplicationShorTermDays-input').length > 0 ? $('#loanApplicationShorTermDays-input').val() : '')
                },
                success: function (data) {
                    $('#offersContainer').replaceWith(data);
                    initializeOffersPanels();

                    var s = /*[[${loanApplication?.product.paymentType.singularName}]]*/,
                            p = /*[[${loanApplication?.product.paymentType.pluralName}]]*/;

                    $('#headerAmmountLabel').html("S/. " + thousandWithSpace($('#loanApplicationHowMany-input').val()))
                    if ($('#loanApplicationPeriodMonths-input').length > 0) {

                        $('#headerInstallmentsLabel').html( "(" + $('#loanApplicationPeriodMonths-input').val() + " " + ( ( $('#loanApplicationPeriodMonths-input').val() > 1 ) ? p : s) + ")") ;
                    } else if ($('#loanApplicationShorTermDays-input').length > 0) {
                        $('#headerInstallmentsLabel').html("(" + $('#loanApplicationShorTermDays-input').val() + " "+ (($('#loanApplicationShorTermDays-input').val() > 1) ? p : s) +")")
                    }

                    $('#udtModal').unloading();
                    $('#updateLoanApplicationModal').modal('hide');
                },
                error: function () {
                    $('#udtModal').unloading();
                }
            });
        }

        function openUpdateoanApplicationModal() {
            var url = /*[[@{/__${productUrl}__/__${loanAplicationToken}__/offer/recalculate/modal}]]*/;
            $('#updateLoanApplicationModal').modal({backdrop: 'static', keyboard: false, show: true});
            $('#updateLoanApplicationModal .loading').show();
            $('#updateLoanApplicationModal .content').hide();
            $('#updateLoanApplicationModal .content').load(url, null, function () {
                $('#updateLoanApplicationModal .loading').hide(300);
                $('#updateLoanApplicationModal .content').show(300);
            });
        }

        function toNumberString(number) {
            return Number(number.replace(/[^0-9]/g, ''));
        }

        function preventBack() {
            window.history.forward();
        }
        setTimeout("preventBack()", 0);
        window.onunload = function () {
            null
        };

        function permitOnlyNumbers(element) {
            element.on('keypress keyup blur', function (event) {
                $(this).val($(this).val().replace(/[^\d].+/, ""));
                if ((event.which < 48 || event.which > 57)) {
                    event.preventDefault();
                }
            });
        }
        //        $(function () {
        //            $('.docInputFile').on('change', function (event) {
        //                event.preventDefault();
        //                $('#refSection').css({'display': 'block'});
        //                $('#refSection').addClass('fadeIn');
        //                $('#btnSubmit').css({'display': 'inline-block'});
        //            });
        //        });



        /*]]>*/
    </script>

    <script th:inline="javascript" charset="ISO-8859-1" th:if="${icarValidation == null}">
        /*<![CDATA[*/
        function idCloudShowResultImage($json, image_name) {
            if ($json.hasOwnProperty(image_name)) {
                $image1cut = 'data:image/jpeg;base64,' + $json[image_name];
                $('div#iCar-body').append('<b>' + image_name + '</b><br>');
                $('div#iCar-body').append('<img src="' + $image1cut + '"><br>');
            }
        }

        /*function hideIcar() {
         console.log('Escondiendo ICAR');
         $('#docSection').fadeIn(400, function () {
         $("html, body").animate({scrollTop: $("#docSection").offset().top}, 1000);
         });
         $('#iCar-body, #iCar-body .icar-container').css({'background': 'none', 'padding': 0});
         $('#iCar-body .icar-container').find('h1').css({'display': 'none'});
         $("LINK[href*='https://idcloudwidget.icarvision.com/css/x3dom.css']").remove();
         $("LINK[href*='https://idcloudwidget.icarvision.com/css/styles.css']").remove();
         $('.icar-header').hide();
         return true;
         }*/

        function idCloudResult($json) { //TODO ASYNC async
            console.log('Resultado recibido');
            console.log(JSON.stringify($json));
            if ($json.hasOwnProperty('Fields')) {
                var fields = '';
                $.each($json.Fields, function (index) {
                    fields = fields + '<b>' + this.Code + ': ' + '</b>'
                    fields = fields + this.Value + '<br>';
                });
                $('#frmDocuments, #docSection').fadeIn(400, function () {
                    $("html, body").animate({scrollTop: $("#docSection").offset().top}, 1000);
                });
                $('#iCar-body, #iCar-body .icar-container').css({'background': 'none', 'padding': 0});
                $('#iCar-body .icar-container').find('h1').css({'display': 'none'});
                $("LINK[href*='https://idcloudwidget.icarvision.com/css/x3dom.css']").remove();
                $("LINK[href*='https://idcloudwidget.icarvision.com/css/styles.css']").remove();
                $('.icar-header').hide();
                //$('div#iCar-body').append(fields);
            }

            defaultAjax({
                url: /*[[@{/traditionaloanapplication/__${loanAplicationToken}__/icarvalidation}]]*/,
                type: 'POST',
                data: {
                    result: JSON.stringify($json)
                }
            });
        }
        /*]]>*/
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/

        var dniFront = /*[[${frontDniFile}]]*/null;
        var step = 1;
        var toSend = [null, null, null];

        /*if (dniFront && !dniBack && !selfie) {
            step = 2;
        } else if (!dniFront && dniBack && !selfie){
            step = 3;
        } else if (!dniFront && !dniBack && selfie){
            step = 4;
        } else if (!dniFront && !dniBack && !selfie){
            step = 1;
        } else {
            step = 5;
        }*/

        $(document).on('ready', function(){

            if (dniFront) {
                $('#frmDocumentsContainer, #documentBlock, #frmDocuments, #docSection').fadeIn();
                $("html, body").animate({scrollTop: $("#frmDocuments").offset().top}, 1000);
                if ($('.fileImage').length > 0 ) {
                    $('#refSection,#btnSubmit').fadeIn();
                }
            } else {
                $('#documentBlock').fadeIn();
            }

            // Check if mobile
            var md = new MobileDetect(window.navigator.userAgent),
                    is_mobile = false;

            if (md.mobile()) {
                is_mobile = (md.os().toLowerCase() === 'androidos' || md.os().toLowerCase() === 'ios') ? true : false;
            }

            if (is_mobile) {
                $('.thumb').hide();

                $('.tp-container').hide();
                $('.tp-mobile').css({'display' : 'block'});

                $('.imageFromMobile').on('change', function(){

                    if (step == 1) {
                        var  data = new FormData();
                        data.append("file", $(this)[0].files[0]);
                        data.append("userFileType", /*[[${T(com.affirm.common.model.catalog.UserFileType).DNI_MERGED}]]*/);

                        $('#step-' + step).children('p').hide();
                        $('#step-' + step).children('.loading').removeClass('loading-ajax-invisible');

                        sendImageToServerMobile(data);
                        $('.imageFromMobile').parent('.upload-file').removeClass('active-upload');
                        return false;
                    }

                    if (step == 2) {
                        var  data = new FormData();
                        data.append("file", $(this)[0].files[0]);
                        data.append("userFileType", /*[[${T(com.affirm.common.model.catalog.UserFileType).DNI}]]*/);

                        $('#step-' + step).children('p').hide();
                        $('#step-' + step).children('.loading').removeClass('loading-ajax-invisible');

                        $('.imageFromMobile').parent('.upload-file').removeClass('active-upload');
                        sendImageToServerMobile(data);
                        $(this).remove();
                        return false;
                    }

                    if (step == 3) {
                        var  data = new FormData();
                        data.append("file", $(this)[0].files[0]);
                        data.append("userFileType", /*[[${T(com.affirm.common.model.catalog.UserFileType).SELFIE}]]*/);

                        $('#step-' + step).children('p').hide();
                        $('#step-' + step).children('.loading').removeClass('loading-ajax-invisible');

                        $('.imageFromMobile').parent('.upload-file').removeClass('active-upload');
                        sendImageToServerMobile(data);
                        $(this).remove();
                        return false;
                    }

                });


            } else {

                var tp = new takePicture();

                var photo = [];

                $('#start-camera').on('click', function(e){
                    e.preventDefault();
                    if (tp.checkCompatibility()) {
                        $(this).hide();
                        tp.startCamera();
                        $('#msg').fadeIn();
                    } else {
                        showErrorModal('Lo sentimos tu navegador no es compatible con el componente intente con otro navegador.');
                    }
                });

                $('#take-photo').on('click', function(e){
                    e.preventDefault();
                    switch (step) {

                        case 1:

                            if (toSend[0] != null) {
                                step = 2;
                                //photo['image_' + step] = {file: tp.takePhoto('#thumb_' + step)};
                                //$('#close_' + step).fadeIn();
                            } else {

                                photo['image_' + step] = {file: tp.takePhoto('#thumb_' + step)};
                                $('#close_' + step).fadeIn();

                                $('#msg').fadeIn().html('Genial, ahora una foto del dorso tu documento.');
                                $('#step-' + step).children('p').hide();

                                photo['image_' + step ]['filename'] = "dni-front.jpg";
                                photo['image_' + step ]['fileType'] = /*[[${T(com.affirm.common.model.catalog.UserFileType).DNI}]]*/;
                                toSend[0] = photo['image_' + step];
                                tp.deletePhoto();
                                step ++;
                                paintCurrentStep();
                                if(isComplete()) {
                                    $('#uploadImage').fadeIn();
                                }
                                break;
                            }

                        case 2:

                            if (toSend[1] != null) {
                                step = 3;
                                //photo['image_' + step] = {file: tp.takePhoto('#thumb_' + step)};
                                //$('#close_' + step).fadeIn();;
                            } else {
                                photo['image_' + step] = {file: tp.takePhoto('#thumb_' + step)};
                                $('#close_' + step).fadeIn();

                                $('#msg').hide().fadeIn().html('Y por &uacute;ltimo, t&oacute;mate una selfie.');
                                $('#step-' + step).children('p').hide();

                                photo['image_' + step ]['filename'] = "back-front.jpg";
                                photo['image_' + step ]['fileType'] = /*[[${T(com.affirm.common.model.catalog.UserFileType).DNI}]]*/;
                                toSend[1] = photo['image_' + step];
                                tp.deletePhoto();
                                step ++;
                                paintCurrentStep();
                                if(isComplete()) {
                                    $('#uploadImage').fadeIn();
                                }
                                break;
                            }

                        case 3:

                            if(toSend[2] != null) {
                                break;
                            } else {

                                $('#msg').hide().fadeIn().html('Y por &uacute;ltimo, t&oacute;mate una selfie.');
                                $('#step-' + step).children('p').hide();
                                photo['image_' + step] = {file: tp.takePhoto('#thumb_' + step)};
                                $('#close_' + step).fadeIn();

                                $('#msg').hide();

                                photo['image_' + step ]['filename'] = "selfie.jpg";
                                photo['image_' + step ]['fileType'] = /*[[${T(com.affirm.common.model.catalog.UserFileType).SELFIE}]]*/;
                                toSend[2] = photo['image_' + step];
                                tp.deletePhoto();
                                step ++;
                                paintCurrentStep();
                                if(isComplete()) {
                                    $('#uploadImage').fadeIn();
                                }
                                break;
                            }

                    }
                    console.log(toSend);

                });

                $('.closeRoundButtonThumb').on('click', function(e){
                    e.preventDefault();

                    $('#uploadImage').hide();

                    var src = $(this);
                    toSend[src.data('id')] = null;

                    $('#step-' + (src.data('id') + 1)).addClass('disabled').removeClass('active');
                    $('#step-input-' + (src.data('id') + 1)).parent('.upload-file').removeClass('active-upload');
                    $('#close_' + (src.data('id') + 1)).hide();
                    src.closest('.thumb').children('#thumb_' + (src.data('id') + 1)).removeAttr('src');
                    step = 1;
                    console.log(toSend);
                    return false;

                });

                $('#uploadImage').on('click', function (e) {
                    e.preventDefault();

                    if (isComplete()) {

                        var data1 = new FormData();
                        data1.append("file", toSend[0]['file'], toSend[0]['filename']);
                        data1.append("userFileType", toSend[0]['fileType']);

                        var data2 = new FormData();
                        data2.append("file", toSend[1]['file'], toSend[1]['filename']);
                        data2.append("userFileType", toSend[1]['fileType']);

                        var data3 = new FormData();
                        data3.append("file", toSend[2]['file'], toSend[2]['filename']);
                        data3.append("userFileType", toSend[2]['fileType']);

                        tp.stopStream();
                        $('.closeRoundButtonThumb').hide();
                        sendImageToServer(data1, data2, data3);
                    }

                });

                $('#delete-photo').on('click', function(e){
                    e.preventDefault();
                    tp.deletePhoto();
                });

            }

        });

        function isComplete() {
            return (toSend[0] != null && toSend[1] != null && toSend[2] != null) ? true: false;
        }

        function paintCurrentStep() {
            $('#step-' + (step - 1)).children('.loading').addClass('loading-ajax-invisible');
            $('#step-' + (step - 1)).children('p').fadeIn();
            $('#step-' + (step - 1)).removeClass('disabled').addClass('active');
            $('#step-input-' + step).parent('.upload-file').addClass('active-upload');

        }

        function sendImageToServerMobile(data) {

            var imageUrl = /*[[ @{/__${productUrl}__/__${loanAplicationToken}__/userFile} ]]*/;
            defaultAjax({
                url: imageUrl,
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                type: 'POST',
                success: function (message) {
                    console.log(message);
                    step = step + 1;
                    paintCurrentStep();
                    if (step > 3) {
                        $('.tp-container, #msg').hide();
                        $("#frmDocumentsContainer,#docSection, #frmDocuments, #docSection").fadeIn();
                        $("html, body").animate({scrollTop: $("#frmDocumentsContainer").offset().top}, 1000);
                    }
                }
            });
        }

        function sendImageToServer(data1, data2, data3) {

            var imageUrl = /*[[ @{/__${productUrl}__/__${loanAplicationToken}__/userFile} ]]*/;

            $('#uploadImage').loading();

            defaultAjax({
                url: imageUrl,
                data: data1,
                cache: false,
                contentType: false,
                processData: false,
                type: 'POST',
                success: function () {
                    debugger;
                    defaultAjax({
                        url: imageUrl,
                        data: data2,
                        cache: false,
                        contentType: false,
                        processData: false,
                        type: 'POST',
                        success: function () {
                            defaultAjax({
                                url: imageUrl,
                                data: data3,
                                cache: false,
                                contentType: false,
                                processData: false,
                                type: 'POST',
                                success: function (message) {
                                    console.log(message);
                                    var tp = new takePicture();
                                    $('#uploadImage').unloading();
                                    $('#uploadImage').hide();
                                    $('.tp-container, #msg').hide();
                                    $("#frmDocumentsContainer, #frmDocuments, #docSection").fadeIn();
                                    $("html, body").animate({scrollTop: $("#frmDocumentsContainer").offset().top}, 1000);
                                }
                            });
                        }
                    });
                }
            });

        }
        /*]]>*/
    </script>
</head>
<body>

<th:block layout:fragment="header">
    <th:block th:replace="fragments/headers :: loanOfferHeader"></th:block>
</th:block>

<th:block layout:fragment="content">
    <div id="aff-template-pages-private">
        <div class="container" id="loanOffer">

            <div id="offersContainer">
                <div class="main-container">
                    <div id="offerTittleContainer">
                        <h2 style="display: none;" class="title-steps"
                            th:utext="${loanApplication?.product?.id == T(com.affirm.common.model.catalog.Product).SHORT_TERM ? 'Este es el cr&eacute;dito que tenemos para ti' : 'Selecciona el cr&eacute;dito que mejor se acomoda a tus necesidades'}"></h2>
                        <div style="min-height: 600px;margin-top: 25%;" id="loadingoffer">
                            <div class="gif-solven-container">
                                <div class="sk-cube-grid">
                                    <div class="sk-cube sk-cube1"></div>
                                    <div class="sk-cube sk-cube2"></div>
                                    <div class="sk-cube sk-cube3"></div>
                                    <div class="sk-cube sk-cube4"></div>
                                    <div class="sk-cube sk-cube5"></div>
                                    <div class="sk-cube sk-cube6"></div>
                                    <div class="sk-cube sk-cube7"></div>
                                    <div class="sk-cube sk-cube8"></div>
                                    <div class="sk-cube sk-cube9"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="offer-container" th:if="${offers != null}">
                        <div th:each="offer: ${offers}" class="c-4" id="aff-offer-pricing">
                            <div class="offer-box offer-panel"
                                 th:classappend="${offer.loanOfferOrder % 3 == 0? 'box-lightblue':(offer.loanOfferOrder % 3 == 1? 'box-yellow' :(offer.loanOfferOrder % 3 == 2? 'box-red':''))}"
                                 th:attr="data_offer=${offer.id},data_selected=${offer.loanOfferOrder}">
                                <div class="top">
                                    <div class="topFeature">
                                        <h3 th:text="${offer.loanOfferOrder % 3 == 0? '+ Plazo':(offer.loanOfferOrder % 3 == 1? '= Similar' :(offer.loanOfferOrder % 3 == 2? '+ Dinero':''))}"></h3>
                                        <!-- <span class="smallText">Cr&eacute;dito para uso personal</span> -->
                                        <div th:switch="${offer.loanOfferOrder}">
                                            <h5 th:case="2" th:text="#{loanOffer.offer2}"></h5>
                                            <h5 th:case="3" th:text="#{loanOffer.offer3}"></h5>
                                            <h5 th:case="*" th:text="#{loanOffer.offer1}"></h5>
                                        </div>
                                    </div>
                                    <div class="amountPrice"
                                         th:classappend="${offer.loanOfferOrder % 3 == 0? 'text-lightblue':(offer.loanOfferOrder % 3 == 1? 'text-yellow' :(offer.loanOfferOrder % 3 == 2? 'text-red':''))}">
                                        <span class="subPrefix">S/.</span>
                                        <h2 th:text="${@utilService.integerOnlyMoney(offer?.ammount)}"></h2>
                                    </div>
                                    <div class="featuredIcon"
                                         th:classappend="${offer.loanOfferOrder % 3 == 0? 'bg-lightblue':(offer.loanOfferOrder % 3 == 1? 'bg-yellow' :(offer.loanOfferOrder % 3 == 2? 'bg-red':''))}">
                                        <i class="icon best-icon"
                                           th:classappend="${offer.loanOfferOrder % 3 == 0? 'best-icon':(offer.loanOfferOrder % 3 == 1? 'trophy-icon' :(offer.loanOfferOrder % 3 == 2? 'diamond-icon':''))}"></i>
                                    </div>
                                </div>
                                <div class="bottom">
                                    <ul>
                                        <li>
                                            <span th:text="${offer.installments} + ' '+${offer.installments != 1 ? loanApplication?.product.paymentType.pluralName : loanApplication?.product.paymentType.singularName}+' -'"></span>
                                            <span th:text="${@utilService.doubleMoneyFormat(offer?.installmentAmountAvg)} + ' /'+${loanApplication?.product.paymentType.singularName}"></span>
                                        </li>
                                        <li th:if="false">
                                            <p th:text="#{form.field.commission} + ' ' + ${@utilService.doubleMoneyFormat(offer?.loanCommission)}"></p>
                                        </li>
                                        <li>
                                            <span th:text="'TEA ' + ${@utilService.percentFormat(offer.effectiveAnualRate)}"></span>&nbsp;&nbsp;
                                            <span th:text="'TCEA ' + ${@utilService.percentFormat(offer.effectiveAnnualCostRate)}"></span>
                                        </li>
                                    </ul>
                                    <div class="action">
                                        <a class="anchorButton"
                                           th:classappend="${offer.loanOfferOrder % 3 == 0? 'bg-lightblue':(offer.loanOfferOrder % 3 == 1? 'bg-yellow' :(offer.loanOfferOrder % 3 == 2? 'bg-red':''))}"
                                           id="showOfferScheduleLink"
                                           th:attr="data-target='#offerScheduleModal' + ${offer?.loanOfferOrder}">
                                            <i class="icon table-icon"></i><span>Ver cronograma</span>
                                        </a>
                                    </div>
                                    <div class="company-info">
                                        <small>Financiado por</small>
                                        <img th:src="${offer.entity.logoUrl}" th:alt="${offer.entity.fullName}" th:title="${offer.entity.fullName}"/>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-body">

                                    <div th:id="'offerScheduleModal' + ${offer?.loanOfferOrder}" class="modal fade"
                                         tabindex='-1'>
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-lightblue-header" style="padding: 1.3em">
                                                    <button type="button" class="closeRoundButton"
                                                            data-dismiss="modal" style="top: 1.3em;"><i
                                                            class="icon close-icon"></i>
                                                    </button>
                                                    <h4>Cronograma de pagos preliminar</h4>
                                                </div>
                                                <div class="modal-body">

                                                    <th:block th:if="${offer != null}" layout:fragment="modalSchedule">
                                                        <th:block th:replace="fragments/modalScheduleFragment :: modalSchedule(laoanApplication=${loanAppplication}, offer=${offer}, person=${person})"></th:block>
                                                    </th:block>

                                                </div>
                                                <div class="actions" style="padding: 0 1.5em 1.5em 0">
                                                    <button type="button" class="button red-button">
                                                        Aceptar Oferta
                                                    </button>
                                                    <button type="button" class="button black-button"
                                                            data-dismiss="modal">
                                                        Volver
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="documentBlock">
                <div class="widget-tp">
                    <div class="top">
                        <h3>Ay&uacute;danos a verificar tu identidad.</h3>
                        <small>(tomando las fotos paso a paso)</small>
                    </div>
                    <div class="tp-container" th:if="${frontDniFile == null}">
                        <div class="tp-app">

                            <div class="focus-t"></div>
                            <div class="focus-b"></div>

                            <button id="start-camera" class="visible button lightblue-button">Activa tu c&aacute;mara</button>

                            <video id="camera-stream"></video>

                            <img id="snap"/>

                            <p id="error-message"></p>

                            <div class="controls">
                                <!--<a href="#" id="delete-photo" title="Volver a tomarla" class="disabled"><i class="material-icons">delete</i></a>-->
                                <a href="#" id="take-photo" title="Tomar la foto"><i class="material-icons">camera_alt</i></a>
                                <!--<a href="#" id="download-photo" download="selfie.png" title="Save Photo" class="disabled"><i class="material-icons">file_download</i></a>-->
                                <!--<a href="#" id="save-photo" title="Listo" class="disabled"><i class="material-icons"><i class="material-icons">done</i></i></a>-->
                            </div>
                            <!-- Hidden canvas element. Used for taking snapshot of video. -->
                            <canvas></canvas>
                        </div>
                    </div>
                    <div class="steps-tp">
                        <small id="msg" class="successMessage" th:if="${frontDniFile == null}">Toma una foto del frente de tu documento.</small>
                        <br/>
                        <br/>
                        <ul class="row">
                            <li class="col-lg-4 col-md-4 column">
                                <div class="thumb">
                                    <button type="button" id="close_1" class="closeRoundButtonThumb" data-id="0"><i
                                            class="icon close-icon"></i></button>
                                    <img id="thumb_1" th:if="${frontDniFile !=null}" th:src="@{/__${productUrl}__/__${loanAplicationToken}__/userFile/__${@fileService.generateUserFileEncrypt(frontDniFile.userId, frontDniFile.fileName, frontDniFile.id)}__/image.jpg(thumbnail=true)}"/>
                                    <img id="thumb_1" th:if="${frontDniFile == null}" />
                                </div>
                                <div id="step-1" class="square" th:classappend="${frontDniFile != null ? 'active' : 'disabled'}">
                                    <div class="loading loading-ajax-invisible">
                                        <div class="sk-circle">
                                            <div class="sk-circle1 sk-child"></div>
                                            <div class="sk-circle2 sk-child"></div>
                                            <div class="sk-circle3 sk-child"></div>
                                            <div class="sk-circle4 sk-child"></div>
                                            <div class="sk-circle5 sk-child"></div>
                                            <div class="sk-circle6 sk-child"></div>
                                            <div class="sk-circle7 sk-child"></div>
                                            <div class="sk-circle8 sk-child"></div>
                                        </div>
                                        <span
                                            class="loading-text">Cargando<span>.</span><span>.</span><span>.</span></span>
                                    </div>
                                    <p>Documento (frente)</p>
                                </div>
                                <div class="tp-mobile">
                                    <label for="step-input-1" class="upload-file active-upload" th:if="${frontDniFile == null}">
                                        Haz click para tomar una foto de tu documento (frontal)
                                        <input type="file" accept="image/*" capture="camera" id="step-input-1" class="imageFromMobile" data-step="1"/>
                                    </label>
                                </div>
                            </li>
                            <li class="col-lg-4 col-md-4 column">
                                <div class="thumb">
                                    <button type="button" id="close_2" class="closeRoundButtonThumb" data-id="1"><i
                                            class="icon close-icon"></i></button>
                                    <img id="thumb_2" th:if="${backDniFile != null}" th:src="@{/__${productUrl}__/__${loanAplicationToken}__/userFile/__${@fileService.generateUserFileEncrypt(backDniFile.userId, backDniFile.fileName, backDniFile.id)}__/image.jpg(thumbnail=true)}"/>
                                    <img id="thumb_2" th:if="${backDniFile == null}"/>
                                </div>
                                <div id="step-2" class="square" th:classappend="${backDniFile != null ? 'active' : 'disabled'}">
                                    <div class="loading loading-ajax-invisible">
                                        <div class="sk-circle">
                                            <div class="sk-circle1 sk-child"></div>
                                            <div class="sk-circle2 sk-child"></div>
                                            <div class="sk-circle3 sk-child"></div>
                                            <div class="sk-circle4 sk-child"></div>
                                            <div class="sk-circle5 sk-child"></div>
                                            <div class="sk-circle6 sk-child"></div>
                                            <div class="sk-circle7 sk-child"></div>
                                            <div class="sk-circle8 sk-child"></div>
                                        </div>
                                        <span
                                            class="loading-text">Cargando<span>.</span><span>.</span><span>.</span></span>
                                    </div>
                                    <p>Documento (dorso)</p>
                                </div>
                                <div class="tp-mobile">
                                    <label for="step-input-2" class="upload-file" th:if="${backDniFile == null}">
                                        Haz click para tomar una foto de tu documento (dorso)
                                        <input type="file" accept="image/*" capture="camera" id="step-input-2" class="imageFromMobile" data-step="2"/>
                                    </label>
                                </div>
                            </li>
                            <li class="col-lg-4 col-md-4 column">
                                <div class="thumb">
                                    <button type="button" id="close_3" class="closeRoundButtonThumb" data-id="2"><i
                                            class="icon close-icon"></i></button>
                                    <img id="thumb_3" th:if="${selfieFile != null}" th:src="@{/__${productUrl}__/__${loanAplicationToken}__/userFile/__${@fileService.generateUserFileEncrypt(selfieFile.userId, selfieFile.fileName, selfieFile.id)}__/image.jpg(thumbnail=true)}"/>
                                    <img id="thumb_3" th:if="${selfieFile == null}"/>
                                </div>
                                <div id="step-3" class="square" th:classappend="${selfieFile != null ? 'active' : 'disabled'}">
                                    <div class="loading loading-ajax-invisible">
                                        <div class="sk-circle">
                                            <div class="sk-circle1 sk-child"></div>
                                            <div class="sk-circle2 sk-child"></div>
                                            <div class="sk-circle3 sk-child"></div>
                                            <div class="sk-circle4 sk-child"></div>
                                            <div class="sk-circle5 sk-child"></div>
                                            <div class="sk-circle6 sk-child"></div>
                                            <div class="sk-circle7 sk-child"></div>
                                            <div class="sk-circle8 sk-child"></div>
                                        </div>
                                        <span
                                            class="loading-text">Cargando<span>.</span><span>.</span><span>.</span></span>
                                    </div>
                                    <p>Selfie</p>
                                </div>
                                <div class="tp-mobile">
                                    <label for="step-input-3" class="upload-file" th:if="${selfieFile == null}">
                                        Haz click para tomarte una selfie
                                        <input type="file" accept="image/*" capture="camera" id="step-input-3" class="imageFromMobile" data-step="3"/>
                                    </label>
                                </div>
                            </li>
                        </ul>
                        <div class="actions">
                            <button class="button red-button" id="uploadImage" style="display: none;">Subir</button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="row" id="frmDocumentsContainer" style="display: none">
                <div class="well">

                    <!--<div th:if="${icarValidation == null}" >-->
                    <div id="icarIsActive" th:if="false">
                        <!-- BEGIN ID_Cloud Widget -->
                        <div class="icar-header dynamicColor" id="icarTop">
                            <h3>Ay&uacute;danos a verificar tu identidad</h3>
                        </div>
                        <div>
                            <link rel="stylesheet" type="text/css"
                                  href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,300italic,400italic,600,600italic,700,700italic&amp;subset=latin,latin-ext"/>
                            <link rel="stylesheet" type="text/css"
                                  href="https://idcloudwidget.icarvision.com/css/icar-icos.css"/>
                            <link rel="stylesheet" type="text/css"
                                  href="https://idcloudwidget.icarvision.com/css/styles.css"/>
                             <!--BEGIN Custom Widget CSS Part 1/2 -->
                            <link rel="stylesheet" type="text/css"
                                  href="https://s3-us-west-2.amazonaws.com/icar-css/icar.css"/>
                            <!-- END Custom Widget CSS Part 1/2 -->
                            <div id="iCar-body">
                                <div class="icar-container">
                                    <div class="icar-row">
                                        <div class="icar-col">
                                            <figure class="icar-pic icar-ini-pic">
                                                <i class="icon-icar-ini"></i>
                                                <i class="icon-icar-tick"></i>
                                            </figure>
                                        </div>
                                    </div>
                                    <div class="icar-row icar-btn-row" style="margin-top: 0;">
                                        <p class="icar-align-center">
                                            <a href="javascript:;" title="" class="icar-btn"
                                               id="submit-button">Empezar</a>
                                        </p>
                                        <form action="/admin/clients/view/1" id="ConnectionOpenForm" method="post"
                                              accept-charset="utf-8" autocomplete="off">
                                            <div style="display:none;">
                                                <input type="hidden" name="_method" value="POST"/>
                                            </div>
                                            <input type="hidden" name="base_url"
                                                   value="https://idcloudwidget.icarvision.com" id="ConnectionBaseUrl"/>
                                            <input type="hidden" name="key"
                                                   th:value="${T(com.affirm.system.configuration.Configuration).ICAR_SECRET_KEY}"
                                                   id="ConnectionKey"/>
                                            <input type="hidden" name="key_id" th:value="'01731'" id="ConnectionKeyId"/>
                                            <!-- BEGIN Widget customization -->
                                            <input type="hidden" name="id_type" value="2" id="ConnectionIdType"/>
                                            <input type="hidden" name="language_id" value="es_ES" id="language_id"/>
                                            <!-- END Widget customization-->
                                            <!-- BEGIN Custom Widget CSS Part 2/2 -->
                                            <input type="hidden" name="custom_css_url"
                                                   value="https://s3-us-west-2.amazonaws.com/icar-css/icar.css"
                                                  id="ConnectionCustomCssUrl"/>
                                            <!-- TODO ICAR VALIDATION -->
                                            <input type="hidden" name="url_async" th:value="${T(com.affirm.system.configuration.Configuration).getClientDomain()} + @{/traditionaloanapplication/__${loanAplicationToken}__/icarvalidation}" id="UrlAsync"/>
                                            <input type="hidden" name="async" value="1" id="Async" />
                                            <!-- END Custom Widget CSS Part 2/2 -->
                                        </form>
                                        <!-- <script type="text/javascript"
                                                 src="https://idcloudwidget.icarvision.com/js/jquery.js"></script>-->
                                        <script type="text/javascript"
                                                src="https://idcloudwidget.icarvision.com/js/widget.js"></script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END ID_Cloud Widget -->

                    <th:block th:replace="fragments/loanOfferFragments :: documentationContainer"></th:block>

                </div>
            </div>

            <div id="updateLoanApplicationModal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-lightblue-header">
                            <button type="button" class="closeRoundButton" data-dismiss="modal" aria-hidden="true"><i
                                    class="icon close-icon"></i></button>
                            <h2 id="header-text" style="display: block;">Actualiza tu solicitud</h2>
                        </div>
                        <div class="loading">
                            <div class="modal-body">
                                <i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>
                                <span> &nbsp;&nbsp;Loading... </span>
                            </div>
                        </div>
                        <div class="content"></div>
                    </div>
                </div>
            </div>

            <div class="modal" id="endDatePicker">
                <div class="modal-dialog calendarModal">
                    <div class="modal-content">
                        <div class="modal-lightblue-header">
                            <button type="button" class="closeRoundButton" data-dismiss="modal" aria-label="Close" style="display: none"><i class="icon close-icon"></i></button>
                            <h2>&iquest;Cu&aacute;ndo quieres pagar la 1era. cuota?</h2>
                        </div>
                        <div class="modal-body">
                            <div class="mobileBlock">
                                <h2 class="modalBody-title">&iquest;Cu&aacute;ndo quieres pagar la 1era. cuota?</h2>
                            </div>
                            <form action="#" role="form" autocomplete="off">
                                <div id="calendar-section" class="calendar-container">
                                    <div id="firstDueDate">
                                        <input type="hidden" id="firstDueDateInput"
                                               class="form-control small-input-number"
                                               placeholder="dd/mm/yyyy"/>
                                    </div>
                                    <div id="response-ajax"></div>
                                    <div class="field">
                                        <button class="button red-button red-button buttonDisabled" id="dateSelect">
                                            <span>Confirmar</span>
                                        </button>
                                    </div>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
                <script th:inline="javascript">
                    /*<![CDATA[*/

                    $('#dateSelect').on('click', function (event) {
                        event.preventDefault();
                        if ($('#firstDueDateInput').val()) {
                            $('#dateSelect').loading();
                            defaultAjax({
                                url: /*[[@{/__${productUrl}__/__${loanAplicationToken}__/offer/recalculate/json}]]*/,
                                type: 'POST',
                                data: {
                                    firstDueDate: $('#firstDueDateInput').val()
                                },
                                success: function (data) {
                                    $('#offersContainer').replaceWith(data);
                                    initializeOffersPanels();
                                    $('#endDatePicker').modal('hide');
                                    $('#dateSelect').unloading();
                                },
                                error: function () {
                                    $('#dateSelect').unloading();
                                    $('#loadingoffer').css({'display': 'none'});
                                }
                            });
                        } else {
                            $('#response-ajax').html('Debe seleccionar la fecha');
                        }
                    });

                    /*]]>*/
                </script>
            </div>

            <th:block th:replace="fragments/loanOfferFragments :: documentationUploadModal"></th:block>

        </div>
    </div>
</th:block>

<th:block layout:fragment="footer">
    <th:block th:replace="fragments/footers :: footerDefault"></th:block>
</th:block>

</body>
</html>