<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="question">
    <th:block th:replace="loanApplication/formQuestions/questionConfig :: config"></th:block>

    <div class="questions-section animated fadeInRight">
        <div class="forms q88" id="date-block">
            <p th:utext="#{questions.88.message}"></p>

            <div class="centrado">
                <div>
                    <div class="field inline">
                        <input id="month" type="text" placeholder="mm" class="input-outline small-input" pattern="[0-9]*"/>
                        <small class="input-help">Mes</small>
                    </div>
                    <div class="field inline">
                        <input id="year" type="text" placeholder="aaaa" class="input-outline small-input" pattern="[0-9]{4}"/>
                        <small class="input-help">A&ntilde;o</small>
                    </div>
                    <div class="field inline">
                        <button id="sendButton" type="button" class="button bg-red" th:text="#{button.next}"></button>
                    </div>
                </div>
                <div>
                    <div class="errorContainer"></div>
                </div>
            </div>

        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var yearFrom = /*[[${yearFrom}]]*/;
        var yearTo = /*[[${yearTo}]]*/;
        var $month = $('#month');
        var $year = $('#year');

        setTimeout(function () {
            $month.focus();
        }, 300);
        $month.forceIntegerOnly(true, 1, 12);
        $year.forceIntegerOnly(true, yearFrom, yearTo);

        $month.keyup(function (event) {
            if ($(this).val().length == 2) {
                $year.focus();
            }
        });

        function showInvalidDate() {
            $('.errorContainer').html('<span class="help-block help-block-error">No es una fecha v&aacute;lida</span>');
            $month.parent().addClass('has-error field-error');
            $month.val('');
            $year.parent().addClass('has-error field-error');
            $year.val('');
        }


        $('#sendButton').click(function () {
            $('.errorContainer').html("");

            var month = $month.val();

            if (month.length < 2) month = "0" + month;

            var date = moment(month + "/" + $year.val(), "MM/YYYY", true);

            if (!date.isValid() || date.get('years') > yearTo || date.get('years') < yearFrom) {
                showInvalidDate();
            } else {
                var actualTime = new Date();
                // Moment and Date get month are zero index
                if (date.get('years') == actualTime.getFullYear() && date.get('month') > actualTime.getMonth()) {
                    showInvalidDate();
                } else {
                    questionFw.ajaxToCurrentQuestionController({
                        button: $('#sendButton'),
                        type: "POST",
                        error: function (xhr, data) {
                            if (data != null) {
                                $('.errorContainer').html('<span class="help-block help-block-error">' + data.message + '</span>');
                            }
                        },
                        data: {
                            activityType: $('input[name=activityType]:checked').val(),
                            startDate: date.format("MM/YYYY")
                        }
                    }, "");
                }
            }
        });
        /*]]>*/

    </script>

</th:block>
</html>