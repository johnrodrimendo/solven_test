<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/extranetTemplate"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&amp;subset=all" rel="stylesheet" type="text/css"/>
    <!-- Bootstrap DatePicker -->
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker-1.9/dist/css/bootstrap-datepicker3.min.css'}" />
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker-1.9/dist/js/bootstrap-datepicker.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker-1.9/dist/locales/bootstrap-datepicker.es.min.js'}"></script>
    <script th:src="@{/js/bo_tablefilter.js}"></script>

    <style>
        .card-sms-text{
            padding-top: 20px; padding-bottom: 20px;text-align:justify
        }
    </style>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var url = /*[[ @{/__${@entityExtranetCommunicationsController.URL}__} ]]*/null;
        var totalCount = [[${totalCount}]];
        var limitPaginator =  [[${limitPaginator}]];

        $(document).on('ready', function () {
            enableTableOptions($("#tableResults"), url+"/list", url+"/count", true, "#downloadTrayReport");
            $("#sendSMSOption").click(function(e){
                e.preventDefault();
                showSendSmsModal();
            })

            setTimeout(function (){
                refreshTable($("#tableResults"))
            },5000)

        });

        function showSendSmsModal(){
            defaultAjax({
                url: /*[[ @{/__${@entityExtranetCommunicationsController.URL}__/preSendSms} ]]*/null,
                type: 'POST',
                data: {
                },
                success: function (data) {
                    if(data != null) data = JSON.parse(data);
                    if(data.countPhones != null) $("#phoneCount").text(data.countPhones);
                    if(data.countUsers != null) $("#userCount").text(data.countUsers);
                    $('#sendSMSModal').modal();
                    $('#sendSMSModal .loading').hide();
                    $('#sendSMSModal .content').show();
                    $('#sendSMSModalButton').click(function () {
                        askSendSMSConfirmation();
                    });
                }
            });
        }

        function askSendSMSConfirmation() {
            swal({
                    title: "&iquest;Est&aacute;s seguro de realizar el envío de SMSs?",
                    text: "No podr&aacute;s revertir el cambio.",
                    type: "warning",
                    html: true,
                    showCancelButton: true,
                    confirmButtonColor: "#36c6d3",
                    cancelButtonText: "Cancelar",
                    confirmButtonText: "Aceptar",
                    closeOnConfirm: true
                },
                function () {
                    $('#sendSMSModalButton').loading('', 2);
                    defaultAjax({
                        url: /*[[ @{/__${@entityExtranetCommunicationsController.URL}__/sendSms} ]]*/null,
                        type: 'POST',
                        data: {},
                        success: function (data) {
                            $('#sendSMSModalButton').unloading();
                            resetCustomTable($("#tableResults"));
                            $('#sendSMSModal').modal('hide');
                        },
                        error: function (data) {
                            $('#sendSMSModalButton').unloading();
                        }
                    })
                });
        }

        /*]]>*/
    </script>

    <th:block th:replace="components/tracking :: social" />

</head>
<body>
<th:block layout:fragment="header">
<!--    <th:block th:replace="fragments/headers :: entityDashboardHeader "></th:block>-->
    <div class="clearfix"></div>
</th:block>
<th:block layout:fragment="content">
    <th:block th:replace="fragments/extranetSidebarFragments :: extranetEntitySidebar(currentPage=${page})"></th:block>
    <div class="page-content-wrapper">
        <div class="page-content">
            <div class="row w-creditos-procesados">
                <th:block th:replace="fragments/headers :: entityContentHeaderCommunication "></th:block>
                <div class="col-xs-12">
                    <div id="creditsTable" class="tablefilter-table table-container">
                        <div class="table-responsive" style="overflow: auto; display: flex; justify-content: center; flex-direction: column">
                            <table id="tableResults" class=" table table-striped table-bordered table-checkable order-column dataTable">
                                <thead>
                                <th:block th:replace="this :: header"></th:block>
                                </thead>
                                <tbody>
                                <th:block th:replace="this :: list"></th:block>
                                </tbody>
                            </table>
                            <th:block th:replace="fragments/footers :: paginatorFooter "></th:block>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sendSMSModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-top">
                    <div class="title-wrap">
                        <h4 class="title-modal">Enviar SMSs</h4>
                    </div>
                    <div class="corner-close">
                        <button class="icon icon-close" data-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div>
                    <div class="col-xs-12 card-sms-text">Se enviará un mensaje SMS a <span id="phoneCount"></span> teléfonos celulares de <span id="userCount"></span> usuarios únicos (se excluyen usuarios que actualmente tenga un compromiso activo en la plataforma</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button id="sendSMSModalButton" type="button" class="btn btn-danger">Enviar</button>
                </div>
            </div>

        </div>
    </div>

</th:block>

<th:block th:fragment="header">
    <tr>
        <th>#</th>
        <th>Registro de Evento </th>
        <th>Finalización de Evento </th>
        <th>Evento </th>
        <th>Estado de envento</th>
        <th>Registros exitosos</th>
        <th>Registros fallidos</th>
    </tr>
</th:block>

<th:block th:fragment="list">
    <th:block th:if="${#lists.isEmpty(data)}">
        <tr>
            <td colspan="15">No hay resultados</td>
        </tr>
    </th:block>
    <th:block th:unless="${#lists.isEmpty(data)}">
        <tr th:each="data, iter : ${data}">
            <td th:text="${iter.count + (offset != null ? offset : 0)}"></td>
            <td th:text="${@utilService.datetimeShortFormat(data?.registerDate)}"></td>
            <td th:text="${@utilService.datetimeShortFormat(data?.finishDate)}"></td>
            <td th:text="${data?.getEventName()}"></td>
            <td>
                <th:block th:switch="${data?.status}">
                    <th:block th:case="${T(com.affirm.common.model.transactional.GatewayBaseEvent).STATUS_PENDING}"><span class="label label-xs label-warning">En proceso</span></th:block>
                    <th:block th:case="${T(com.affirm.common.model.transactional.GatewayBaseEvent).STATUS_FAILED}"><span class="label label-xs label-danger">Fallido</span></th:block>
                    <th:block th:case="${T(com.affirm.common.model.transactional.GatewayBaseEvent).STATUS_SUCCESS}"><span class="label label-xs label-success">Completo</span></th:block>
                </th:block>
            </td>
            <td th:text="${data?.successCount}"></td>
            <td th:text="${data?.failedCount}"></td>
        </tr>
        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>
</th:block>


</body>
</html>