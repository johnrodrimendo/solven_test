<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:fragment="detailLoanResources">
    <script>
        const editableInputFn = function editableInput(configuration){
            let element = this;
            let fnAfterApply = async function (...args){
                console.log("Apply value",args);
            }
            let paramsToCall = [];
            let sendValueParam = true;
            if(configuration){
                if(configuration?.fn) fnAfterApply = configuration.fn;
                if(configuration?.params) paramsToCall = configuration.params;
                if(configuration.hasOwnProperty("sendValueParam")) sendValueParam = configuration?.sendValueParam;
            }
            if((element.is("input") || element.is("select"))){
                if(!element.prop('disabled')){
                    $(`<span class="editable-input" style="color: #999da4;font-size: 11px !important;">Editar</span>`).insertAfter(this);
                    let value = element.val();
                    let templateToInsertOnEdit = `
                    <span class="editable-input-action-group" style="display: none">
                        <i class="fa fa-check apply-editing save" aria-hidden="true"></i>
                        <i class="fa fa-times-circle-o cancel-editing cancel" aria-hidden="true"></i>
                    </span>
                `
                    if(element.is("input")){
                        element.parent().append(templateToInsertOnEdit);
                        element.on('input', function(e){
                            let closestElementSpan = element.parent().find(".editable-input");
                            closestElementSpan.text("Editando");
                            if(!closestElementSpan.hasClass("editable-input-custom-color")) closestElementSpan.addClass("editable-input-custom-color");
                            if(!element.parent().hasClass("editing-input")) {
                                element.parent().addClass("editing-input");
                            }
                        })

                        element.parent().find(".editable-input-action-group .cancel-editing").click(function(e){
                            let currentTarget = $(e.currentTarget);
                            let parentElement = currentTarget.parent().parent();
                            parentElement.find("input").val(value || null);
                            parentElement.removeClass("editable-input");
                            parentElement.find("input").parent().removeClass("error");
                            parentElement
                                .find(".editable-input")
                                .text("Editar").removeClass("editable-input-custom-color");
                            parentElement.removeClass("editing-input");
                        })

                        element.parent().find(".editable-input-action-group .apply-editing").click(async function(e){
                            let currentTarget = $(e.currentTarget);
                            let parentElement = currentTarget.parent().parent();
                            try {
                                if(value != parentElement.find("input").val()){
                                    if(sendValueParam) await fnAfterApply(parentElement.find("input").val(), ...paramsToCall);
                                    else await fnAfterApply(...paramsToCall);
                                }
                                parentElement.removeClass("editable-input");
                                parentElement.find("input").parent().removeClass("error");
                                value = parentElement.find("input").val();
                                parentElement
                                    .find(".editable-input")
                                    .text("Editar").removeClass("editable-input-custom-color");
                                parentElement.removeClass("editing-input");
                                openSuccessProcessNotification(null, 2000);
                            }
                            catch (error){
                                console.log(error);
                                if(error) parentElement.find("input").parent().addClass("error");
                                else{
                                    parentElement.find("input").val(value || null);
                                    parentElement
                                        .find(".editable-input")
                                        .text("Editar").removeClass("editable-input-custom-color");
                                    parentElement.removeClass("editing-input");
                                }
                            }
                        })
                    }
                    if(element.is("select")){
                        element.focus(function (e){
                            let closestElementSpan = element.parent().find(".editable-input");
                            closestElementSpan.text("Editando");
                            if(!closestElementSpan.hasClass("editable-input-custom-color")) closestElementSpan.addClass("editable-input-custom-color");
                            if(!element.parent().hasClass("editing-input")) {
                                element.parent().addClass("editing-input");
                            }
                        })
                        element.blur(function (e){
                            let currentTarget = $(e.currentTarget);
                            let parentElement = currentTarget.parent().parent();
                            parentElement.removeClass("editable-input");
                            parentElement
                                .find(".editable-input")
                                .text("Editar").removeClass("editable-input-custom-color");
                            parentElement.removeClass("editing-input");
                        })
                        element.change(function(e){
                            let currentTarget = $(e.currentTarget);
                            let parentElement = currentTarget.parent().parent();
                            parentElement.removeClass("editable-input");
                            if(value != parentElement.find("select").val()){
                                try{
                                    if(sendValueParam) fnAfterApply(parentElement.find("select").val(), ...paramsToCall)
                                    else fnAfterApply(...paramsToCall)
                                    value = parentElement.find("select").val();
                                }
                                catch(error){
                                    parentElement.find("select").parent().addClass("error");
                                }
                            }
                            parentElement
                                .find(".editable-input")
                                .text("Editar").removeClass("editable-input-custom-color");
                            parentElement.removeClass("editing-input");

                        })
                    }
                }
            }
            return {
                params : paramsToCall,
                fn : fnAfterApply,
                sendValueParam : sendValueParam
            }
        }
        jQuery.fn.extend({
            editableInputFn : editableInputFn
        })
    </script>

    <style>
        .d-none-element{
            display: none;
        }

        .object-fit-contain{
            object-fit: contain;
        }

        .editing-input {
            position: relative;
        }
        .editing-input > input {
            padding-right: 32px;
        }

        .editing-input .editable-input-action-group{
            display: block !important;
            position: absolute;
            right: 0;
            top: 0;
        }
    </style>

    <style>

        svg.custom_icono_success path{
            stroke: #33b145 !important;
        }

        svg.custom_icono_alert path{
            stroke: #b2292e !important;
        }

        .editable-input-action-group > i{
            cursor: pointer;
            border: 1px solid #dddfdf;
            border-radius: 2px;
            padding: 1px;
            box-shadow: 1px 1px 4px 0px rgba(206, 203, 203, 0.82);
            background-color: transparent;
            min-width: 17px;
            text-align: center;
        }

        .editable-input-action-group > i:hover {
            transform: scale(1.2);
        }

        .editable-input-action-group > i.save{
            border-color: #96d29d;
            color: #96d29d;
        }

        .editable-input-action-group > i.cancel{
            border-color: #c68585;
            color: #c68585;
        }

        .tr-collased-table > td{
            background: linear-gradient(0deg, #d6d7d6 0%, rgb(255, 255, 255) 15%, rgb(255, 255, 255) 84%, #d6d7d6 100%);
        }

        .img-response-custom{
            object-fit: contain;
            background: #A2AAAD;
        }

    </style>

    <script th:inline="javascript">
        /*<![CDATA[*/
        let urlBaseEvaluation = /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/}]]*/null;
        var tray = /*[[${tray}]]*/null;
        function gtag_report_conversion(id, url) {
            dataLayer.push({
                'event': 'conversion',
                'transaction_id': id+''
            });
            return false;
        }

        $(document).ready(function () {
            expandableTableInit();
            enableSelect();
            $("#jquery_jplayer_2").jPlayer({
                ready: function () {
                    $(this).jPlayer("setMedia", {
                        wav: 'https://solven-public.s3.amazonaws.com/test.mp3'
                    });
                },
                swfPath: '/js',
                solution: 'html, flash',
                supplied: "mp3, oga, wav",
                preload: 'metadata',
                volume: 0.8,
                muted: false,
                backgroundColor: '#000000',
                cssSelectorAncestor: '#jp_container_2',
                cssSelector: {
                    videoPlay: '.jp-video-play',
                    play: '.jp-play',
                    pause: '.jp-pause',
                    stop: '.jp-stop',
                    seekBar: '.jp-seek-bar',
                    playBar: '.jp-play-bar',
                    mute: '.jp-mute',
                    unmute: '.jp-unmute',
                    volumeBar: '.jp-volume-bar',
                    volumeBarValue: '.jp-volume-bar-value',
                    volumeMax: '.jp-volume-max',
                    playbackRateBar: '.jp-playback-rate-bar',
                    playbackRateBarValue: '.jp-playback-rate-bar-value',
                    currentTime: '.jp-current-time',
                    duration: '.jp-duration',
                    title: '.jp-title',
                    fullScreen: '.jp-full-screen',
                    restoreScreen: '.jp-restore-screen',
                    repeat: '.jp-repeat',
                    repeatOff: '.jp-repeat-off',
                    gui: '.jp-gui',
                    noSolution: '.jp-no-solution'
                },
                errorAlerts: false,
                warningAlerts: false
            });

            $("select.change-analyst").on("changed.bs.select",
                function(e, clickedIndex, newValue, oldValue) {
                    let loanApplicationId = $(e.target).attr("id").replaceAll("analyst_", "");
                    if(this.value) assignAnalyst(loanApplicationId,this.value);
                    else unassignAnalyst(loanApplicationId);
                });
        });

        function expandableTableInit(){
            // $(".collapse-table").click(function(e){
            //     let applicationId = null;
            //     $(".tr-collased-table").remove();
            //     $(".collapsed-table").text("+");
            //     if(!$(e.currentTarget).hasClass("collapsed-table")){
            //         $(".collapsed-table").removeClass("collapsed-table");
            //         let parentElement = $(e.currentTarget).parent().parent();
            //         $('<tr class="tr-collased-table"><td colspan="11">' +
            //             '<div class="spinner-border  loading-color-circle" role="status">\n'+
            //             '  <span class="visually-hidden">Loading...</span>\n' +
            //             '</div> Cargando información</td></tr>').insertAfter(parentElement);
            //         $(e.currentTarget).addClass("collapsed-table");
            //         $(e.currentTarget).text("-");
            //     }
            //     else {
            //         $(e.currentTarget).removeClass("collapsed-table");
            //         $(e.currentTarget).text("+");
            //     }
            // })
        }

        function enableSelect(){
            $('.selectpicker').selectpicker();
        }

        function assignAnalyst(loanApplicationId, entityUserId){
            defaultAjax({
                url: urlBaseEvaluation+"action/assignAnalyst",
                type: 'POST',
                data: {
                    loanApplicationId,
                    entityUserId
                },
                success: function (data) {
                    openSuccessProcessNotification(null,null);
                },
                error: function(){

                }
            });
        }

        function unassignAnalyst(loanApplicationId){
            defaultAjax({
                url: urlBaseEvaluation+"action/unassignAnalyst",
                type: 'POST',
                data: {
                    loanApplicationId
                },
                success: function (data) {
                    openSuccessProcessNotification(null,null);
                },
                error: function(){

                }
            });
        }

        async function getLoanDetail(loanApplicationId){
            if(!loanApplicationId) return;
            $(".tr-collased-table").remove();
            $(".collapsed-table").text("+");

            let trRow = $("tr#loan_"+loanApplicationId);
            let buttonClicked = $(`tr#loan_${loanApplicationId} button.collapse-table`);

            if(!buttonClicked.hasClass("collapsed-table")){
                $(".collapsed-table").removeClass("collapsed-table");
                $('<tr class="tr-collased-table" id="loan_detail_'+loanApplicationId+'"><td colspan="20">' +
                    '<div class="spinner-border  loading-color-circle" role="status" style="margin-right: 5px">\n'+
                    '  <span class="visually-hidden">Loading...</span>\n' +
                    '</div> Cargando información</td></tr>').insertAfter(trRow);
                buttonClicked.addClass("collapsed-table");
                buttonClicked.text("-");
            }
            else {
                buttonClicked.removeClass("collapsed-table");
                buttonClicked.text("+");
                return;
            }

            defaultAjax({
                url: urlBaseEvaluation+loanApplicationId,
                type: 'GET',
                data: {
                    tray
                },
                success: function (data) {
                    $(`tr#loan_detail_${loanApplicationId} td`).html(data);
                },
                error: function(){

                }
            });
        }

        async function getSummaryData(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapseSummary.panel-collapse[aria-expanded="true"]`).length) return;
            defaultAjax({
                url: urlBaseEvaluation+"summary/"+loanApplicationId,
                type: 'GET',
                data: {
                    tray
                },
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapseSummary > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        async function getApplicantData(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapseApplicant.panel-collapse[aria-expanded="true"]`).length) return;
            $(`#loan_detail_${loanApplicationId} #collapseApplicant > .panel-body`).html('<div class="d-flex"><div class="spinner-border  loading-color-circle" role="status" style="margin-right: 5px"><span class="visually-hidden">Loading...</span></div> Cargando información</div>');
            defaultAjax({
                url: urlBaseEvaluation+"applicant/"+loanApplicationId,
                type: 'GET',
                data: {tray},
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapseApplicant > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        async function getIncomesData(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapseIncomes.panel-collapse[aria-expanded="true"]`).length) return;
            defaultAjax({
                url: urlBaseEvaluation+"incomes/"+loanApplicationId,
                type: 'GET',
                data: {tray},
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapseIncomes > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        async function executeAction(loanApplicationId, action){
            let additionalDataToSend = {};
            switch (action){
                case "reject":
                    if(!$('#frmRegisterApplicationRejectionModal').valid()) return;
                    additionalDataToSend = $("#frmRegisterApplicationRejectionModal").serializeObject();
                    break;
            }
            $("#loading-screen-transparent").show();
            defaultAjax({
                url: urlBaseEvaluation+"action/"+action,
                type: 'POST',
                data: Object.assign(additionalDataToSend, {
                    loanApplicationId : loanApplicationId
                }),
                success: function (data) {
                    $("#loading-screen-transparent").hide();
                    if(action == 'approve' ){
                        swal({
                            title: data,
                            html: true,
                            type: "success"
                        });
                        $("div.sweet-alert button.confirm").click(function (e){
                            location.reload();
                        })
                    }
                    else if(action == 'returnToContract'){
                        location.reload();
                    }else if(action == 'reject'){
                        $("#registerApplicationRejectionModal").modal('hide');
                        location.reload();
                    }
                    else if(action == "validateamount"){
                        getSummaryData(loanApplicationId);
                    }
                    else {
                        getSummaryData(loanApplicationId);
                        openSuccessProcessNotification(null,null);
                        if(action == "resend_validation_email"){
                            getApplicantData(loanApplicationId);
                        }
                    }
                },
                error: function(error){
                    $("#loading-screen-transparent").hide();
                    if (error.status == 503 || error.status == 504) {
                        showErrorModal('El proceso está tardando más de lo esperado. Por favor, vuelve a intentarlo en 30 segundos.');
                        $("div.sweet-alert button.confirm").click(function (e){
                            location.reload();
                        })
                        return false;
                    }
                }
            });
        }

        function openSuccessProcessNotification(msg, time){
            swal({
                title: msg || "¡Operación exitosa!",
                timer: time || 3000,
                type: "success"
            });
        }

        function delayTime(){
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve();
                }, 1000);
            });
        }

        function updatePersonAddress(type,loanId, personId) {
            defaultAjax({
                url: urlBaseEvaluation+ 'update/address',
                type: 'POST',
                formValidation: $(`#modal_address_${type} #frmUpdatePersonAddressModal`).data('validator'),
                data: $(`#modal_address_${type} #frmUpdatePersonAddressModal`).serialize() + "&personId=" + personId,
                success: function (data) {
                    $(`#modal_address_${type}`).modal('hide');
                    if(type == "work") {
                        getIncomesData(loanId);
                        openSuccessProcessNotification(null,null);
                    }
                    else{
                        getAddressVerificationData(loanId);
                        getApplicantData(loanId);
                        openSuccessProcessNotification(null,null);
                    }
                }
            })
        }

        async function getRequestData(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapseRequest.panel-collapse[aria-expanded="true"]`).length) return;
            defaultAjax({
                url: urlBaseEvaluation+"request/"+loanApplicationId,
                type: 'GET',
                data: {},
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapseRequest > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        async function getPhoneVerificationData(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapsePhoneVerification.panel-collapse[aria-expanded="true"]`).length) return;
            defaultAjax({
                url: urlBaseEvaluation+"phone_verification/"+loanApplicationId,
                type: 'GET',
                data: {tray},
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapsePhoneVerification > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        async function getAddressVerificationData(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapseAddressVerification.panel-collapse[aria-expanded="true"]`).length) return;
            defaultAjax({
                url: urlBaseEvaluation+"address_verification/"+loanApplicationId,
                type: 'GET',
                data: {tray},
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapseAddressVerification > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        async function getRequestTabData(loanApplicationId, tab){
            $(`#loan_detail_${loanApplicationId} #tabPanelContainer`).html('<div class="d-flex"><div class="spinner-border  loading-color-circle" role="status" style="margin-right: 5px"><span class="visually-hidden">Loading...</span></div> Cargando información</div>');
            defaultAjax({
                url: urlBaseEvaluation+"request/"+loanApplicationId+"/tab/"+tab,
                type: 'GET',
                data: {
                    tray
                },
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #tabPanelContainer`).html(data);
                },
                error: function(){

                }
            });
        }

        // function rotateImage(selector){
        //     let angle = +$(`${selector}`).data('angle') + 90;
        //     $(`${selector}`)
        //         .css({'transform': `rotate(${angle}deg)`})
        //         .data('angle', angle)
        // }

        function validateUserFile(userFileId, validated) {
            var baseUrl = /*[[@{/file/userFile/}]]*/null;
            defaultAjax({
                url: baseUrl + userFileId + '/validate',
                type: 'POST',
                data: {
                    validated: validated
                },
                success: function (data) {
                    var fileUserContainer = $('#container_' + userFileId);
                    if (validated) {
                        // Add style to image
                        fileUserContainer.find(".img-responsive").css('border', '2px solid #26C281');
                        openSuccessProcessNotification(null,null);
                    } else {
                        // Move container to deletedFiles
                        fileUserContainer.html('No se ha subido ningún archivo.');
                        openSuccessProcessNotification(null,null);
                    }
                }
            })
        }

        function downloadUserFile(fileId, fileName) {
            var src = $(fileId).attr('src');
            var origin = window.location.origin;

            var href = origin + src;

            href = href.substr(0, href.indexOf('?thumbnail=false'));

            var a = $("<a>")
                .attr("href", href)
                .attr("download", fileName)
                .appendTo("body");

            a[0].click();
            a.remove();
        }

        function downloadUserFileDoc(url, fileName) {

            var a = $("<a>")
                .attr("href", url)
                .attr("download", fileName)
                .attr("target","_blank")
                .appendTo("body");

            a[0].click();
            a.remove();
        }

        function invalidateUserFile(userFileId, validated, loanApplicationId) {
            if (!validated) {
                //action for dismiss documentation appear //style="display:none;"
                console.log('Invalidando documento');
                // $('#markDocumentMissingAction').attr('style', 'display:true');
                markDocumentsMissing(loanApplicationId, false);
            }
            validateUserFile(userFileId, validated);
        }

        function markDocumentsMissing(loanApplicationId, refreshTab) {
            defaultAjax({
                url: /*[[@{/file/assign/documentsMissingFlag}]]*/null,
                type: 'POST',
                data: {
                    loanApplicationId: loanApplicationId
                },
                success: function (data) {
                    // Refresh the applications tab
                    if (refreshTab) {
                        refreshMissingDocsModal(loanApplicationId);
                    }
                }
            });
        }

        function rotateImage(jsonEncrypt, orientation, elementToClickAfter) {
            var baseUrl = /*[[@{/file/userFile/}]]*/null;
            defaultAjax({
                url: baseUrl + jsonEncrypt + '/rotate/' + orientation,
                type: 'POST',
                data: {},
                success: function (data) {
                    if(elementToClickAfter) $(elementToClickAfter).click();
                }
            })
        }

        function validateAllUserFiles(loanApplicationId,elementToClickAfter) {
            var baseUrl = /*[[@{/file/userFile/all/validate}]]*/null;
            defaultAjax({
                url: baseUrl,
                type: 'POST',
                data: {
                    loanApplicationId: loanApplicationId
                },
                success: function (data) {
                    openSuccessProcessNotification(null,null);
                    if(elementToClickAfter) $(elementToClickAfter).click();
                }
            })
        }

        function requestMissingDocumentation(loanApplicationId, elementToClickAfter) {
            var baseUrl = /*[[@{/file/userFile/requestMissingDocumentation}]]*/null;
            defaultAjax({
                url: baseUrl,
                type: 'POST',
                data: {
                    loanApplicationId: loanApplicationId
                },
                success: function (data) {
                    openSuccessProcessNotification(null,null);
                    if(elementToClickAfter) $(elementToClickAfter).click();
                }
            })
        }

        function loadedImage(element)  {
            $(element).css('display','flex');
        }

        function updateFieldValue(value, loanApplicationId, field) {
            return new Promise((resolve,reject) => {
                defaultAjax({
                    url: urlBaseEvaluation+"update/"+loanApplicationId+"/field/"+field,
                    type: 'POST',
                    data: {
                        loanApplicationId: loanApplicationId,
                        value
                    },
                    success: function (data) {
                        resolve(true)
                    },
                    error:function (data) {
                        reject(false)
                    }
                })
            });
        }

        function updateFieldValueAndExecuteAction(value, loanApplicationId, field, action) {
            return new Promise((resolve,reject) => {
                defaultAjax({
                    url: urlBaseEvaluation+"update/"+loanApplicationId+"/field/"+field,
                    type: 'POST',
                    data: {
                        loanApplicationId: loanApplicationId,
                        value
                    },
                    success: function (data) {
                        if(action){
                            switch (action){
                                case 'auto_approval':
                                    executeAction(loanApplicationId,'approve');
                                    break;
                                case 'refresh_loan':
                                    getLoanDetail(loanApplicationId);
                                    getLoanDetail(loanApplicationId);
                                    break;
                            }
                        }
                        resolve(true)
                    },
                    error:function (data) {
                        reject(false)
                    }
                })
            });
        }

        function updateFieldValuePartner(value, loanApplicationId) {
            return new Promise((resolve,reject) => {

                swal({
                    title: '',
                    text: "Al ingresar Conyuge la solicitud se evaluará nuevamente y requiere firmar el contrato por el solicitante",
                    html: true,
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Confirmar",
                    cancelButtonText: "Cancelar",
                    closeOnConfirm: true // change this for close when click Si
                }, function (confirm) {
                    if (confirm) {
                        defaultAjax({
                            url: urlBaseEvaluation+"update/"+loanApplicationId+"/field/partnerDocument",
                            type: 'POST',
                            data: {
                                loanApplicationId: loanApplicationId,
                                partnerDocumentType: $("#maritalDocumentType").val(),
                                value
                            },
                            success: function (data) {
                                resolve(true)
                                getApplicantData(loanApplicationId);
                            },
                            error:function (data) {
                                reject(true)
                            }
                        })
                    }
                    else reject(false)
                });

            });
        }

        function showOccupationalPhoneNumberModal(personId, loanId) {
            var urlOcucupationalPhoneNumber = /*[[@{/evaluation/job-phone/update/modal}]]*/;
            $('#updateOccupationalPhoneNumberModal').modal();
        }

        function updateOccupationalPhoneNumber(loanApplicationId,personId) {
            defaultAjax({
                url:urlBaseEvaluation+"update/"+loanApplicationId+"/field/workPhone",
                type: 'POST',
                formValidation: $('#frmUpdateOccupationalPhoneNumber').data('validator'),
                data: $('#frmUpdateOccupationalPhoneNumber').serialize() + "&personId=" + personId,
                success: function (data) {
                    $('#updateOccupationalPhoneNumberModal').modal('hide');
                    getIncomesData(loanApplicationId);
                }
            })
        }

        function registerContactResult(loanId, contactResultId, personAnswerCall, contactRelationship, date,referralId) {
            defaultAjax({
                url: urlBaseEvaluation+"loan/"+loanId+"/registerContactResult",
                type: 'POST',
                data: {
                    contactResultId: contactResultId,
                    date: date,
                    // detailReason: detailReason,
                    // assistedProcess: window.assistedProcess,
                    personAnswerCall: personAnswerCall,
                    contactRelationship: contactRelationship,
                    referralId:  referralId
                    // detailReasonComment: detailReasonComment
                },
                success: function (data) {
                    getPhoneVerificationData(loanId);
                    openSuccessProcessNotification(null,null);
                }
            })
        }

        function registerContactResultAddressVerification(loanId, contactResultId, personAnswerCall, contactRelationship, date,referralId) {
            defaultAjax({
                url: urlBaseEvaluation+"loan/"+loanId+"/registerContactResultAddress",
                type: 'POST',
                data: {
                    contactResultId: contactResultId,
                    date: date,
                    personAnswerCall: personAnswerCall,
                    contactRelationship: contactRelationship,
                    referralId:  referralId
                },
                success: function (data) {
                    getAddressVerificationData(loanId);
                    openSuccessProcessNotification(null,null);
                }
            })
        }

        function identityManualApproval(loanId,status, type) {
            swal({
                title: '',
                text:  status ? "¿Estás seguro de aprobar la verificación? <br/> Esta acción no puede modificarse." : "¿Estás seguro de rechazar la verificación? <br/> Esta acción no puede modificarse.",
                html: true,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si",
                cancelButtonText: "No",
                closeOnConfirm: true // change this for close when click Si
            }, function (confirm) {
                if (confirm) {
                    defaultAjax({
                        url: urlBaseEvaluation+"loan/"+loanId+"/identityManualApproval",
                        type: 'POST',
                        data: {
                            loanId: loanId,
                            //processId: processId,
                            status,
                            type
                        },
                        success: function (data) {
                            getRequestTabData(loanId,'identity_validation');
                            getSummaryData(loanId);
                            $(`#loan_${loanApplicationId}`)[0].cells[9].innerHTML = "<span><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14.549\" height=\"10.472\" viewBox=\"0 0 14.549 10.472\" class=\"custom-icono-svg custom_icono_success\"><path id=\"Icon_feather-check\" data-name=\"Icon feather-check\" d=\"M17.72,9,9.663,17.058,6,13.4\" transform=\"translate(-4.586 -7.586)\" fill=\"none\" stroke=\"#005198\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"></path></svg>Verif. identidad</span>";
                            if(status) executeAction(loanApplicationId,'approve');
                        }
                    })
                }
            });
        }


        function registerContactResultCase(loanId, contactResultId, personAnswerCall, contactRelationship, date,referralId, tab) {
            defaultAjax({
                url: urlBaseEvaluation+"loan/"+loanId+"/registerContactResult",
                type: 'POST',
                data: {
                    contactResultId: contactResultId,
                    date: date,
                    personAnswerCall: personAnswerCall,
                    contactRelationship: contactRelationship,
                    referralId:  referralId
                },
                success: function (data) {
                    switch (tab){
                        case 'welcomeCall':
                            getWelcomeCall(loanId);
                    }
                    openSuccessProcessNotification(null,null);
                }
            })
        }

        function rejectLoanApplicationFraudAlert(loanId, loanApplicationFraudAlertIds, element) {
            var row = $(element).closest('tr')

            defaultAjax({
                url: urlBaseEvaluation+"reject/loanApplicationFraudAlert",
                type: 'POST',
                data: {
                    loanApplicationFraudAlertIds: JSON.stringify(loanApplicationFraudAlertIds),
                    loanApplicationId : loanId
                },
                success: function (data) {
                    openSuccessProcessNotification(null,null);
                    row.fadeOut(750,function(){
                        row.remove();
                    });
                }
            })
        }

        function rejectAllLoanApplicationFraudAlerts(loanId, clickElementAfter) {
            swal({
                    title: "",
                    text: "¿Está seguro que desea desestimar todas las alertas?",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "¡Sí, desestimar todas!",
                    cancelButtonText: "Cancelar",
                    closeOnConfirm: false,
                    html: true
                },
                function(){
                    swal.close();
                    defaultAjax({
                        url: urlBaseEvaluation+"reject/allLoanApplicationFraudAlerts",
                        type: 'POST',
                        data: {
                            loanApplicationId: loanId
                        },
                        success: function (data) {
                            openSuccessProcessNotification(null,null);
                            if(clickElementAfter) $(clickElementAfter).click();
                        }
                    });
                });
        }

        async function getWelcomeCall(loanApplicationId){
            await delayTime();
            if(!$(`#loan_detail_${loanApplicationId} #collapseWelcomeCall.panel-collapse[aria-expanded="true"]`).length) return;
            defaultAjax({
                url: urlBaseEvaluation+"welcomeCall/"+loanApplicationId,
                type: 'GET',
                data: {tray},
                success: function (data) {
                    $(`#loan_detail_${loanApplicationId} #collapseWelcomeCall > .panel-body`).html(data);
                },
                error: function(){

                }
            });
        }

        function showCreateLoanOffer(loanApplicationId) {
            let urlCreateLoanOffer = urlBaseEvaluation + 'loanOffer/modal/create/';
            $('#createLoanOfferModal').modal();
            $('#createLoanOfferModal .loading').show();
            $('#createLoanOfferModal .content').hide();
            $('#createLoanOfferModal .content').defaultLoad(urlCreateLoanOffer + "?loanApplicationId=" + loanApplicationId, null, function () {
                $('#createLoanOfferModal .loading').hide(300);
                $('#createLoanOfferModal .content').show(300);
            }, "GET", null, function(){
                $('#createLoanOfferModal').modal('hide');
            });
        }

        function createLoanOffer(loanApplicationId) {
            defaultAjax({
                url:  urlBaseEvaluation + 'loanOffer/create/',
                type: 'POST',
                data: $('#frmCreateLoanOfferModal').serialize(),
                success: function (data) {
                    $('#createLoanOfferModal').modal('hide');
                    getSummaryData(loanId);
                    openSuccessProcessNotification(null,null);
                }
            })
        }

        function selectLoanOffer(loanOfferId, loanApplicationId, page) {
            defaultAjax({
                url: urlBaseEvaluation + 'loanOffer/' + loanOfferId + "/select",
                data: {
                    loanId: loanApplicationId
                },
                type: 'POST',
                success: function (data) {
                    if(page == 'summary') getSummaryData(loanApplicationId);
                    if(page == 'evaluation') getRequestTabData(loanApplicationId, 'evaluation');
                    openSuccessProcessNotification(null,null);
                }
            })
        }

        function notifyLoanOffer(loanOfferId, loanApplicationId, page) {
            defaultAjax({
                url: urlBaseEvaluation + 'loanOffer/' + loanOfferId + "/notify",
                data: {
                    loanId: loanApplicationId
                },
                type: 'POST',
                success: function (data) {
                    if(page == 'summary') getSummaryData(loanApplicationId);
                    if(page == 'evaluation') getRequestTabData(loanApplicationId, 'evaluation');
                    openSuccessProcessNotification("Se ha enviado un correo al email registrado por el cliente",null);
                }
            })
        }

        /*]]>*/
    </script>

</th:block>

<th:block th:fragment="loading">
    <div class="spinner-border  loading-color-circle" role="status">
        <span class="visually-hidden">Loading...</span>
    </div> Cargando información
</th:block>

<th:block th:fragment="detailIcon">
    <th:block th:switch="${approved}">
        <th:block th:case="true">
            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/validar_todos.svg" alt="" class="custom-icono-svg custom_icono_success"/>
        </th:block>
        <th:block th:case="false">
            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/solicitar_documentacion.svg" alt="" class="custom-icono-svg custom_icono_alert"/>
        </th:block>
    </th:block>
</th:block>


<th:block th:fragment="detail">
    <th:block th:replace="this :: summary(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'summary',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'summary')?.visible == true}"></th:block>
    <th:block th:replace="this :: applicant(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'applicant',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'applicant')?.visible == true}" ></th:block>
    <th:block th:replace="this :: incomes(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'incomes',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'incomes')?.visible == true}" ></th:block>
    <th:block th:replace="this :: request(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request')?.visible == true }" ></th:block>
    <th:block th:replace="this :: phoneVerification(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'phoneVerification',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'phoneVerification')?.visible == true}" ></th:block>
    <th:block th:replace="this :: addressVerification(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'addressVerification',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'addressVerification')?.visible == true }" ></th:block>
    <th:block th:replace="this :: welcomeCall(editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'welcomeCall',productCategoryId)?.editable})" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'welcomeCall')?.visible == true}" ></th:block>

    <script>
        $("div.panel-collapse-animation > div.panel-heading").each(function(index,element){
            $(element).click();
        })
    </script>
</th:block>

<th:block th:fragment="summary">
    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapseSummary" th:onclick="'getSummaryData(' + ${loanId} + ')'">
            <h6 class="panel-title">
                Resumen
            </h6>
        </div>
        <div id="collapseSummary" class="panel-collapse collapse">
            <div class="panel-body">
                <th:block th:if="${summaryData}">
                    <th:block th:replace="this :: summaryData"></th:block>
                </th:block>
                <th:block th:unless="${summaryData}">
                    <th:block th:replace="this :: loading"></th:block>
                </th:block>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="summaryData">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'summary',productCategoryId)?.editable}">
        <div class="table-container" style="margin-top: 0px">
            <table class="table no-border no-color" style="border: 0 !important;">
                <thead class="no-color text-left" style="background-color: transparent">
                <tr class="no-color text-left">
                    <th style="width: 15%" class="pl-0 pt-0">Monto solicitado</th>
                    <th style="width: 15%" class="pl-0 pt-0">Fecha expiración</th>
                    <th class="pt-0" style="width: 15%">Verificación de identidad</th>
                    <th class="pt-0" style="width: 15%">Alerta de fraude</th>
                    <th class="pt-0" style="width: 20%">Nota de analista</th>
                    <th th:if="${contractEmailStatus != null}" class="pt-0" style="width: 15%">Envio de contrato</th>
                    <th style="position: relative;">
                        <div class="dropdown ml-auto" th:if="${editable}" style="position: absolute;top: 0px;">
                            <button class="btn btn-default btn-circle dropdown-toggle d-flex" type="button" data-toggle="dropdown">
                                Acciones
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/select_arrow.svg" class="ml-auto pull-right" alt="" style="width: 12px"/>
                            </button>
                            <ul class="dropdown-menu pull-right" role="menu">
                                <li shiro:hasPermission="loan:action:approve"><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'approve\')'">Aprobar</a></li>
                                <li shiro:hasPermission="loan:action:reject"><a href="javascript:;" th:onclick="'openRejectionModal()'">Rechazar</a></li>
                                <li shiro:hasPermission="loan:action:approve"><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'validateamount\')'">Validar monto</a></li>
                                <li class="dropdown-submenu pull-left">
                                    <a tabindex="-1" href="javascript:;">Otros</a>
                                    <ul class="dropdown-menu">
                                        <li shiro:hasPermission="loan:action:expire"><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'expire\')'">Expirar solicitud</a></li>
                                        <li shiro:hasPermission="loan:fraudAlerts:execute"><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'runFraudAlerts\')'">Correr Alertas de Fraude</a></li>
                                        <li shiro:hasPermission="loan:action:firstDueDate:update"><a href="javascript:;"  onclick="openFirstDueDate()">Cambiar vencimiento</a></li>
                                        <li shiro:hasPermission="loan:action:returnToContract"><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'returnToContract\')'">Volver al contrato</a></li>
                                        <li shiro:hasPermission="loan:action:reevaluate"><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'reevaluate\')'">Reevaluar</a></li>
                                        <th:block shiro:hasPermission="loan:action:offer:create">
                                            <li  th:if="${summaryData?.fixedOffer == null or !summaryData?.fixedOffer}"><a href="javascript:;" th:onclick="'showCreateLoanOffer('+${loanId}+')'">Modificar importe</a></li>
                                        </th:block>
                                        <li><a href="javascript:;" th:onclick="'executeAction('+${loanId}+',\'resend_validation_email\')'">Enviar correo verificación</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td class="pl-0 pt-0" th:text="${@utilService.integerMoneyFormat(summaryData?.loan?.amount)}"></td>
                    <td class="pl-0 pt-0" th:text="${@utilService.dateFormat(summaryData?.loan?.expirationDate)}"></td>
                    <td class="pt-0">

                        <th:block th:if="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.approved}">
                            Aprobado
                        </th:block>
                        <th:block th:unless="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.approved}">
                            <th:block th:if="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status}">
                                    <th:block th:switch="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status}">
                                        <th:block th:case="${T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_MANUAL_REVISION}">
                                            Revisión manual
                                        </th:block>
                                        <th:block th:case="${T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_MANUAL_REVISION_WAITING_APPROVAL}">
                                            Revisión manual
                                        </th:block>
                                        <th:block th:case="${T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_NO_PARAM}">
                                            No se ha configurado parámetro.
                                        </th:block>
                                    </th:block>
                            </th:block>
                            <th:block th:unless="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status}">
                                Rechazado
                            </th:block>
                        </th:block>
                    </td>
                    <td class="pt-0" th:text="${loanApplicationFraudAlerts == null or #lists.isEmpty(loanApplicationFraudAlerts) ? 'No cuenta con alertas' : 'Presenta alerta de fraude'}"></td>
                    <td class="pt-0" th:text="${note != null ? note?.comment : ''}"></td>
                    <td th:if="${contractEmailStatus != null}" class="pt-0" th:utext="${contractEmailStatus}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="table-container">
            <table class="table no-border no-color" style="border: 0 !important;">
                <thead class="no-color text-left" style="background-color: transparent">
                    <tr class="no-color text-left">
                        <th style="width: 30%" class="pl-0">Oferta
                            <span th:if="${campaign}" class="btn chips-label chips-label-active-entity">
                                <i class="fa fa-database" aria-hidden="true"></i>
                                <th:block th:text="${campaign}"></th:block>
                            </span>
                        </th>
                        <th style="width: 15%">Cuota promedio</th>
                        <th style="width: 15%">RCI</th>
                        <th style="width: 40%">Estado</th>
                    </tr>
                </thead>
                <tbody>
                <tr th:each="offer, iter : ${summaryData?.offers}" th:classappend="${offer.selected} ? 'selected-offer-black' : ''">
                    <td class="pl-0 pt-0 pb-0">

                        <th:block th:text="'' + ${summaryData?.getSummaryOffer(offer,@utilService, loanApplication?.country?.id)}" ></th:block>

                        <th:block>
                            <a href="javascript:;" th:if="${offer.selectedByClient}" th:classappend="${offer.selectedByClient} ? 'offer-client-button' : ''" class="btn chips-label evaluation-select-button">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-cliente.svg" alt="" class="custom-icono-svg"/>
                                Cliente</a>
                        </th:block>
                        <th:block>
                            <a href="javascript:;" th:if="${offer.selectedByAnalyst}" th:classappend="${offer.selectedByAnalyst} ? 'offer-client-button' : ''" class="btn chips-label evaluation-select-button chips-label-active">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-cliente.svg" alt="" class="custom-icono-svg"/>
                                Analista</a>
                        </th:block>

                    </td>
                    <td  class="pt-0 pb-0" th:text="${@utilService.doubleMoneyFormat(offer?.installmentAmountAvg,offer?.currency)}"></td>

                    <td th:if="${offer?.rci}" class="pt-0 pb-0" th:text="${@utilService.percentFormat(offer.rci, offer?.currency)}"></td>
                    <td th:unless="${offer?.rci}" class="pt-0 pb-0">N/A</td>

                    <td class="pt-0 pb-0">
                        <th:block th:if="${offer.selected}">
                            <button type="button" class="chips-label mw-150px chips-label-active">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-seleccionado.svg" alt="" class="custom-icono-svg"/>
                                Seleccionado</button>
                            <button class="chips-label mw-150px" type="button" th:if="${editable}"  shiro:hasPermission="offer:notify" th:onclick="'notifyLoanOffer('+${offer.id}+','+${loanId}+',\'summary\')'">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-notificar-cliente.svg" alt="" class="custom-icono-svg"/>
                                Notificar</button>
                        </th:block>
                        <th:block th:unless="${offer.selected}">
                            <button class="chips-label mw-150px" type="button" th:if="${editable}"  shiro:hasPermission="offer:select" th:onclick="'selectLoanOffer('+${offer.id}+','+${loanId}+',\'summary\')'">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-seleccionado.svg" alt="" class="custom-icono-svg"/>
                                Seleccionar</button>
                        </th:block>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="changeFirstDueDateModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="content">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <p>Selecciona la nueva fecha del primer vencimiento. Al cambiar esta fecha, se generará y seleccionará una nueva oferta con los mismo parametros de la oferta seleccionada actualmente. Ademas se mandará la solicitud a la pantallade firma.</p>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <input id="loanFirstDueDate" type="text" class="form-control"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default cancelButtonSaveButton" data-dismiss="modal">Cerrar</button>
                            <button id="loanFirstDueDateSaveBtn" type="button" class="btn btn-info">Guardar</button>
                        </div>

                        <script th:inline="javascript">
                            /*<![CDATA[*/
                            // moment.locale("es");
                            var enableDates = [[${enableDates}]];
                            var defaultSelectedDate = [[${selectedDate}]];
                            var loanApplicationId = [[${loanApplication.id}]];

                            var jsonDatePicker = {
                                format: 'DD/MM/YYYY',
                                inline: true,
                                sideBySide: true
                            };
                            if (enableDates != null) {
                                for (i = 0; i < enableDates.length; i++) {
                                    enableDates[i] = moment(enableDates[i], "DD/MM/YYYY");
                                }
                                jsonDatePicker.enabledDates = enableDates;
                                jsonDatePicker.defaultDate = moment(defaultSelectedDate, "DD/MM/YYYY");
                            }
                            $('#loanFirstDueDate').datetimepicker(jsonDatePicker);
                            $('#loanFirstDueDate').val(jsonDatePicker.defaultDate.format("DD/MM/YYYY"));
                            $('#loanFirstDueDate').on('dp.change', function (event) {
                                var formatted_date = event.date.format("DD/MM/YYYY");
                                if (event.date) {
                                    console.log('Date chosen: ' + event.date.format());
                                }
                            });
                            $('#loanFirstDueDateSaveBtn').on('click', function (event) {
                                defaultAjax({
                                    url: /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/action/changeFirstDueDate}]]*/null,
                                    data: {
                                        loanApplicationId: loanApplicationId,
                                        firstDueDate: $('#loanFirstDueDate').val()
                                    },
                                    type: 'POST',
                                    success: function (data) {
                                        $('#changeFirstDueDateModal').modal('hide');
                                        getSummaryData(loanApplicationId);
                                    },
                                    error: function (data) {
                                        showErrorModal('Hubo un problema ejecutar la acción');
                                    }
                                });
                            });
                            /*]]>*/
                        </script>

                    </div>
                </div>
            </div>
        </div>

        <div id="createLoanOfferModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="loading">
                        <div class="modal-body">
                            <i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>
                            <span> &nbsp;&nbsp;Loading... </span>
                        </div>
                    </div>
                    <div class="content">
                    </div>
                </div>
            </div>
        </div>

        <div id="registerApplicationRejectionModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <form role="form" action="#" id="frmRegisterApplicationRejectionModal" method="post">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group field" style="padding-bottom: 0px;">
                                        <label class="control-label" for="applicationRejectionReasonId">Raz&oacute;n de
                                            rechazo</label>
                                        <select class="form-control" name="applicationRejectionReasonId"
                                                id="applicationRejectionReasonId">
                                            <option th:each="reason : ${@catalogService.getApplicationRejectionReasons()}"
                                                    th:value="${reason.id}" th:text="${reason.reason}"></option>
                                        </select>
                                    </div>
                                    <div class="form-group field">
                                        <label class="control-label" for="applicationRejectionComment">Comentarios</label>
                                        <textarea class="form-control" name="applicationRejectionComment" id="applicationRejectionComment" maxlength="200"></textarea>
                                        <div class="errorContainer">
                                            <span class="help-block form-field-error-message"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default cancelButtonSaveButton" data-dismiss="modal">Cerrar</button>
                        <button id="registerApplicationRejectionButton" th:onclick="'executeAction('+${loanId}+',\'reject\')'" type="button" class="btn btn-info acceptModalButton">
                            Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            function openFirstDueDate(){
                $("#changeFirstDueDateModal").modal('show');
            }
            function openRejectionModal(){
                $("#registerApplicationRejectionModal").modal('show');
            }

            $(document).ready(function(){
                var rejectLoanApplicationJsonFormValidation;
                var $rejectLoanApplicationFormValidator;

                var rejectLoanApplicationForm = /*[[${rejectLoanApplicationForm.validator.toJson(#locale)}]]*/null;
                if (rejectLoanApplicationForm != null) {
                    var jsonRejectLoanApplicationValidator = JSON.parse(rejectLoanApplicationForm);
                    rejectLoanApplicationJsonFormValidation = createFormValidationJson(jsonRejectLoanApplicationValidator, $('#frmRegisterApplicationRejectionModal'));

                    $rejectLoanApplicationFormValidator  = $('#frmRegisterApplicationRejectionModal').validateForm(rejectLoanApplicationJsonFormValidation);
                }
            })
            /*]]>*/
        </script>
    </th:block>


</th:block>

<th:block th:fragment="createLoanOfferModal">
    <div class="modal-body">
        <form role="form" action="#" method="post" th:object="${createLoanOfferForm}"
              id="frmCreateLoanOfferModal">

            <input type="hidden" name="loanApplicationId" th:value="${loanApplicationId}"/>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="control-label" for="ammount"
                               th:text="#{form.field.ammount}"></label>

                        <input type="text" th:id="ammount" th:name="ammount"
                               th:value="${loanAmmount != null} ? ${loanAmmount} : ${loanApplication?.amount}"
                               class="form-control"/>
                        <div class="errorContainer">
                            <span class="help-block form-field-error-message"></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="control-label" for="installments"
                               th:text="#{form.field.installments}"></label>
                        <span id="installmentsValue" style="float: right"></span>
                        <input th:id="installments" th:name="installments"
                               th:value="${loanApplication?.installments}" type="text" class="form-control"/>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="control-label" for="entityId">Entidad</label>
                        <select th:id="entitySelect" th:field="*{entityId}" class="form-control">
                            <option th:each="entity : ${entities}" th:value="${entity.id}"
                                    th:text="${entity.shortName}"
                                    th:selected="${entity.id == entitySelected}"></option>
                        </select>
                        <script th:inline="javascript">
                            /*<![CDATA[*/
                            $('#entitySelect').on('change', function () {
                                var entityId = this.value;
                                var baseUrl = /*[[@{/loanOffer/modal/create}]]*/null;
                                defaultAjax({
                                    url: baseUrl,
                                    type: 'GET',
                                    data: {
                                        loanApplicationId: /*[[${loanApplicationId}]]*/null,
                                        entityId: entityId
                                    },
                                    success: function (data) {
                                        $('#createLoanOfferModal .content').replaceWith(data);
                                    }
                                });
                            });
                            /*]]>*/
                        </script>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-default cancelButtonSaveButton" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-info acceptModalButton"
                th:onclick="'createLoanOffer(' + ${loanApplicationId} + ')'">Guardar
        </button>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        var loanOfferJsonFormValidation;
        var $loanOfferRegisterFormValidator;

        var loanOfferValidator = /*[[${createLoanOfferForm.validator.toJson(#locale)}]]*/null;
        if (loanOfferValidator != null) {
            var jsonValidator = JSON.parse(loanOfferValidator);
            loanOfferJsonFormValidation = createFormValidationJson(jsonValidator, $('#frmCreateLoanOfferModal'));

            loanOfferJsonFormValidation.rules.termsAndConditions = {};
            loanOfferJsonFormValidation.rules.termsAndConditions.required = true;

            $loanOfferRegisterFormValidator = $('#frmCreateLoanOfferModal').validateForm(loanOfferJsonFormValidation);
        }

        // LoanApplicationInstallments
        var installmentsOnChange = function () {
            $('#installmentsValue').html($("#installments").val() + /*[[${loanApplication.product?.paymentType?.pluralName}]]*/);
        };
        $('#installments').ionRangeSlider({
            min: /*[[${createLoanOfferForm.validator.installments.minValue}]]*/,
            max: /*[[${createLoanOfferForm.validator.installments.maxValue}]]*/,
            from: /*[[${loanApplication.installments}]]*/,
            keyboard: true,
            hide_from_to: true,
            onChange: installmentsOnChange
        });
        installmentsOnChange();

        /*]]>*/
    </script>
</th:block>

<th:block th:fragment="applicant">

    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapseApplicant"  th:onclick="'getApplicantData(' + ${loanId} + ')'">
            <h6 class="panel-title">
                Solicitante
            </h6>
        </div>
        <div id="collapseApplicant" class="panel-collapse collapse">
            <div class="panel-body">
                <th:block th:if="${applicantData}">
                    <th:block th:replace="this :: applicantData"></th:block>
                </th:block>
                <th:block th:unless="${applicantData}">
                    <th:block th:replace="this :: loading"></th:block>
                </th:block>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="applicantData">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'applicant',productCategoryId)?.editable}">
        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function(e){

                let loanAppId = /*[[${loanId}]]*/null;
                $("#nacionality").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'nacionality'],
                });

                $("#maritalStatus").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'maritalStatus'],
                });

                $("#dependents").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'dependents'],
                });

                $("#phoneNumber").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'phoneNumber'],
                });

                $("#email").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'email'],
                });

                $("#maritalDocumentType").editableInputFn({
                    fn : updateFieldValuePartner,
                    params: [loanAppId],
                });

                $("#maritalDocumentNumber").editableInputFn({
                    fn : updateFieldValuePartner,
                    params: [loanAppId],
                });

                $("#maritalName").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'partnerName'],
                });

                $("#maritalFirstSurname").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'partnerFirstSurname'],
                });

                $("#maritalLastSurname").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'partnerLastSurname'],
                });

                $("#pepSelect").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'pep'],
                });

                $("#fatcaSelect").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'fatca'],
                });

            })
            /*]]>*/
        </script>
        <div class="custom-row">
            <div class="col-md-2 pl-0">
                <div class="card-title">Nombres</div>
                <span class="card-title-description" th:text="${applicantData?.name}"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Apellido Paterno</div>
                <span class="card-title-description" th:text="${applicantData?.firstSurname}"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Apellido Materno</div>
                <span class="card-title-description" th:text="${applicantData?.lastSurname}"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Tipo de Documento</div>
                <span class="card-title-description" th:text="${applicantData?.documentType?.name}"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Número de Documento</div>
                <span class="card-title-description" th:text="${applicantData?.documentNumber}"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Fecha de Nacimiento</div>
                <span class="card-title-description" th:text="${@utilService.dateFormat(applicantData?.birthday)}"></span>
            </div>
        </div>
        <div class="custom-row">
            <div class="col-md-2 pl-0">
                <div class="card-title">Nacionalidad</div>
                <div class="input-material">
                    <select name="nacionality" id="nacionality" th:disabled="${!editable}">
                        <th:block th:each="nationality, iter : ${@catalogService.getNationalities(#locale)}">
                            <option th:value="${nationality.id}" th:selected="${nationality.id == applicantData?.nationality?.id} ? true : false" th:text="${nationality.name}"></option>
                        </th:block>
                    </select>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Estado civil</div>
                <div class="input-material">
                    <select name="civil" id="maritalStatus" th:disabled="${!editable}">
                        <th:block th:each="maritalStatus, iter : ${maritalStatuses}">
                            <option th:value="${maritalStatus.id}" th:selected="${maritalStatus.id == applicantData?.maritalStatus?.id} ? true : false" th:text="${maritalStatus.status}"></option>
                        </th:block>
                    </select>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Dependientes</div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.dependents}" id="dependents" />
                </div>
            </div>
            <!--        <div class="col-md-2 pl-0">-->
            <!--            <div class="card-title">Cargo</div>-->
            <!--            <span th:text="${applicantData?.personOcupationalInformation?.ocupation?.getOcupation()}"></span>-->
            <!--        </div>-->
            <!--        <div class="col-md-2 pl-0">-->
            <!--            <div class="card-title">Sector económico</div>-->
            <!--            <span th:text="${applicantData?.profession?.profession}"></span>-->
            <!--        </div>-->
            <div class="col-md-2 pl-0">
                <div class="card-title">Nivel de estudios</div>
                <span class="card-title-description" th:text="${applicantData?.studyLevel?.level}"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">PEP</div>
                <div class="input-material">
                    <select name="pep" id="pepSelect" th:disabled="${!editable}">
                        <option th:value="${null}" th:selected="${applicantData?.pep == null} ? true : false" disabled="disabled">Sin asignar</option>
                        <option th:value="true" th:selected="${applicantData?.pep != null and applicantData?.pep} ? true : false">Si</option>
                        <option th:value="false" th:selected="${applicantData?.pep != null and !applicantData?.pep} ? true : false">No</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">FATCA</div>
                <div class="input-material">
                    <select name="fatca" id="fatcaSelect" th:disabled="${!editable}">
                        <option th:value="${null}" th:selected="${applicantData?.fatca == null} ? true : false" disabled="disabled">Sin asignar</option>
                        <option th:value="true" th:selected="${applicantData?.fatca != null and applicantData?.fatca} ? true : false">Si</option>
                        <option th:value="false" th:selected="${applicantData?.fatca != null and !applicantData?.fatca} ? true : false">No</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="custom-row">
            <!--        <div class="col-md-2 pl-0">-->
            <!--            <div class="card-title">Profesión/Ocupación</div>-->
            <!--            <span th:text="${applicantData?.professionOccupation?.occupation}"></span>-->
            <!--        </div>-->
            <div class="col-md-2 pl-0">
                <div class="card-title">Teléfono
                    <span th:classappend="${applicantData?.phoneVerified} ? 'vrified-alert' : 'no-verified-alert'">
                    <th:block th:text="${applicantData?.phoneVerified} ? 'Verificado' : 'No verificado'"></th:block>
                </span>
                </div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.phoneNumber}" id="phoneNumber"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Correo
                    <span th:classappend="${applicantData?.emailVerified} ? 'vrified-alert' : 'no-verified-alert'">
                    <th:block th:text="${applicantData?.emailVerified} ? 'Verificado' : 'No verificado'"></th:block>
                </span>
                </div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.email}" id="email"/>
                </div>
            </div>
            <!--        <div class="col-md-2 pl-0 ml-auto">-->
            <!--            <div class="card-title">Latitud/ Logitud</div>-->
            <!--            <span>-->
            <!--                <th:block th:text="${applicantData?.personContactInformation?.addressLatitude}"></th:block>/-->
            <!--                <th:block th:text="${applicantData?.personContactInformation?.addressLongitude}"></th:block>-->
            <!--            </span>-->
            <!--        </div>-->
        </div>
        <div class="custom-row">
            <h5 class="h5 fw-bold" style="margin: 0px">Cónyuge</h5>
        </div>
        <div class="custom-row">
            <div class="col-md-2 pl-0">
                <div class="card-title">Tipo de Documento</div>
                <div class="input-material w-90 text-left">
                    <select name="" th:disabled="${!editable}" class="" id="maritalDocumentType" th:value="${applicantData?.partner?.documentType != null ? applicantData?.partner?.documentType?.id : ''}">
                        <th:block th:each="identityDocumentType : ${@catalogService.getIdentityDocumentTypeByCountry(applicantData?.countryParam?.id, false)}">
                            <option
                                    th:selected="${applicantData?.partner?.documentType != null and applicantData?.partner?.documentType?.id == identityDocumentType.id ? true : false}"
                                    th:value="${identityDocumentType.id}"
                                    th:text="${identityDocumentType.name}"></option>
                        </th:block>
                    </select>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Número de Documento</div>
                <div class="input-material text-left">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.partner?.documentNumber}" id="maritalDocumentNumber"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Nombres</div>
                <div class="input-material text-left">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.partner?.name}" id="maritalName"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Apellido Paterno</div>
                <div class="input-material text-left">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.partner?.firstSurname}" id="maritalFirstSurname"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Apellido Materno</div>
                <div class="input-material text-left">
                    <input type="text" th:disabled="${!editable}" th:value="${applicantData?.partner?.lastSurname}" id="maritalLastSurname"/>
                </div>
            </div>


        </div>
        <div class="custom-row fl-column">
            <div>
                <div class="col-md-6 pl-0">
                    <div class="card-title">Dirección</div>
                    <div class="input-material input-material-group">
                        <input type="text" th:disabled="${!editable}" th:value="${applicantData?.address}" onclick="showUpdatePersonAddressModal('home')" readonly="true"/>
                        <i class="fa fa-search search"></i>
                    </div>
                </div>
                <div class="col-md-3 pl-0">
                    <div class="card-title">Georef. Navegador</div>
                    <span class="card-title-description">
                        <th:block th:text="${applicantData?.navLatitude}"></th:block>,<th:block th:text="${applicantData?.navLongitude}"></th:block>
                    </span>
                </div>
            </div>
            <div class="col-md-6 pl-0" style="margin-top: 10px">
                <img                  th:src="'https://maps.googleapis.com/maps/api/staticmap?center='+
                                                ${latitude}+','+${longitude}+
                                                '&amp;zoom=14&amp;size=500x250&amp;maptype=roadmap&amp;markers=color:red%7C'+
                                                ${latitude}+','+${longitude}+
                                                '&amp;key='+${T(com.affirm.system.configuration.Configuration).GOOGLE_API_KEY}"
                                      onclick="showUpdatePersonAddressModal('home')"
                                      style="width: 100%;"/>
            </div>
        </div>
        <th:block th:replace="this:: modalAddress(type='home')"></th:block>
        <script>
            function showUpdatePersonAddressModal(type){
                $('#modal_address_'+type).modal();
            }
        </script>
    </th:block>

</th:block>

<th:block th:fragment="incomes">
    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapseIncomes" th:onclick="'getIncomesData(' + ${loanId} + ')'">
            <h6 class="panel-title">
                Información de Ingresos
            </h6>
        </div>
        <div id="collapseIncomes" class="panel-collapse collapse">
            <div class="panel-body">
                <th:block th:if="${incomesData}">
                    <th:block th:replace="this :: incomesData"></th:block>
                </th:block>
                <th:block th:unless="${incomesData}">
                    <th:block th:replace="this :: loading"></th:block>
                </th:block>
            </div>
        </div>
    </div>

</th:block>

<th:block th:fragment="incomesData">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'incomes',productCategoryId)?.editable}">

        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function(e){

                let loanAppId = /*[[${loanId}]]*/null;
                $("#activity").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalActivityType'],
                });

                $("#principalDependentRuc").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalDependentRuc'],
                });

                $("#principalDependentCompany").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalDependentCompany'],
                });

                $("#principalDependentCiiu").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalDependentCiiu'],
                });

                $("#principalDependentTime").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalDependentTime'],
                });

                $("#principalOcupation").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalOcupation'],
                });

                $("#principalDependentGrossIncome").editableInputFn({
                    fn : updateFieldValueAndExecuteAction,
                    params: [loanAppId,'principalDependentGrossIncome', 'refresh_loan'],
                });

                $("#principalDependentVariableGrossIncome").editableInputFn({
                    fn : updateFieldValueAndExecuteAction,
                    params: [loanAppId,'principalDependentVariableGrossIncome', 'refresh_loan'],
                });


                $("#profession").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalSector'],
                });

                $("#occupation").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'principalOcupation'],
                });

                $("#professionOccupation").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'professionOccupation'],
                });



            })
            /*]]>*/
        </script>

        <div class="custom-row">
            <div class="col-md-2 pl-0">
                <div class="card-title">Actividad</div>
                <div class="input-material">
                    <select name="nacionality" id="activity" th:disabled="${!editable}">
                        <th:block th:each="activity, iter : ${@catalogService.getActivityTypes(#locale, true)}">
                            <option th:value="${activity.id}" th:selected="${activity.id == principalOcupation?.activityType?.id} ? true : false" th:text="${activity.type}"></option>
                        </th:block>
                    </select>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Sector económico</div>
                <!--            <input type="text" th:value="${person?.getProfession()?.profession}" id="profession"/>-->
                <div class="input-material" >
                    <select name="profession" id="profession" th:disabled="${!editable}">
                        <option th:each="profession : ${@catalogService.getProfessionsActive(#locale)}"
                                th:value="${profession.id}" th:selected="${person?.getProfession()?.id != null and person?.getProfession()?.id == profession.id ? true : false }" th:text="${profession.profession}"></option>
                    </select>
                </div>

            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Cargo</div>
                <div class="input-material" >
                    <!--                <input type="text" th:value="${principalOcupation?.ocupation?.id}" id="occupation"/>-->
                    <select name="occupation" th:disabled="${!editable}" id="occupation" th:value="${principalOcupation?.ocupation?.id}">
                        <th:block th:each="ocupation : ${occupations}">
                            <option th:value="${ocupation.id}"  th:selected="${principalOcupation?.ocupation?.id != null and principalOcupation?.ocupation?.id == ocupation.id ? true : false }" th:text="${ocupation.ocupation}"></option>
                        </th:block>
                    </select>

                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Profesión/Ocupación</div>
                <div class="input-material" >
                    <select name="professionOccupation" th:disabled="${!editable}" id="professionOccupation" th:value="${principalOcupation?.ocupation?.id}">
                        <option value="" disabled="disabled" th:selected="${person?.professionOccupation?.id == null ? true : false }">Sin asignar</option>
                        <th:block th:each="professionOccupation : ${professionOccupations}">
                            <option th:value="${professionOccupation.id}"  th:selected="${person?.professionOccupation?.id != null and person?.professionOccupation?.id == professionOccupation.id ? true : false }" th:text="${professionOccupation.occupation}"></option>
                        </th:block>
                    </select>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Tiempo laboral (meses)</div>
                <div class="input-material" >
                    <input type="text" th:disabled="${!editable}" th:value="${principalOcupation?.employmentTime}" id="principalDependentTime"/>
                </div>
            </div>
        </div>
        <div class="custom-row">
            <div class="col-md-2 pl-0">
                <div class="card-title">RUC</div>
                <div class="input-material" >
                    <input type="text" th:disabled="${!editable}" th:value="${principalOcupation?.ruc}" id="principalDependentRuc"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Empresa</div>
                <div class="input-material" >
                    <input type="text" th:disabled="${!editable}" th:value="${principalOcupation?.companyName}" id="principalDependentCompany"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">CIIU</div>
                <div class="input-material" >
                    <input type="text" th:disabled="${!editable}" th:value="${principalOcupation?.ciiu}" id="principalDependentCiiu"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Teléfono Laboral</div>
                <div class="input-material" th:onclick="'showOccupationalPhoneNumberModal('+${person?.id}+','+${loanId}+')'">
                    <input type="text" th:disabled="${!editable}" th:value="${@personService.getCurrentOcupationalInformation(person?.id, #locale)?.phoneNumber}" readonly="readonly" id="jobPhone"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Ingreso fijo</div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${principalOcupation?.fixedGrossIncome}" id="principalDependentGrossIncome"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Ingreso variable</div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${principalOcupation?.variableGrossIncome}" id="principalDependentVariableGrossIncome"/>
                </div>
            </div>

        </div>

        <div class="custom-row fl-column">
            <div class="col-md-6 pl-0">
                <div class="card-title">Dirección Laboral</div>
                <div class="input-material input-material-group">
                    <input type="text" th:value="${address != null and address != 'null'? address : ''}" onclick="showUpdatePersonAddressModal('work')" readonly="true"/>
                    <i class="fa fa-search search"></i>
                </div>
            </div>
            <div class="col-md-6 pl-0" style="margin-top: 10px">
                <img
                        th:src="'https://maps.googleapis.com/maps/api/staticmap?center='+
                                                ${latitude}+','+${longitude}+
                                                '&amp;zoom=14&amp;size=500x250&amp;maptype=roadmap&amp;markers=color:red%7C'+
                                                ${latitude}+','+${longitude}+
                                                '&amp;key='+${T(com.affirm.system.configuration.Configuration).GOOGLE_API_KEY}"

                        onclick="showUpdatePersonAddressModal('work')"
                        style="width: 100%;"/>
            </div>
        </div>
        <th:block th:replace="this:: modalAddress(type='work')"></th:block>
        <script>
            function showUpdatePersonAddressModal(type){
                $('#modal_address_'+type).modal();
            }
        </script>

        <div id="updateOccupationalPhoneNumberModal" class="modal fade">
            <div class="modal-dialog modal-lg" style="min-width: 580px !important;">
                <div class="modal-content">
                    <div class="content">
                        <th:block th:replace="this :: updateOccupationalPhoneNumberModal"></th:block>
                    </div>
                </div>
            </div>
        </div>
    </th:block>


</th:block>

<th:block th:fragment="request">
    <script>
        $(document).ready(function(){
            $(".tab-button").click(function(e){
                $(".tab-button").removeClass("active");
                $(e.currentTarget).addClass("active");
            })
            if(!$("button.tab-button.active").length) $("button.tab-button:first").click()
        })
    </script>
    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapseRequest">
            <h6 class="panel-title">
                Solicitud
            </h6>
        </div>
        <div id="collapseRequest" class="panel-collapse collapse">
            <div class="panel-body">
                <div class="custom-tabs">
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','generalInformation',productCategoryId)?.visible == true}" th:onclick="'getRequestTabData(' + ${loanId} + ',\'general\')'" th:classappend="${defaultTab == 'general'} ? 'active' : ''">Información general</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','evaluationResult',productCategoryId)?.visible == true}" th:onclick="'getRequestTabData(' + ${loanId} + ',\'evaluation\')'" th:classappend="${defaultTab == 'evaluation'} ? 'active' : ''">Resultado evaluación</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','documentation',productCategoryId)?.visible == true}" id="documentation_tab" th:onclick="'getRequestTabData(' + ${loanId} + ',\'documentation\')'" th:classappend="${defaultTab == 'documentation'} ? 'active' : ''" >Documentación</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','identityValidation',productCategoryId)?.visible == true}" th:onclick="'getRequestTabData(' + ${loanId} + ',\'identity_validation\')'" th:classappend="${defaultTab == 'identity_validation'} ? 'active' : ''">Verificación de identidad</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','fraudAlert',productCategoryId)?.visible == true}" id="fraud_alert_tab" th:onclick="'getRequestTabData(' + ${loanId} + ',\'fraud_alert\')'" th:classappend="${defaultTab == 'fraud_alert'} ? 'active' : ''" >Alertas de fraude</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','bankAccount',productCategoryId)?.visible == true}" th:onclick="'getRequestTabData(' + ${loanId} + ',\'bank_account\')'" th:classappend="${defaultTab == 'bank_account'} ? 'active' : ''" >Cuenta Bancaria</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','notes',productCategoryId)?.visible == true}" id="notes_tab" th:onclick="'getRequestTabData(' + ${loanId} + ',\'notes\')'" th:classappend="${defaultTab == 'notes'} ? 'active' : ''" >Log de notas</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','sbs',productCategoryId)?.visible == true}" th:onclick="'getRequestTabData(' + ${loanId} + ',\'sbs\')'" th:classappend="${defaultTab == 'sbs'} ? 'active' : ''"  style="min-width: 100px;">SBS</button>
                    <button class="tab-button" th:if="${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','interaction',productCategoryId)?.visible == true}" th:onclick="'getRequestTabData(' + ${loanId} + ',\'interaction\')'" th:classappend="${defaultTab == 'interaction'} ? 'active' : ''" >Interacciones</button>
                </div>
                <div class="custom-row fl-column" id="tabPanelContainer">
                    <th:block th:swith="${defaultTab}" th:if="${defaultTab}">
                        <th:block th:case="'general'">
                            <th:block th:replace="this:: generalInformation"></th:block>
                        </th:block>
                        <th:block th:case="'evaluation'">
                            <th:block th:replace="this:: evaluationResult"></th:block>
                        </th:block>
                        <th:block th:case="'documentation'">
                            <th:block th:replace="this:: documentation"></th:block>
                        </th:block>
                        <th:block th:case="'identity_validation'">
                            <th:block th:replace="this:: identityValidation"></th:block>
                        </th:block>
                        <th:block th:case="'fraud_alert'">
                            <th:block th:replace="this:: fraudAlert"></th:block>
                        </th:block>
                        <th:block th:case="'bank_account'">
                            <th:block th:replace="this:: bankAccount"></th:block>
                        </th:block>
                        <th:block th:case="'notes'">
                            <th:block th:replace="this:: notes"></th:block>
                        </th:block>
                        <th:block th:case="'interaction'">
                            <th:block th:replace="this:: interaction"></th:block>
                        </th:block>
                        <th:block th:case="'sbs'">
                            <th:block th:replace="this:: sbs"></th:block>
                        </th:block>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="generalInformation">
    <div class="custom-row" th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','generalInformation',productCategoryId)?.editable}">
        <div class="col-md-2 pl-0">
            <div class="card-title">Motivo del crédito</div>
            <div class="input-material" >
                <select name="creditReason" id="creditReason" th:disabled="${!editable}">
                    <option value="" disabled="disabled" th:selected="${loanApplication?.reason?.id == null ? true : false }">Sin asignar</option>
                    <th:block th:each="reason : ${reasons}">
                        <option th:value="${reason.id}"  th:selected="${loanApplication?.reason?.id != null and loanApplication?.reason?.id == reason.id ? true : false }" th:text="${reason?.reason}"></option>
                    </th:block>
                </select>
            </div>
        </div>
        <div class="col-md-2 pl-0">
            <div class="card-title">Preevaluación aprobada</div>
            <span class="card-title-description" th:text="${@utilService.datetimeShortFormat(loanApplication?.peapprovedDate)}"></span>
        </div>
        <div class="col-md-2 pl-0">
            <div class="card-title">Evaluación aprobada</div>
            <span class="card-title-description" th:text="${@utilService.datetimeShortFormat(loanApplication?.eapprovedDate)}"></span>
        </div>
        <div class="col-md-2 pl-0">
            <div class="card-title">Fecha de primera cuota</div>
            <span class="card-title-description" th:text="${@utilService.dateFormat(loanApplication?.firstDueDate)}"></span>
        </div>
        <div class="col-md-2 pl-0">
            <div class="card-title">Horario de contacto</div>
            <span class="card-title-description" th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}" th:text="${@utilService.getAssistedProcessScheduleRange(loanApplication?.assistedProcessScheduledCallingDate)}"></span>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function(e){
            let loanAppId = /*[[${loanId}]]*/null;
            $("#creditReason").editableInputFn({
                fn : updateFieldValue,
                params: [loanAppId,'creditReason'],
            });
        })
        /*]]>*/
    </script>
</th:block>

<th:block th:fragment="evaluationResult">
    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','evaluationResult',productCategoryId)?.editable}">
        <div class="custom-row">
            <div class="col-md-6 pl-0">
                <div class="card-title h5 mt-2 mb-15px">Oferta</div>
                <div class="container-offers w-100">
                    <div class="w-100 row-nm mb-1" th:each="offer, iter : ${offers}">
                        <div class="col-md-6 pl-0" th:classappend="${offer.selected} ? 'fw-bold' : ''">
                            <th:block th:text="'' + ${offer?.getLoanOfferDescription(@utilService, loanApplication?.country?.id)}" ></th:block>
                        </div>
                        <div class="col-md-3 pl-0">
                            <th:block th:if="${offer.selected}">
                                <a href="javascript:;"  th:classappend="${offer.selected} ? 'offer-selected-button' : ''" class="btn w-100 p-1 evaluation-select-button">
                                    <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-seleccionado.svg" alt="" class="custom-icono-svg"/>
                                    Seleccionado</a>
                            </th:block>
                            <th:block th:unless="${offer.selected}">
                                <a href="javascript:;" th:if="${editable}" shiro:hasPermission="offer:select"  th:onclick="'selectLoanOffer('+${offer.id}+','+${loanId}+',\'evaluation\')'"  th:classappend="${offer.selected} ? 'offer-selected-button' : ''" class="btn w-100 p-1 evaluation-select-button">
                                    <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-seleccionado.svg" alt="" class="custom-icono-svg"/>
                                    Seleccionar</a>
                            </th:block>
                        </div>
                        <div class="col-md-3 pl-0">
                            <th:block th:if="${offer.selected}">
                                <a href="javascript:;" th:if="${editable}" shiro:hasPermission="offer:notify" th:onclick="'notifyLoanOffer('+${offer.id}+','+${loanId}+',\'evaluation\')'" th:classappend="${offer.selected} ? 'offer-client-button' : ''" class="btn w-90 p-1 evaluation-select-button">
                                    <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-notificar-cliente.svg" alt="" class="custom-icono-svg"/>
                                    Notificar</a>
                            </th:block>
                            <th:block th:unless="${offer.selected}">
                                <th:block th:if="${offer.selectedByClient}">
                                    <a href="javascript:;" th:classappend="${offer.selected} ? 'offer-client-button' : ''" class="btn w-90 p-1 evaluation-select-button">
                                        <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-cliente.svg" alt="" class="custom-icono-svg"/>
                                        Cliente</a>
                                </th:block>
                                <th:block th:if="${offer.selectedByAnalyst}">
                                    <a href="javascript:;" th:classappend="${offer.selected} ? 'offer-selected-button' : ''" class="btn w-90 p-1 evaluation-select-button">
                                        <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/tag-cliente.svg" alt="" class="custom-icono-svg"/>
                                        Analista</a>
                                </th:block>
                            </th:block>

                        </div>
                    </div>
                </div>
            </div>


            <div class="col-md-3 pl-0">
                <div class="card-title h5 mt-2 mb-15px">Antes de oferta</div>
                <div class="custom-row mb-0">
                    <div class="col-md-4 pl-0">
                        <div class="card-title">Cuota SBS</div>
                        <span class="card-title-description" th:text="${@utilService.doubleMoneyFormat(loanApplication?.sbsMonthlyInstallment, loanApplication?.country?.currency?.symbol, loanApplication?.country?.separator)}"></span>
                    </div>
                    <div class="col-md-8 pl-0">
                        <div class="card-title">Cuota SBS Hipotecario</div>
                        <span class="card-title-description" th:text="${@utilService.doubleMoneyFormat(loanApplication?.sbsMonthlyInstallmentMortgage, loanApplication?.country?.currency?.symbol, loanApplication?.country?.separator)}"></span>
                    </div>
                </div>
                <div class="custom-row mb-0">
                    <div class="col-md-4 pl-0">
                        <div class="card-title">RCI</div>
                        <span class="card-title-description" th:text="${@utilService.percentFormat(loanApplication?.rci, loanApplication?.country?.currency)}"></span>
                    </div>
                    <div class="col-md-8 pl-0">
                        <div class="card-title">Ingreso total Admisión</div>
                        <span class="card-title-description" th:text="${@utilService.doubleMoneyFormat(loanApplication?.admissionTotalIncome, loanApplication?.country?.currency)}"></span>
                    </div>
                </div>
            </div>

            <div class="col-md-3 pl-0">
                <div class="card-title h5 mt-2 mb-15px">Despues de oferta</div>
                <div class="custom-row mb-0">
                    <div class="col-md-4 pl-0">
                        <div class="card-title">Cuota SBS</div>
                        <span class="card-title-description" th:text="${@utilService.doubleMoneyFormat(loanApplication?.getSelectedLoanOffer()?.sbsMonthlyInstallment, loanApplication?.country?.currency?.symbol, loanApplication?.country?.separator)}"></span>
                    </div>
                    <div class="col-md-8 pl-0">
                        <div class="card-title">Cuota SBS Hipotecario</div>
                        <span class="card-title-description" th:text="${@utilService.doubleMoneyFormat(loanApplication?.getSelectedLoanOffer()?.sbsMonthlyInstallmentMotgage, loanApplication?.country?.currency?.symbol, loanApplication?.country?.separator)}"></span>
                    </div>
                </div>
                <div class="custom-row mb-0">
                    <div class="col-md-4 pl-0">
                        <div class="card-title">RCI</div>
                        <span class="card-title-description" th:text="${@utilService.percentFormat(loanApplication?.getSelectedLoanOffer()?.rci, loanApplication?.country?.currency)}"></span>
                    </div>
                    <div class="col-md-8 pl-0">
                        <div class="card-title">Ingreso total Admisión</div>
                        <span class="card-title-description" th:text="${@utilService.doubleMoneyFormat(loanApplication?.getSelectedLoanOffer()?.admissionTotalIncome, loanApplication?.country?.currency)}"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="custom-row fl-column" th:if="${loanApplication?.getSelectedLoanOffer() != null}">
            <h5 class="h5 fw-bold">Cronograma</h5>
            <table class="table-bordered custom-table-evaluation schedule-table">
                <thead class="grey-color-table">
                <tr>
                    <th>Cuota</th>
                    <th>Vencimiento</th>
                    <th>Remanente</th>
                    <th>Capital</th>
                    <th>Interés</th>
                    <th>Interés IGV</th>
                    <th>Recaudo</th>
                    <th>Recaudo IGV</th>
                    <th>Desgravamen</th>
                    <th>Cuota total</th>
                </tr>
                </thead>
                <tbody th:with="selectedLoanOffer=${loanApplication?.getSelectedLoanOffer()}" class="white-color">
                <tr th:each="offerSchedule : ${selectedLoanOffer.offerSchedule}">
                    <td th:text="${offerSchedule?.installmentId}"></td>
                    <td class="text-center"
                        th:text="${@utilService.dateFormat(offerSchedule?.getDueDate())}"
                        th:attr="data-order=${@utilService.datetimeYearFirstFormat(offerSchedule?.getDueDate())}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getRemainingCapital(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getInstallmentCapital(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getInterest(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getInterestTax(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getCollectionCommission(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getCollectionCommissionTax(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getInsurance(), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(offerSchedule?.getInstallmentAmount(), loanApplication?.country?.currency)}"></td>
                </tr>
                <tr>
                    <td colspan="2">Totales:</td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('remainingCapital'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('installmentCapital'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('interest'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('interestTax'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('collectionCommission'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('collectionCommissionTax'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('insurance'), loanApplication?.country?.currency)}"></td>
                    <td class="numeric"
                        th:text="${@utilService.doubleMoneyFormat(selectedLoanOffer.getTotalScheduleField('installmentAmount'), loanApplication?.country?.currency)}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </th:block>
</th:block>

<th:block th:fragment="documentation">
    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','documentation',productCategoryId)?.editable}">
        <div class="custom-row jc-end">
            <a th:if="${editable}" shiro:hasPermission="loan:update:file:validation" href="javascript:;" class="btn btn-circle btn-default principal-button-action" th:onclick="'validateAllUserFiles('+${userFilesObject.loanApplicationId}+', \'#documentation_tab\')'">
                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/validar_todos.svg" alt="" class="custom-icono-svg"/>
                Verificar todos
            </a>
            <a th:if="${editable}" shiro:hasPermission="loan:update:file:missing_documentation" href="javascript:;" class="btn btn-circle btn-default ml-1 principal-button-action" th:onclick="'requestMissingDocumentation('+${userFilesObject.loanApplicationId}+', \'#documentation_tab\')'">
                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/solicitar_documentacion.svg" alt="" class="custom-icono-svg"/>
                Solicitar documentación faltante
            </a>
        </div>
        <div class="row d-inline-block"
             th:if="${personPrincipalOcupationalInfo != null or loanApplication.selectedEntityId == T(com.affirm.common.model.catalog.Entity).RIPLEY}"
             th:with="requiredDocuments = ${@loanApplicationService.getRequiredDocumentsIdsByLoanApplication(loanApplication)}"
        >

            <div th:each="userFileType : ${@catalogService.getUserFileTypes()}" th:remove="tag">
                <div th:with="userFiles = ${@userService.getUserFileByType(userFilesObject.userFileList, userFileType.id)}" th:remove="tag">

                    <div class="card-image-evaluation col-md-4" th:if="${#lists.contains(requiredDocuments, userFileType.id)}">
                        <div class="card-title mb-1 d-flex jc-sb">
                            <th:block th:text="${userFileType.type}"></th:block>
                            <a href="javascript:;" th:if="${editable}" class="btn btn-circle btn-default pull-right" shiro:hasPermission="loan:update:file:upload" th:onclick="'openUserFileUploadModal('+${userFileType.id}+', '+
                                                       ${userFilesObject.loanApplicationId}+', '+${person.userId}+',' +
                                                       ${#lists.size(userFiles)} + ', \'#documentation_tab\' )'">+</a>
                        </div>
                        <th:block th:switch="${#lists.isEmpty(userFiles)}">
                            <div class="w-100 container-image" th:case="true">
                                No se ha subido ningún archivo
                            </div>
                            <div th:case="false" th:remove="tag">
                                <div class="w-100 container-image"  th:each="file : ${userFiles}" th:id="'container_'+${file?.id}">
                                    <img class="img-responsive img-response-custom" data-angle="0" th:id="'file_'+${file?.id}" th:onload="'loadedImage(\'#options_'+${file?.id}+'\')'" th:src="${file.isDocumentFile() == false ? @fileService.generateUserFileUrl(file.userId, file.id, file.fileName, #httpServletRequest, false) : 'https://solven-public.s3.amazonaws.com/img/document-extranet.png'}" alt="" th:classappend="${ file.isDocumentFile() == true ? 'object-fit-contain' : ''}"/>
                                    <div class="image-opt" th:id="'options_'+${file?.id}" style="display: none;align-items: end;">
                                        <a th:if="${editable}" shiro:hasPermission="loan:update:file:validation" href="javascript:;" class="pull-right" th:onclick="'validateUserFile('+${file?.id}+',true)'">
                                            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/aprobar.svg"  alt="" th:classappend="${ file.isDocumentFile() == true ? 'd-none-element' : ''}"/>
                                        </a>
                                        <a th:if="${editable}" shiro:hasPermission="loan:update:file:validation" href="javascript:;" class="pull-right"  th:onclick="'invalidateUserFile('+${file?.id}+',false,'+${loanApplication?.id}+')'" th:classappend="${ file.isDocumentFile() == true ? 'd-none-element' : ''}">
                                            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/rechazar.svg" alt=""/>
                                        </a>
                                        <a th:if="${editable}" shiro:hasPermission="loan:update:file:rotate" href="javascript:;" class="pull-right" th:onclick="'rotateImage(\'' + ${@fileService.generateUserFileEncrypt(file?.userId, file?.fileName, file?.id)} + '\', \'R\' , \'#documentation_tab\')'" th:classappend="${ file.isDocumentFile() == true ? 'd-none-element' : ''}">
                                            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/girar.svg" alt=""/>
                                        </a>
                                        <th:block th:if="${!file.isDocumentFile()}">
                                            <a href="javascript:;" class="pull-right" th:onclick="'downloadUserFile(\'#file_' + ${file?.id} + '\', \'' + ${file?.fileName} + '\')'">
                                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/descargar_f.svg" alt=""/>
                                            </a>
                                        </th:block>
                                        <th:block th:unless="${!file.isDocumentFile()}">
                                            <a href="javascript:;" class="pull-right" th:onclick="'downloadUserFileDoc(\'' + ${@fileService.generatePublicUserFileUrl(file?.id, false)} + '\', \'' +  ${file?.fileName} + '\')'">
                                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/descargar_f.svg" alt=""/>
                                            </a>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </th:block>
                    </div>

                </div>
            </div>
        </div>

        <div id="uploadUserFileModal" class="modal fade" th:classappend="'upload-modal-' + ${loanApplication?.id}">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="smaller">Tama&ntilde;o m&aacute;ximo <span
                                th:text="${@configuration.MAX_UPLOAD_FILE_SIZE_MB() + 'mb'}"></span>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div id="uploadUserFile" class="dropzone"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default"
                                onclick="closeUserFileUploadModal(this, '#documentation_tab')">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <script th:inline="javascript">
        /*<![CDATA[*/

        replaceImgSvgToSvgElement();

        var uploadedSuccess = false;

        function openUserFileUploadModal(userFileType, loanApplicationId, userId, numberFiles, clickElementAfter) {
            var url = /*[[ @{/file/userFile} ]]*/;
            uploadedSuccess = false;

            var $uploadUserFileModal = $('.upload-modal-' + loanApplicationId);

            $uploadUserFileModal.find('.modal-body').html('');
            $uploadUserFileModal.find('.modal-body').append("<div id=\"uploadUserFile\" class=\"dropzone\"></div>")

            var dropzone = $uploadUserFileModal.find(".dropzone").dropzone({
                url: url,
                params: {
                    userId: userId,
                    loanApplicationId: loanApplicationId,
                    userFileType: userFileType,
                    numberFiles: numberFiles
                },
                paramName: 'file',
                maxFilesize: 10, // MB
                maxFiles: 2, //HU1
                dictDefaultMessage: 'Arrastra una imagen aquí para subirla, o haz click para seleccionar una.',
                acceptedFiles: 'image/*,application/pdf',
                headers: addCsrfToJsonHeaders({
                    'x-request-sender-type': 'ajax'
                }),
                init: function () {
                    /*HU1 Begin*/
                    this.on("addedfile", function (file) {
                    });
                    /*HU1 End*/
                    this.on("success", function () {
                        uploadedSuccess = true;
                    });
                    this.on('error', function (error) {
                        swal({
                            title: '',
                            text: error.message,
                            type: "warning",
                            confirmButtonText: "Entendido",
                            closeOnConfirm: false
                        });
                    })
                }
            });

            $uploadUserFileModal.modal({
                backdrop: 'static',
                keyboard: false
            });
        }

        function closeUserFileUploadModal(button, clickElementAfter) {
            $(button).closest('.modal').modal('hide');
            if (uploadedSuccess) {
                setTimeout(function () {
                    if(clickElementAfter) $(clickElementAfter).click();
                }, 300)
            }
        }

        // Initialize the Image Visualizator
        $('*[data-toggle="lightbox"]').unbind().click(function (event) {
            event.preventDefault();

            $(this).ekkoLightbox({
                onShown: function () {
                    console.log('Checking our the events huh?');
                },
                onHidden: function () {

                }
            });
        });

        /*]]>*/
    </script>

</th:block>

<th:block th:fragment="identityValidation">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','identityValidation',productCategoryId)?.editable}">
        <th:block th:if="${!identityValidationPainter.hasIdentityValidationResult()}">
            La persona no tiene resultados
        </th:block>

        <th:block th:unless="${!identityValidationPainter.hasIdentityValidationResult()}">

            <div class="custom-row mt-2 mb-10px">
                <div class="col-md-2 pl-0">
                    <div class="card-title">Estado</div>
                    <span class="card-title-description">
                      <th:block th:if="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.approved}">
                         Aprobado
                      </th:block>
                      <th:block th:unless="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.approved}">
                         <th:block th:if="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status}">
                            <th:block th:switch="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status}">
                               <th:block th:case="${T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_MANUAL_REVISION_WAITING_APPROVAL}">
                                  Revisión manual
                               </th:block>
                               <th:block th:case="${T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_MANUAL_REVISION}">
                                  Revisión manual
                               </th:block>
                               <th:block th:case="${T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_NO_PARAM}">
                                  No se ha configurado parámetro.
                               </th:block>
                            </th:block>
                         </th:block>
                         <th:block th:unless="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status}">
                            Rechazado
                         </th:block>
                      </th:block>
                   </span>
                </div>
                <div class="col-md-2 pl-0">
                    <div class="card-title">Fecha procesamiento</div>
                    <span class="card-title-description" th:text="${@utilService.datetimeShortFormat(identityValidationPainter?.getProcesingDate())}"></span>
                </div>
                <th:block shiro:hasPermission="loan:update:identity:validation" th:if="${identityValidationPainter.getShowValidationStatusChangeButton()}">
                    <div class="col-md-1 pl-0 ml-auto" th:if="${editable}">
                        <div class="dropdown ml-auto" style="position: absolute;right: 0px;">
                            <button class="btn btn-default btn-circle dropdown-toggle d-flex" type="button" data-toggle="dropdown">
                                Acciones
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/select_arrow.svg" class="ml-auto pull-right" alt="" style="width: 12px"/>
                            </button>
                            <ul class="dropdown-menu pull-right" role="menu">
                                <li><a href="javascript:;" th:onclick="'identityManualApproval('+${loanId}+',true,\''+${identityValidationPainter.getIdentityValidationType()}+'\')'">Aprobar</a></li>
                                <li th:if="${loanApplication?.getApprovalValidationById(T(com.affirm.common.model.catalog.ApprovalValidation).IDENTIDAD)?.status == T(com.affirm.common.model.transactional.LoanApplicationApprovalValidation).CUSTOM_STATUS_MANUAL_REVISION}"><a href="javascript:;"  th:onclick="'identityManualApproval('+${loanId}+ ',false,\''+${identityValidationPainter.getIdentityValidationType()}+'\')'">Rechazar</a></li>
                            </ul>
                        </div>
                    </div>
                </th:block>
            </div>
            <div class="custom-row mt-0 mb-10px">
                <div class="col-md-6 pl-0">
                    <div class="col-md-12 pl-0">
                        <div class="card-title">Comparación de rostros</div>
                        <div class="card-title-description">
                            <th:block th:if="${identityValidationPainter.hasValidationData()}">
                                <div th:if="${identityValidationPainter?.rekognitionReniecData?.getSelfieDocDataValidationFaceMatching() != null}">
                                    <th:block th:replace="this :: detailIcon(approved=${identityValidationPainter?.rekognitionReniecData?.getSelfieDocDataValidationFaceMatching().approved})"></th:block>
                                    Selfie - Documentación <th:block th:if="${identityValidationPainter?.rekognitionReniecData?.faceMatching}">(<th:block th:text="${@utilService.customDoubleFormatWithoutRounding(identityValidationPainter?.rekognitionReniecData?.faceMatching,2)}"></th:block>%)</th:block>
                                </div>
                                <div th:if="${identityValidationPainter?.rekognitionReniecData?.getDocReniecDataValidationFaceMatching() != null}">
                                    <th:block th:replace="this :: detailIcon(approved=${identityValidationPainter?.rekognitionReniecData?.getDocReniecDataValidationFaceMatching().approved})"></th:block>
                                    Documentación - Reniec <th:block th:if="${identityValidationPainter?.rekognitionReniecData?.docReniecFaceMatching}">(<th:block th:text="${@utilService.customDoubleFormatWithoutRounding(identityValidationPainter?.rekognitionReniecData?.docReniecFaceMatching,2)}"></th:block>%)</th:block>
                                </div>
                                <div th:if="${identityValidationPainter?.rekognitionReniecData?.getSelfieReniecDataValidationFaceMatching() != null}">
                                    <th:block th:replace="this :: detailIcon(approved=${identityValidationPainter?.rekognitionReniecData?.getSelfieReniecDataValidationFaceMatching().approved})"></th:block>
                                    Selfie - Reniec <th:block th:if="${identityValidationPainter?.rekognitionReniecData?.selfieReniecFaceMatching}">(<th:block th:text="${@utilService.customDoubleFormatWithoutRounding(identityValidationPainter?.rekognitionReniecData?.selfieReniecFaceMatching,2)}"></th:block>%)</th:block>
                                </div>
                            </th:block>
                            <th:block th:unless="${identityValidationPainter.hasValidationData()}">
                                <th:block th:if="${identityValidationPainter?.matiResult != null}">
                                    <th:block th:text="${@utilService.customDoubleFormatWithoutRounding(identityValidationPainter?.matiResult?.getScore(),2)}"></th:block><th:block th:if="${identityValidationPainter?.matiResult?.getScore() != null}">%</th:block>
                                </th:block>
                                <th:block th:unless="${identityValidationPainter?.matiResult != null}">
                                    <th:block th:if="${identityValidationPainter?.lastRekognition?.getLastRekognitionResult() != null}">
                                        <th:block th:text="${identityValidationPainter.lastRekognition?.getLastRekognitionResult()?.highSimilarity}"></th:block>
                                    </th:block>
                                    <th:block th:unless="${identityValidationPainter?.lastRekognition?.getLastRekognitionResult() != null}">
                                        <th:block th:if="${identityValidationPainter?.rekognitionProResult != null}">
                                            <th:block th:text="${identityValidationPainter.rekognitionProResult?.faceMatching}"></th:block>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </th:block>
                        </div>
                    </div>
                    <div class="col-md-12 pl-0 mt-10px">
                        <div class="card-title">Observaciones</div>
                        <div class="card-title-description">
                            <th:block th:if="${identityValidationPainter.hasValidationData()}">
                                <th:block th:if="${not #lists.isEmpty(identityValidationPainter.rekognitionReniecData?.getSelfieDocDataValidationsWhithoutFaceMatching())}">
                                    <div th:each="validationData : ${identityValidationPainter.rekognitionReniecData?.getSelfieDocDataValidationsWhithoutFaceMatching()}">
                                        <th:block th:replace="this :: detailIcon(approved=${validationData.approved})"></th:block>
                                        <th:block th:text="${validationData.getDescriptionByType('REKOGNITION_RENIEC','SELFIE_DOCUMENTATION',person?.documentType?.id)}"></th:block>
                                    </div>
                                </th:block>
                                <th:block th:if="${not #lists.isEmpty(identityValidationPainter.rekognitionReniecData?.getDocReniecDataValidationsWhithoutFaceMatching())}">
                                    <br/>
                                    <b>Documentación - Reniec</b>
                                    <div th:each="validationData : ${identityValidationPainter.rekognitionReniecData?.getDocReniecDataValidationsWhithoutFaceMatching()}">
                                        <th:block th:replace="this :: detailIcon(approved=${validationData.approved})"></th:block>
                                        <th:block th:text="${validationData.getDescriptionByType('REKOGNITION_RENIEC','DOCUMENTATION_RENIEC',person?.documentType?.id)}"></th:block>
                                    </div>
                                </th:block>
                                <th:block th:if="${not #lists.isEmpty(identityValidationPainter.rekognitionReniecData?.getSelfieReniecDataValidationsWhithoutFaceMatching())}">
                                    <br/>
                                    <b>Selfie - Reniec</b>
                                    <div th:each="validationData : ${identityValidationPainter.rekognitionReniecData?.getSelfieReniecDataValidationsWhithoutFaceMatching()}">
                                        <th:block th:replace="this :: detailIcon(approved=${validationData.approved})"></th:block>
                                        <th:block th:text="${validationData.getDescriptionByType('REKOGNITION_RENIEC','SELFIE_RENIEC',person?.documentType?.id)}"></th:block>
                                    </div>
                                </th:block>
                            </th:block>
                            <th:block th:unless="${identityValidationPainter.hasValidationData()}">
                                <th:block th:each="error : ${identityValidationPainter.matiResult?.getErrors()}">
                                    <th:block th:text="${error}"></th:block>
                                    <br/>
                                </th:block>
                                <th:block th:each="error : ${identityValidationPainter.rekognitionProResult?.getErrors()}">
                                    <th:block th:text="${error}"></th:block>
                                    <br/>
                                </th:block>
                                <th:block th:if="${identityValidationPainter.getIdentityApprovalValidationDisapprovalMessage() != null}">
                                    <th:block th:utext="${identityValidationPainter.getIdentityApprovalValidationDisapprovalMessage()}"></th:block>
                                    <br/>
                                </th:block>
                            </th:block>
                        </div>
                    </div>
                    <div class="col-md-12 pl-0 mt-10px">
                        <div class="custom-row">
                            <div class="col-md-4 pl-0" style="width: 34.5%">
                                <div class="card-title">Reniec</div>
                                <div class="card-title-description mb-3px"><b>Apellido paterno:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${identityValidationPainter?.reniecData?.ApellidoPaterno}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Apellido materno:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${identityValidationPainter?.reniecData?.ApellidoMaterno}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Nombres:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${identityValidationPainter?.reniecData?.Nombres}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Sexo:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${identityValidationPainter?.reniecData?.Sexo}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Estado civil:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${identityValidationPainter?.reniecData?.EstadoCivil}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Fecha de nacimiento:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${@utilService.dateFormat(identityValidationPainter?.reniecData?.getFechaNacimientoAsDate())}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Localidad:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${identityValidationPainter?.reniecData?.getLocalidad()}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Fecha de expedición:</b> <th:block th:if="${identityValidationPainter?.hasReniecResultData()}" th:text="${@utilService.dateFormat(identityValidationPainter?.reniecData?.getFechaExpedicionAsDate())}"></th:block> </div>
                            </div>
                            <div class="col-md-6 pl-0">
                                <div class="card-title">Documentación</div>
                                <div class="card-title-description mb-3px"><b>Apellido paterno:</b> <th:block th:text="${identityValidationPainter?.documentationData?.firstSurname}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Apellido materno:</b> <th:block th:text="${identityValidationPainter?.documentationData?.otherSurnames}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Nombres:</b> <th:block th:text="${identityValidationPainter?.documentationData?.personName}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Fecha de nacimiento:</b> <th:block th:text="${identityValidationPainter?.documentationData?.dateOfBirth}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Localidad:</b> <th:block th:text="${identityValidationPainter?.documentationData?.locality}"></th:block> </div>
                                <div class="card-title-description mb-3px"><b>Fecha de caducidad:</b> <th:block th:text="${identityValidationPainter?.documentationData?.documentExpirationDate}"></th:block> </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="col-md-6 pl-0">
                    <div class="row">
                        <div class="col-md-6 card-image-evaluation">
                            <div class="w-100 container-image">
                                <div class="card-title mb-1 d-flex jc-sb"> Selfie </div>
                                <div class="w-100 d-inline-block">
                                    <img class="img-responsive img-response-custom"
                                         th:src="${@fileService.generateUserFileUrl(selfie.userId, selfie.id, selfie.fileName, #httpServletRequest, false)}" alt="" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 card-image-evaluation">
                            <div class="w-100 container-image">
                                <div class="card-title mb-1 d-flex jc-sb"> Reniec </div>
                                <div class="w-100 d-inline-block">
                                    <img class="img-responsive img-response-custom" th:if="${identityValidationPainter?.hasReniecResultData()}"
                                         th:src="${@fileService.generateEntityWebServiceFileUrl(identityValidationPainter.loanApplicationId, identityValidationPainter.reniecData?.Foto, #httpServletRequest, false)}" alt="" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 card-image-evaluation">
                            <div class="w-100 container-image">
                                <div class="card-title mb-1 d-flex jc-sb"> DNI Frontal</div>
                                <div class="w-100 d-inline-block">
                                    <img class="img-responsive img-response-custom"
                                         th:src="${@fileService.generateUserFileUrl(dniMerge.userId, dniMerge.id, dniMerge.fileName, #httpServletRequest, false)}" alt="" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 card-image-evaluation">
                            <div class="w-100 container-image">
                                <div class="card-title mb-1 d-flex jc-sb"> DNI Posterior</div>
                                <div class="w-100 d-inline-block">
                                    <img class="img-responsive img-response-custom"
                                         th:src="${@fileService.generateUserFileUrl(dniBack.userId, dniBack.id, dniBack.fileName, #httpServletRequest, false)}" alt="" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>




        </th:block>



        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>

</th:block>

<th:block th:fragment="fraudAlert">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','fraudAlert',productCategoryId)?.editable}">
        <div class="custom-row d-flex">
            <div class="d-flex">
                <h6 class="fw-bold">Última ejecución:</h6>&nbsp;
                <span th:text="${@utilService.datetimeShortFormat(loanApplication.lastFraudAlertsBotRegisterDate)}"></span>
                &nbsp;
                <span class="label label-sm"
                      th:classappend="${loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_QUEUE || loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_RUNNING ? 'label-warning' : loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_SUCCESS ? 'label-success' : loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_FAIL ? 'label-danger' : 'label-default'}"
                      th:text="${loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_QUEUE || loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_RUNNING ? 'En cola' : loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_SUCCESS ? 'Ejecutado' : loanApplication.lastFraudAlertsBotStatusId == T(com.affirm.common.model.transactional.QueryBot).STATUS_FAIL ? 'Fallido' : 'Pendiente'}"></span>

            </div>
            <a th:if="${editable}" href="javascript:;" class="btn btn-circle btn-default ml-auto principal-button-action" shiro:hasPermission="loan:fraudAlerts:reject:all" th:onclick="'rejectAllLoanApplicationFraudAlerts('+${loanId}+',\'#fraud_alert_tab\')'">
                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/desestimar.svg" alt="" class="custom-icono-svg"/>
                Desestimar todas
            </a>
        </div>

        <div class="custom-row">
            <table class="table table-bordered custom-table-evaluation table-text-center fraud-alert-table">
                <thead class="grey-color-table">
                <tr>
                    <th style="width: 15%">Elemento de <br/> Alarma</th>
                    <th style="width: 12%">Código</th>
                    <th style="width: 45%">Descripción</th>
                    <th style="width: 15%"># Solicitudes relacionadas</th>
                    <th style="width: 13%">Acción</th>
                </tr>
                </thead>
                <tbody class="white-color">
                <tr th:each="loanApplicationFraudAlert,iter : ${groupedLoanApplicationFraudAlerts}" >
                    <td th:text="${loanApplicationFraudAlert?.fraudAlert?.fraudAlertElemnt}"></td>
                    <td th:text="${loanApplicationFraudAlert?.fraudAlert?.fraudAlertCode}"></td>
                    <td th:text="${loanApplicationFraudAlert?.fraudAlert?.fraudAlertDescription}" style="text-align: left !important;"></td>
                    <td th:text="${loanApplicationFraudAlert?.loanApplicationFraudAlertIds?.size()}"></td>
                    <td>
                        <button class="btn btn-default principal-button-action" th:if="${editable}" type="button" shiro:hasPermission="loan:fraudAlerts:reject" th:onclick="'rejectLoanApplicationFraudAlert('+${loanId}+','+${loanApplicationFraudAlert?.getLoanFraudAlertIdsAsJsonArray()}+',this)'">Desestimar</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>

</th:block>

<th:block th:fragment="bankAccount">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','bankAccount',productCategoryId)?.editable}">
        <script>
            replaceImgSvgToSvgElement();
        </script>

        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function(){
                let loanApplicationId = /*[[${loanId}]]*/null;
                let callApprovalMethod = /*[[${callApprovalMethod}]]*/null;
                $("#bank").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanApplicationId,'bank'],
                });
                $("#bankAccountNumber").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanApplicationId,'bankAccount'],
                });
                $("#cciCode").editableInputFn({
                    fn : updateFieldValueAndExecuteAction,
                    params: [loanApplicationId,'cciCode', callApprovalMethod ? 'auto_approval' : null],
                });

                $("#account_type").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanApplicationId,'bankAccountType'],
                });
            })
            /*]]>*/
        </script>

        <div class="custom-row">

            <div class="col-md-3 pl-0">
                <div class="card-title">Banco</div>
                <div class="input-material">
                    <select name="bank" id="bank" th:disabled="${!editable}">
                        <option th:value="${null}"></option>
                        <th:block  th:each="bank, iter : ${banks}">
                            <option th:value="${bank?.id}" th:text="${bank?.name}" th:selected="${bank?.id == bankAccount?.bank?.id} ? true : false"></option>
                        </th:block>
                    </select>
                </div>
            </div>

            <div class="col-md-3 pl-0">
                <div class="card-title">Número de cuenta</div>
                <div class="input-material">
                    <input th:disabled="${!editable}" type="text" id="bankAccountNumber" th:value="${bankAccount?.bankAccount}"/>
                </div>
            </div>

            <div class="col-md-3 pl-0">
                <div class="card-title">CCI</div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${bankAccount?.cciCode}" id="cciCode"/>
                </div>
            </div>

            <div class="col-md-3 pl-0">
                <div class="card-title">Tipo de cuenta</div>
                <div class="input-material">
                    <select name="account_type" th:disabled="${!editable}" th:value="${bankAccount?.bankAccountType}" id="account_type">
                        <option th:value="${null}"></option>
                        <option value="S" th:selected="${#strings.equals(bankAccount?.bankAccountType, 'S') ? true : false }">Cuenta de Ahorros</option>
                        <option value="C" th:selected="${#strings.equals(bankAccount?.bankAccountType, 'R') ? true : false }">Cuenta de Corriente</option>
                    </select>
                </div>
            </div>

        </div>
    </th:block>

</th:block>

<th:block th:fragment="notes">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','notes',productCategoryId)?.editable}">

        <script>
            replaceImgSvgToSvgElement();
        </script>

        <div class="custom-row" style="align-items: center">
            <th:block th:if="${#lists.isEmpty(notes)}">
                La solicitud no tiene notas
            </th:block>
            <a th:if="${editable}" href="javascript:;" shiro:hasPermission="loan:notes:update" class="btn btn-circle btn-default ml-auto pull-right principal-button-action" onclick="openRegisterNote(null,null,null)">
                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/agregar_nota.svg" alt="" class="custom-icono-svg"/>
                Agregar nota
            </a>
        </div>
        <div class="custom-row fl-column">
            <div class="col-md-12 pl-0" th:each="note, iter : ${notes}">
                <div class="note-title">Nota <th:block th:text="${iter.count}"></th:block></div>
                <table class="no-border custom-table-note">
                    <thead>
                    <tr>
                        <th class="pl-0" style="width: 15%">Usuario</th>
                        <th style="width: 15%">Fecha</th>
                        <th style="width: 70%">Nota</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td class="pl-0">
                            <th:block th:if="${note?.sysUserId}" th:text="${@sysUserBoService.getSysUserById(note?.sysUserId)?.getFullName()}"></th:block>
                            <th:block th:if="${note?.entityUserId}" th:text="${@userService.getUserEntityById(note?.entityUserId, #locale)?.getFullName()}"></th:block>
                        </td>
                        <td>
                            <th:block th:text="${@utilService.dateFormat(note?.registerDate)}"></th:block>
                            <br/>
                            <th:block th:text="${@utilService.hourFormat(note?.registerDate)}"></th:block>
                        </td>
                        <td>
                            <div class="input-material">
                                <input type="text" th:value="${note.comment}" th:id="'note_'+${note?.id}" th:disabled="${!editable or note?.entityUserId == null or note?.entityUserId != @entityExtranetService.getLoggedUserEntity().getId() ? true : false}"/>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="registerNoteModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-lightblue-header" style="padding: 1.5em">
                        <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                        <h4 style="text-align: left; font-weight: bold;">Agregar nota</h4>
                    </div>
                    <div class="modal-body">
                        <textarea id="txaNote" cols="30" class="w-100" rows="3" maxlength="500"></textarea>
                        <p>M&aacute;ximo de caracteres: <small id="sm-log">500</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn red" data-dismiss="modal">
                            Cerrar
                        </button>
                        <button type="button" class="btn green" id="createNoteSubmit" onclick="registerNoteModal()">
                            Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <script th:inline="javascript">
            /*<![CDATA[*/

            var selectedRegisterButton;
            var selectedNoteId;
            var selectedNoteOperatorId;

            $(document).on('click', '.note-add, .note-edit', function () {
                selectedRegisterButton = $(this);
            });

            $(document).ready(function(){
                let notes = /*[[ ${notes} ]]*/[];
                if(notes) notes.forEach(note=>{
                    $(`#note_${note.id}`).editableInputFn({
                        fn : editNoteModal,
                        params: [note.id,note.entityUserId],
                    });
                })
            })


            function openRegisterNote(comment,noteId, operatorId) {
                if(comment !== null) {
                    $('#registerNoteModal #txaNote').val(comment);
                }
                $('#registerNoteModal').modal({
                    backdrop: 'static',
                    keyboard: false
                });
                selectedNoteId = noteId;
                selectedNoteOperatorId = operatorId;
            }

            // TexT AREA CONTADOR
            $(document).on('keyup', "[maxlength]", function (e) {
                var este = $(this),
                    maxlength = este.attr('maxlength'),
                    maxlengthint = parseInt(maxlength),
                    textoActual = este.val(),
                    currentCharacters = este.val().length,
                    remainingCharacters = maxlengthint - currentCharacters,
                    espan = $('#sm-log');
                // Detectamos si es IE9 y si hemos llegado al final, convertir el -1 en 0 - bug ie9 porq. no coge directamente el

                espan.html(remainingCharacters);
            });

            function registerNoteModal() {
                if($('#txaNote').val() !== '') {
                    var button = selectedRegisterButton;
                    defaultAjax({
                        url: /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/person/__${loanApplication.personId}__/application/__${loanApplication.id}__/notes} ]]*/,
                        data: {
                            noteId: selectedNoteId,
                            operatorId: selectedNoteOperatorId,
                            message: $('#txaNote').val()
                        },
                        type: 'POST',
                        success: function () {
                            openSuccessProcessNotification(null, null);
                            $('#txaNote').val('');
                            $(`#registerNoteModal`).modal('hide');
                            $('body').removeClass('modal-open');
                            $('.modal-backdrop').remove();
                            selectedRegisterButton = undefined;
                            selectedNoteId = undefined;
                            selectedNoteOperatorId = undefined;
                            $("#notes_tab").click();
                        }
                    });
                }
            }

            function editNoteModal(message, noteId,operatorId) {
                return new Promise((resolve,reject) => {
                    if(message && message.length) {
                        var button = selectedRegisterButton;
                        defaultAjax({
                            url: /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/person/__${loanApplication.personId}__/application/__${loanApplication.id}__/notes} ]]*/,
                            data: {
                                noteId: noteId,
                                operatorId: operatorId,
                                message: message
                            },
                            type: 'POST',
                            success: function () {
                                resolve(true)
                            },
                            error: function () {
                                reject();
                            }
                        });
                    }
                    else reject();
                })

            }

            /*]]>*/
        </script>

    </th:block>

</th:block>

<th:block th:fragment="interaction">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','interaction',productCategoryId)?.editable}">
        <div class="custom-row fl-column" >
            <th:block th:if="${#lists.isEmpty(interactionsParam)}">
                No se han encontrado interacciones
            </th:block>
            <th:block th:unless="${#lists.isEmpty(interactionsParam)}">
                <th:block  th:each="interaction,iter : ${interactionsParam}">
                    <th:block th:if="${interaction instanceof T(com.affirm.common.model.transactional.PersonInteraction)}">
                        <div class="col-md-12 pl-0" style="margin-bottom: 3rem">
                            <div class="note-title">Interacción <th:block th:text="${iter.count}"></th:block> </div>
                            <div class="d-flex al-start">
                                <div class="col-md-1 pl-0">
                                    <div class="card-title">Tipo</div>
                                    <span class="card-title-description" th:text="${interaction?.interactionType?.type}"></span>
                                </div>
                                <div class="col-md-2 pl-0">
                                    <div class="card-title">Contenido</div>
                                    <span class="card-title-description" th:text="${interaction?.interactionContent?.content}"></span>
                                </div>
                                <div class="col-md-1 pl-0">
                                    <div class="card-title">Fecha</div>
                                    <span class="card-title-description">
                                <th:block th:text="${@utilService.dateFormat(interaction?.registerDate)}" th:attr="data-order=${@utilService.datetimeYearFirstFormat(interaction?.registerDate)}"></th:block>
                                <br/>
                                <th:block th:text="${@utilService.hourFormat(interaction?.registerDate)}" th:attr="data-order=${@utilService.hourFormat(interaction?.registerDate)}"></th:block>
                            </span>
                                </div>
                                <div class="col-md-2 pl-0">
                                    <div class="card-title">Solicitud/ Crédito</div>
                                    <span class="card-title-description">
                                <th:block th:if="${interaction?.loanApplicationCode != null}"
                                          th:text="${interaction?.loanApplicationCode}"></th:block>
                                <th:block th:if="${interaction?.creditCode != null}"
                                          th:text="${interaction?.creditCode}"></th:block>
                            </span>
                                </div>
                                <div class="col-md-2 pl-0">
                                    <div class="card-title">Destino</div>
                                    <span class="card-title-description" th:text="${interaction?.destination}"></span>
                                </div>
                                <!--                        <div class="col-md-2 pl-0">-->
                                <!--                            <div class="card-title">Con copia</div>-->
                                <!--                            <span th:text="${interaction?.getCcMailsReadable()}"></span>-->
                                <!--                        </div>-->
                                <div class="col-md-2 pl-0">
                                    <div class="card-title">Asunto</div>
                                    <span class="card-title-description" th:text="${interaction?.subject}"></span>
                                </div>
                            </div>
                            <div class="d-flex al-start">
                                <div class="col-md-3 pl-0">
                                    <div class="card-title">Historial</div>
                                    <span class="card-title-description">
                                <th:block th:each="stat : ${interaction?.stats}">
                                    <th:block th:text="${@utilService.datetimeShortFormat(stat?.eventDate)} + ' - ' + ${stat?.event}"></th:block>
                                    <br/>
                                </th:block>
                            </span>
                                </div>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </th:block>
        </div>

        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>

</th:block>

<th:block th:fragment="sbs">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'request','sbs',productCategoryId)?.editable}">
        <script>
            function showSBSTab(tab){
                switch (tab){
                    case 'titular':
                        $("#select-sbs-tab").find("a").removeClass("active");
                        $("#titutar-sbs-button").addClass("active");
                        $("#titular-tab").css("display","flex");
                        $("#conyuge-tab").css("display","none");
                        break;
                    case 'conyuge':
                        $("#select-sbs-tab").find("a").removeClass("active");
                        $("#conyuge-sbs-button").addClass("active");
                        $("#conyuge-tab").css("display","flex");
                        $("#titular-tab").css("display","none");
                        break;
                }
            }
        </script>

        <div class="custom-row d-flex">
            <div class="d-flex button-toggle-group" id="select-sbs-tab">
                <a href="javascript:;" class="btn btn-default active" id="titutar-sbs-button" onclick="showSBSTab('titular')">
                    Titular
                </a>
                <a href="javascript:;" class="btn btn-default" id="conyuge-sbs-button" onclick="showSBSTab('conyuge')">
                    Esposo(a)
                </a>
            </div>
        </div>

        <div class="custom-row" id="titular-tab">
            <th:block th:switch="${personCountry}">
                <th:block th:case="${T(com.affirm.common.model.catalog.CountryParam).COUNTRY_ARGENTINA}">
                    <th:block th:replace="this :: sbsTableArgentina(data=${bcraResult?.deudores})"></th:block>
                </th:block>
                <th:block th:case="${T(com.affirm.common.model.catalog.CountryParam).COUNTRY_PERU}">
                    <th:block th:replace="this :: sbsTablePeru(data=${rccData?.financialSystems},partner=${false})"></th:block>
                </th:block>
            </th:block>
        </div>

        <div class="custom-row" id="conyuge-tab" style="display: none">
            <th:block th:switch="${personCountry}">
                <th:block th:case="${T(com.affirm.common.model.catalog.CountryParam).COUNTRY_PERU}">
                    <th:block th:replace="this :: sbsTablePeru(data=${partnerRccData?.financialSystems},partner=${true})"></th:block>
                </th:block>
            </th:block>
        </div>

        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>

</th:block>

<th:block th:fragment="sbsTablePeru">
    <table class="table table-bordered custom-table-evaluation table-text-center sbs-table">
        <thead class="grey-color-table">
        <tr>
            <th>#</th>
            <th>Período</th>
            <th>Calificación</th>
            <th>Deuda Total</th>
            <th>Deuda Total <br/> s/ hipotecario</th>
            <th>Cuota Total</th>
            <th>Cuota Total <br/> s/ hipotecario</th>
            <th>Cantidad de <br/> entidades</th>
            <th>Días de atraso</th>
            <th>Detalle entidad</th>
        </tr>
        </thead>
        <tbody class="white-color">
        <th:block th:each="row,iter : ${data}">
            <tr>
                <td th:text="${iter.count}"></td>
                <td th:text="${@utilService.startDateFormat(row?.periodDate)}"></td>
                <td th:text="${row?.calification}"></td>
                <td th:text="${@utilService.doubleMoneyFormat(row?.reportedDebtSoles)}"></td>
                <td th:text="${@utilService.doubleMoneyFormat(row?.reportedDebtSolesWOmortgage)}"></td>
                <td th:text="${@utilService.doubleMoneyFormat(row?.estimatedFeeSoles)}"></td>
                <td th:text="${@utilService.doubleMoneyFormat(row?.estimatedFeeSolesWOmortgage)}"></td>
                <td th:text="${row?.entitiesNumber}"></td>
                <td th:text="${row?.arrears}"></td>
                <td> <button th:id="'button_sbs_detail_'+${iter.count}" th:onclick="'showOrHideDetail(\'#sbs_detail_'+${iter.count}+'\', \'#button_sbs_detail_'+${iter.count}+'\','+${partner}+')'" class="btn btn-circle">+</button></td>
            </tr>
            <tr th:id="'sbs_detail_'+${iter.count}" style="display: none">
                <td colspan="11" class="pa-0" style="padding: 0px 0px !important;">
                    <table class="white-color sbs-detail">
                        <thead class="white-color">
                        <tr>
                            <th>Entidad</th>
                            <th>Tipo de deuda</th>
                            <th>Clasificación</th>
                            <th>Deuda Total</th>
                            <th>Días de atraso</th>
                            <th>Calificación</th>
                        </tr>
                        </thead>
                        <tbody class="white-color">
                        <tr th:each="detail, iterD : ${row?.financialSystemDetails}">
                            <td th:text="${detail?.shortName}"></td>
                            <td th:text="${detail?.debtType}"></td>
                            <td th:text="${detail?.classification}"></td>
                            <td th:text="${@utilService.doubleMoneyFormat(detail?.reportedDebtSoles)}"></td>
                            <td th:text="${detail?.arrears}"></td>
                            <td th:text="${detail?.calification}"></td>
                        </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </th:block>
        </tbody>
    </table>
    <script>
        function showOrHideDetail(id,button,isPartner){
            let element = $((isPartner ? '#conyuge-tab ' : '#titular-tab ') + id);
            let elementButton = $((isPartner ? '#conyuge-tab ' : '#titular-tab ') + button);
            if(element.is(":visible")){
                element.hide();
                elementButton.text("+")
            }
            else{
                element.show();
                elementButton.text("-")
            }
        }
    </script>

    <script>
        replaceImgSvgToSvgElement();
    </script>
</th:block>

<th:block th:fragment="sbsTableArgentina">
    <table class="table-striped table-bordered custom-table-evaluation align-left">
        <thead>
        <tr>
            <th>#</th>
            <th>Denominacion deudor</th>
            <th>Entidad</th>
            <th>Periodo</th>
            <th>Situacion</th>
            <th>Monto</th>
            <th>Dias retraso</th>
            <th>Observaciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="row,iter : ${data}">
            <td th:text="${iter.count}"></td>
            <td>---</td>
            <td>---</td>
            <td>---</td>
            <td>---</td>
            <td>---</td>
            <td>---</td>
            <td>---</td>
        </tr>
        </tbody>
    </table>
</th:block>

<th:block th:fragment="phoneVerification">
    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapsePhoneVerification" th:onclick="'getPhoneVerificationData(' + ${loanId} + ')'">
            <h6 class="panel-title">
                Verificación telefónica
            </h6>
        </div>
        <div id="collapsePhoneVerification" class="panel-collapse collapse">
            <div class="panel-body">
                <th:block th:if="${phoneVerificationData}">
                    <th:block th:replace="this :: phoneVerificationData"></th:block>
                </th:block>
                <th:block th:unless="${phoneVerificationData}">
                    <th:block th:replace="this :: loading"></th:block>
                </th:block>
            </div>
        </div>
    </div>

    <script>
        replaceImgSvgToSvgElement();
    </script>
</th:block>

<th:block th:fragment="phoneVerificationData">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'phoneVerification',productCategoryId)?.editable}">
        <div class="custom-row fl-column">
            <h5 class="h5 fw-bold">Solicitante</h5>
            <table class="table table-bordered custom-table-evaluation align-left" style="margin-left: 3%; width: 97%">
                <thead class="grey-color-table">
                <tr>
                    <th style="width: 20%;">Nombre</th>
                    <th style="width: 15%">Teléfono</th>
                    <th style="width: 8%">Tipo</th>
                    <th style="width: 15%">Número documento</th>
                    <th>Estado</th>
                    <th style="width: 10%"></th>
                    <th style="width: 10%"></th>
                </tr>
                </thead>
                <tbody class="white-color">
                <tr>
                    <td th:text="${phoneVerificationData?.name}"></td>
                    <td>
                        <div class="input-material">
                            <input type="text" th:disabled="${!editable}" th:value="${phoneVerificationData?.phone}" id="phoneNumberVerificationData"/>
                        </div>
                    </td>
                    <td th:text="${phoneVerificationData?.documentType?.name}"></td>
                    <td th:text="${phoneVerificationData?.documentNumber}"></td>
                    <td>
                        <div class="dropdown" th:if="${editable}">
                            <button class="btn btn-default btn-circle dropdown-toggle d-flex" type="button" data-toggle="dropdown">
                                <th:block th:text="${phoneVerificationData?.action != null ? phoneVerificationData?.action?.trackingAction : 'Acciones'}"></th:block>
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/select_arrow.svg" class="ml-auto pull-right" alt="" style="width: 12px"/>
                            </button>
                            <ul class="dropdown-menu pull-left" role="menu">
                                <li><a href="javascript:;" th:onclick="'registerContactResult('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).PHONE_VERIFICATION_CONTACTED}+',null,null,null,null)'">Contacto</a></li>
                                <li class="dropdown-submenu pull-left w-100">
                                    <a tabindex="-1" href="javascript:;">No contacto</a>
                                    <ul class="dropdown-menu">
                                        <li><a href="javascript:;" th:onclick="'registerContactResult('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).PHONE_VERIFICATION_NO_RESPONSE}+',null,null,null,null)'">No contesta</a></li>
                                        <li><a href="javascript:;" th:onclick="'registerContactResult('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).PHONE_VERIFICATION_WRONG_NUMBER}+',null,null,null,null)'">Número equivocado</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </td>
                    <td>
                        <a th:if="${editable}" href="javascript:;" shiro:hasPermission="loan:contactResul:uploadTrackingCall" class="btn btn-circle btn-default principal-button-action ml-auto pull-right" th:onclick="'openUserFileCallUploadModal('+${loanId}+')'">
                            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/cargar-llamada.svg" alt="" class="custom-icono-svg"/>
                            Cargar llamada
                        </a>
                    </td>
                    <td>
                        <a href="javascript:;" class="btn btn-circle btn-default ml-auto pull-right principal-button-action"
                           th:id="'file_'+${phoneVerificationData?.userFile?.id}"
                           th:src="${@fileService.generateUserFileUrl(phoneVerificationData?.userFile?.userId, phoneVerificationData?.userFile?.id, phoneVerificationData?.userFile?.fileName, #httpServletRequest, true)}"
                           th:onclick="'downloadUserFile(\'#file_' + ${phoneVerificationData?.userFile?.id} + '\', \'' + ${phoneVerificationData?.userFile?.fileName} + '\')'" th:if="${phoneVerificationData?.userFile != null ? true : false}">
                            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/descargar_g.svg" alt="" class="custom-icono-svg"/>
                            Descargar llamada
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="custom-row fl-column">
            <h5 class="h5 fw-bold">Referencias</h5>
            <table class="table table-bordered custom-table-evaluation align-left">
                <thead class="grey-color-table">
                <tr>
                    <th style="width: 3%">#</th>
                    <th style="width: 20%">Nombre</th>
                    <th style="width: 15%">Teléfono</th>
                    <th style="width: 13%">Parentesco</th>
                    <th style="width: 8%">Tipo</th>
                    <th style="width: 15%">Número documento</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody class="white-color">
                <tr th:each="referral, iter : ${phoneVerificationData?.referrals}" class="white-color custom-td">
                    <td th:text="${iter.count}"></td>
                    <td>
                        <div class="input-material w-90 text-left">
                            <input type="text" th:disabled="${!editable}" th:value="${referral?.fullName}" th:id="'referral_name_'+${referral?.id}"/>
                        </div>
                    </td>
                    <td>
                        <div class="input-material w-90 text-left">
                            <input type="text" th:disabled="${!editable}" th:value="${referral?.phoneNumber}" th:id="'referral_phone_'+${referral?.id}"/>
                        </div>
                    </td>
                    <td>
                        <div class="input-material w-90 text-left">
                            <select name="" th:id="'referral_relationship_'+${referral?.id}" th:disabled="${!editable}">
                                <option th:each="relationship : ${@catalogService.getRelationships(#locale)}"
                                        th:selected="${referral?.relationship?.id == relationship?.id} ? true : false"
                                        th:value="${relationship.id}"
                                        th:text="${relationship.relationship}"></option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <div class="input-material w-90 text-left">
                            <select name="" th:disabled="${!editable}" class="" th:id="'referral_document_type_'+${referral?.id}" th:value="${referral?.documentType != null ? referral?.documentType?.id : ''}">
                                <th:block th:each="identityDocumentType : ${@catalogService.getIdentityDocumentTypeByCountry(phoneVerificationData?.countryId, false)}">
                                    <option
                                            th:value="${identityDocumentType.id}"
                                            th:text="${identityDocumentType.name}"></option>
                                </th:block>
                            </select>
                        </div>
                    </td>
                    <td>
                        <div class="input-material w-90 text-left">
                            <input th:disabled="${!editable}" type="text" th:value="${referral?.documentNumber}" th:id="'referral_document_number_'+${referral?.id}"/>
                        </div>
                    </td>
                    <td>
                        <div class="w-90">
                            <div class="dropdown" th:if="${editable}" shiro:hasPermission="loan:contactResult:register">
                                <button class="btn btn-default btn-circle dropdown-toggle d-flex" type="button" data-toggle="dropdown">
                                    <th:block th:text="${referral?.getLastTrackingAction() != null ? referral?.getLastTrackingAction()?.trackingAction : 'Acciones'}"></th:block>
                                    <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/select_arrow.svg" class="ml-auto pull-right" alt="" style="width: 12px"/>
                                </button>
                                <ul class="dropdown-menu pull-left" role="menu">
                                    <li><a href="javascript:;" th:onclick="'registerContactResult('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).PHONE_VERIFICATION_CONTACTED_REFERRAL}+',null,null,null,'+${referral?.id}+')'">Contacto</a></li>
                                    <li class="dropdown-submenu pull-left w-100">
                                        <a tabindex="-1" href="javascript:;">No contacto</a>
                                        <ul class="dropdown-menu">
                                            <li><a href="javascript:;" th:onclick="'registerContactResult('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).PHONE_VERIFICATION_NO_RESPONSE_REFERRAL}+',null,null,null,'+${referral?.id}+')'">No contesta</a></li>
                                            <li><a href="javascript:;" th:onclick="'registerContactResult('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).PHONE_VERIFICATION_WRONG_NUMBER_REFERRAL}+',null,null,null,'+${referral?.id}+')'">Número equivocado</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/

            function editReferralInfo(value, referralId, field) {
                let urlReferral =  /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/referral/}]]*/null;
                return new Promise((resolve,reject) => {
                    if(value && value.length) {
                        defaultAjax({
                            url: urlReferral+field,
                            data: {
                                value: value,
                                referralId: referralId,
                                field: field
                            },
                            type: 'POST',
                            success: function () {
                                resolve(true)
                            },
                            error: function () {
                                reject();
                            }
                        });
                    }
                    else reject();
                })

            }

            $(document).ready(function(){

                let loanAppId = /*[[${loanId}]]*/null;

                $("#phoneNumberVerificationData").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'phoneNumber'],
                });

                let referrals = /*[[ ${phoneVerificationData?.referrals} ]]*/[];

                if(referrals) referrals.forEach(referral=>{

                    $(`#referral_name_${referral.id}`).editableInputFn({
                        fn : editReferralInfo,
                        params: [referral.id,'fullName'],
                    });

                    $(`#referral_phone_${referral.id}`).editableInputFn({
                        fn : editReferralInfo,
                        params: [referral.id,'phoneNumber'],
                    });

                    $(`#referral_relationship_${referral.id}`).editableInputFn({
                        fn : editReferralInfo,
                        params: [referral.id,'relationship'],
                    });

                    $(`#referral_document_type_${referral.id}`).editableInputFn({
                        fn : editReferralInfo,
                        params: [referral.id,'documentType'],
                    });

                    $(`#referral_document_number_${referral.id}`).editableInputFn({
                        fn : editReferralInfo,
                        params: [referral.id,'documentNumber'],
                    });

                })

                $('#trackingCallUploader').on('change', function (event) {
                    event.preventDefault();
                    if ($(this).val().replace(/C:\\fakepath\\/i, '') != '') {
                        var data = new FormData();
                        data.append("trackingCall", $('#trackingCallUploader')[0].files[0]);
                        data.append("loanId", /*[[${loanId}]]*/null);

                        console.log(data);
                        defaultAjax({
                            url:  /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/loan/uploadTrackingCall}]]*/null,
                            type: 'POST',
                            data: data,
                            cache: false,
                            processData: false,
                            contentType: false,
                            success: function (data) {
                                location.reload();
                            },
                            error: function () {

                            }
                        });
                    }

                });
            })
            /*]]>*/
        </script>

        <div id="uploadUserFileModalCall" class="modal fade" th:classappend="'upload-modal-call-' + ${loanApplication?.id}">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="smaller">Tama&ntilde;o m&aacute;ximo <span
                                th:text="${@configuration.MAX_UPLOAD_FILE_SIZE_MB() + 'mb'}"></span>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div id="uploadUserFileCall" class="dropzone"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default"
                                th:onclick="'closeUserFileCallUploadModal('+${loanId}+')'">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            var uploadedCallSuccess = false;

            function openUserFileCallUploadModal(loanApplicationId) {
                uploadedCallSuccess = false;

                let $uploadUserFileCallModal = $("#uploadUserFileModalCall");

                console.log($uploadUserFileCallModal);
                $uploadUserFileCallModal.find('.modal-body').html('');
                $uploadUserFileCallModal.find('.modal-body').append("<div id=\"uploadUserFileCall\" class=\"dropzone\"></div>")

                var dropzone = $uploadUserFileCallModal.find(".dropzone").dropzone({
                    url: /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/loan/uploadTrackingCall}]]*/null,
                    params: {
                        loanId: loanApplicationId,
                    },
                    paramName: 'trackingCall',
                    maxFilesize: /*[[${@configuration.MAX_UPLOAD_FILE_SIZE_MB()}]]*/, // MB
                    maxFiles: 2, //HU1
                    dictDefaultMessage: 'Arrastra un archivo aquí para subirla, o haz click para seleccionar uno.',
                    acceptedFiles: 'audio/mpeg,audio/mp3',
                    headers: addCsrfToJsonHeaders({
                        'x-request-sender-type': 'ajax'
                    }),
                    init: function () {
                        /*HU1 Begin*/
                        this.on("addedfile", function (file) {
                        });
                        /*HU1 End*/
                        this.on("success", function () {
                            uploadedCallSuccess = true;
                        });
                        this.on('error', function (error) {
                            swal({
                                title: '',
                                text: error.message,
                                type: "warning",
                                confirmButtonText: "Entendido",
                                closeOnConfirm: false
                            });
                        })
                    }
                });

                $uploadUserFileCallModal.modal({
                    backdrop: 'static',
                    keyboard: false
                });
            }

            function closeUserFileCallUploadModal(loanId) {
                $("#uploadUserFileModalCall .modal-footer button").closest('.modal').modal('hide');
                if (uploadedCallSuccess) {
                    setTimeout(function () {
                        getPhoneVerificationData(loanId);
                    }, 300)
                }
            }


            /*]]>*/
        </script>

        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>


</th:block>

<th:block th:fragment="addressVerification">
    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapseAddressVerification" th:onclick="'getAddressVerificationData(' + ${loanId} + ')'">
            <h6 class="panel-title">
                Verificación Domiciliaria
            </h6>
        </div>
        <div id="collapseAddressVerification" class="panel-collapse collapse">
            <div class="panel-body">
                <th:block th:if="${addressVerificationData}">
                    <th:block th:replace="this :: addressVerificationData"></th:block>
                </th:block>
                <th:block th:unless="${addressVerificationData}">
                    <th:block th:replace="this :: loading"></th:block>
                </th:block>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="addressVerificationData">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'addressVerification',productCategoryId)?.editable}">
        <div class="custom-row">
            <div class="col-md-4 pl-0">
                <div class="card-title">Dirección</div>
                <span class="card-title-description" th:text="${addressVerificationData?.address}" onclick="showUpdatePersonAddressModal('addressVerification')"></span>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Correo Electrónico</div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${addressVerificationData?.email}" id="addressVerificationEmail"/>
                </div>
            </div>
            <div class="col-md-2 pl-0">
                <div class="card-title">Teléfono</div>
                <div class="input-material">
                    <input type="text" th:disabled="${!editable}" th:value="${addressVerificationData?.phoneNumber}" id="addressVerificationPhoneNumber"/>
                </div>
            </div>
            <div class="col-md-4 pl-0">
                <div class="w-90 ml-auto pull-right" th:if="${editable}">
                    <div class="dropdown" shiro:hasPermission="loan:contactResultAddressVerification:register">
                        <button class="btn btn-default btn-circle dropdown-toggle d-flex" type="button" data-toggle="dropdown">
                            <th:block th:text="${addressVerificationData?.action != null ? addressVerificationData?.action?.trackingAction : 'Acciones'}"></th:block>
                            <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/select_arrow.svg" class="ml-auto pull-right" alt="" style="width: 12px"/>
                        </button>
                        <ul class="dropdown-menu pull-left" role="menu">
                            <li><a href="javascript:;" th:onclick="'registerContactResultAddressVerification('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).ADDRESS_VERIFICATION_CONTACTED}+',null,null,null,null)'">Contacto</a></li>
                            <li class="dropdown-submenu pull-left w-100">
                                <a tabindex="-1" href="javascript:;">No contacto</a>
                                <ul class="dropdown-menu">
                                    <li><a href="javascript:;" th:onclick="'registerContactResultAddressVerification('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).ADDRESS_VERIFICATION_NO_RESPONSE}+',null,null,null,null)'">No contesta</a></li>
                                    <li><a href="javascript:;" th:onclick="'registerContactResultAddressVerification('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).ADDRESS_VERIFICATION_WRONG_NUMBER}+',null,null,null,null)'">Número equivocado</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="custom-row">
            <div class="col-md-6 pl-0" style="margin-top: 10px">
                <img onclick="showUpdatePersonAddressModal('addressVerification')" th:src="'https://maps.googleapis.com/maps/api/staticmap?center='+
                                                ${latitude}+','+${longitude}+
                                                '&amp;zoom=14&amp;size=500x250&amp;maptype=roadmap&amp;markers=color:red%7C'+
                                                ${latitude}+','+${longitude}+
                                                '&amp;key='+${T(com.affirm.system.configuration.Configuration).GOOGLE_API_KEY}"
                     style="width: 100%;"/>
            </div>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function(){

                let loanAppId = /*[[${loanId}]]*/null;

                $("#addressVerificationPhoneNumber").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'phoneNumber'],
                });

                $("#addressVerificationEmail").editableInputFn({
                    fn : updateFieldValue,
                    params: [loanAppId,'email'],
                });

            })
            /*]]>*/
        </script>

        <th:block th:replace="this:: modalAddress(type='addressVerification')"></th:block>
        <script>
            function showUpdatePersonAddressModal(type){
                $('#modal_address_'+type).modal();
            }
        </script>

        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>

</th:block>

<th:block th:fragment="welcomeCall">
    <div class="panel panel-default panel-collapse-animation mb-0">
        <div class="panel-heading" data-toggle="collapse" data-target="#collapseWelcomeCall" th:onclick="'getWelcomeCall(' + ${loanId} + ')'">
            <h6 class="panel-title">
                Welcome Call
            </h6>
        </div>
        <div id="collapseWelcomeCall" class="panel-collapse collapse">
            <div class="panel-body">

                <th:block th:if="${welcomeCallData}">
                    <th:block th:replace="this :: welcomeCallData"></th:block>
                </th:block>
                <th:block th:unless="${welcomeCallData}">
                    <th:block th:replace="this :: loading"></th:block>
                </th:block>
            </div>
        </div>
    </div>

    <div id="uploadUserFileModalTokyCall" class="modal fade" th:classappend="'upload-modal-call-toky-' + ${loanApplication?.id}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="smaller">Tama&ntilde;o m&aacute;ximo <span
                            th:text="${@configuration.MAX_UPLOAD_FILE_SIZE_MB() + 'mb'}"></span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="uploadUserFileCall" class="dropzone"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            th:onclick="'closeUserFileTokyCallUploadModal('+${loanId}+')'">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var uploadedTokyCallSuccess = false;

        function deleteTokyCall(loanApplicationId) {
            defaultAjax({
                url: /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/welcomeCall/deleteTokyCall}]]*/null,
                type: 'POST',
                data: {
                    loanApplicationId: loanApplicationId
                },
                success: function (data) {
                    getWelcomeCall(loanApplicationId);
                }
            })
        }

        function openUserFileTokyCallUploadModal(loanApplicationId) {
            uploadedTokyCallSuccess = false;

            let $uploadUserFileCallModal = $("#uploadUserFileModalTokyCall");

            console.log($uploadUserFileCallModal);
            $uploadUserFileCallModal.find('.modal-body').html('');
            $uploadUserFileCallModal.find('.modal-body').append("<div id=\"uploadUserFileCall\" class=\"dropzone\"></div>")

            var dropzoneTC = $uploadUserFileCallModal.find(".dropzone").dropzone({
                url: /*[[ @{/__${@entityExtranetLoanDetailController.URL}__/welcomeCall/uploadTokyCall}]]*/null,
                params: {
                    loanApplicationId: loanApplicationId,
                },
                paramName: 'tokyCall',
                maxFilesize: /*[[${@configuration.MAX_UPLOAD_FILE_SIZE_MB()}]]*/, // MB
                maxFiles: 2, //HU1
                dictDefaultMessage: 'Arrastra un archivo aquí para subirlo, o haz click para seleccionar uno.',
                acceptedFiles: 'audio/mpeg,audio/mp3',
                headers: addCsrfToJsonHeaders({
                    'x-request-sender-type': 'ajax'
                }),
                init: function () {
                    /*HU1 Begin*/
                    this.on("addedfile", function (file) {
                    });
                    /*HU1 End*/
                    this.on("success", function () {
                        uploadedTokyCallSuccess = true;
                    });
                    this.on('error', function (error) {
                        swal({
                            title: '',
                            text: error.message,
                            type: "warning",
                            confirmButtonText: "Entendido",
                            closeOnConfirm: false
                        });
                    })
                }
            });

            $uploadUserFileCallModal.modal({
                backdrop: 'static',
                keyboard: false
            });
        }

        function closeUserFileTokyCallUploadModal(loanId) {
            $("#uploadUserFileModalTokyCall .modal-footer button").closest('.modal').modal('hide');
            if (uploadedTokyCallSuccess) {
                setTimeout(function () {
                    getWelcomeCall(loanId);
                }, 300)
            }
        }


        /*]]>*/
    </script>

    <script>
        replaceImgSvgToSvgElement();
    </script>
</th:block>

<th:block th:fragment="welcomeCallData">

    <th:block th:with="editable=${@entityExtranetService.getFragmentDetailConfiguration(@brandingService.getExtranetBrandingAsJson(#httpServletRequest),tray,'welcomeCall',productCategoryId)?.editable}">
        <div class="custom-row d-flex">
            <div class="col-md-10 pl-0">
                <div class="media-player-container">
                    <div class="media-player"></div>
                    <div class="media-player-options d-flex">
                        <div class="w-50 d-flex">
                            <button th:if="${editable}" shiro:hasPermission="loan:welcomeCall:action:upload" type="button" class="btn btn-default w-100" th:onclick="'openUserFileTokyCallUploadModal('+${loanId}+')'" style="background-color: transparent; border: none; padding: 0px;margin: 0px;min-height:70px;font-size: 1.6rem;">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/descargar_g.svg" alt="" class="custom-icono-svg"/>
                                Cargar llamada
                            </button>
                        </div>
                        <div class="w-50 d-flex">
                            <button shiro:hasPermission="loan:welcomeCall:action:delete" class="btn btn-default w-100" th:if="${editable or welcomeCallData?.tokyCall != null}" th:onclick="'deleteTokyCall('+${loanId}+')'" style="background-color: transparent; border: none; padding: 0px;margin: 0px;min-height:70px;font-size: 1.6rem;">
                                <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/eliminar.svg" alt="" class="custom-icono-svg"/>
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="dropdown ml-auto pull-right" th:if="${editable}" shiro:hasPermission="loan:welcomeCall:register:contactResult">
                    <button class="btn btn-default btn-circle dropdown-toggle d-flex" type="button" data-toggle="dropdown">
                        <th:block th:text="${welcomeCallData?.action != null ? welcomeCallData?.action?.trackingAction : 'Acciones'}"></th:block>
                        <img src="https://solven-public.s3.amazonaws.com/img/iconos_extranet/select_arrow.svg" class="ml-auto pull-right" alt="" style="width: 12px"/>
                    </button>
                    <ul class="dropdown-menu pull-left" role="menu">
                        <li><a href="javascript:;" th:onclick="'registerContactResultCase('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).WELCOME_CALL_CONTACTED}+',null,null,null,null,\'welcomeCall\')'">Contacto</a></li>
                        <li class="dropdown-submenu pull-left w-100">
                            <a tabindex="-1" href="javascript:;">No contacto</a>
                            <ul class="dropdown-menu">
                                <li><a href="javascript:;" th:onclick="'registerContactResultCase('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).WELCOME_CALL_NO_RESPONSE}+',null,null,null,null,\'welcomeCall\')'">No contesta</a></li>
                                <li><a href="javascript:;" th:onclick="'registerContactResultCase('+${loanId}+','+${T(com.affirm.common.model.catalog.TrackingAction).WELCOME_CALL_WRONG_NUMBER}+',null,null,null,null,\'welcomeCall\')'">Número equivocado</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <script>
            replaceImgSvgToSvgElement();
        </script>
    </th:block>

</th:block>

<th:block th:fragment="modalAddress">
    <div th:id="'modal_address_'+${type}" class="modal fade custom-modal" tabindex="-1" role="dialog" aria-labelledby="modalAddress">
        <div class="modal-dialog modal-lg" style="width: 900px !important;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 style="width: 70%">Agregar direccion </h4>
                    <a href="javascript:;" class="ml-auto" data-dismiss="modal">X</a>
                </div>
                <div class="modal-body" style="border: 0">
                    <form role="form"  id="frmUpdatePersonAddressModal" th:object="${updatePersonAddressForm}">
                        <!--                        <input id='latitude' type="hidden" th:field="*{latitude}"/>-->
                        <!--                        <input id='longitude' type="hidden" th:field="*{longitude}"/>-->
                        <input id='addressType' type="hidden" th:field="*{addressType}"/>

                        <div class="custom-row">
                            <div class="col-md-12 pl-0">
                                <div class="card-title">Dirección agregada</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{aggregatedAddress}" name="aggregatedAddress"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-row">
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Departamento</div>
                                <div class="input-material field">
                                    <select name="departamento" th:disabled="${!editable}" id="departamento" th:field="*{departamento}">
                                        <option th:each="department : ${@catalogService.getDepartments()}"
                                                th:value="${department.id}"
                                                th:text="${department.name}"></option>
                                    </select>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3 pl-0">
                                <div class="card-title">Provincia</div>
                                <div class="input-material field">
                                    <select name="provincia" th:disabled="${!editable}" id="provincia" th:field="*{provincia}">
                                        <option th:if="*{departamento != null}"
                                                th:each="province : ${@catalogService.getProvinces(updatePersonAddressForm.departamento)}"
                                                th:value="${province.id}" th:text="${province.name}"></option>
                                    </select>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3 pl-0">
                                <div class="card-title">Distrito</div>
                                <div class="input-material field">
                                    <select th:disabled="${!editable}" name="distrito" id="distrito" th:field="*{distrito}">
                                        <option value="" hidden="hidden"></option>
                                        <option th:if="*{provincia != null}"
                                                th:each="district : ${@catalogService.getDistricts(updatePersonAddressForm.departamento, updatePersonAddressForm.provincia)}"
                                                th:value="${district.id}" th:text="${district.name}"></option>
                                    </select>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3 pl-0">
                                <div class="card-title">Tipo</div>
                                <div class="input-material field">
                                    <select id="roadType" th:disabled="${!editable}" name="roadType"  th:field="*{roadType}" >
                                        <option value="" hidden="hidden"></option>
                                        <th:block th:if="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).ACCESO)}">
                                            <option th:selected="${''+type.id == updatePersonAddressForm?.roadType} ? true : false" th:each="type : ${@catalogService.getStreetTypesAcceso()}"
                                                    th:value="${type.id}" th:text="${type.type}"></option>
                                        </th:block>
                                        <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).ACCESO)}">
                                            <th:block th:if="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                                                <option th:each="type : ${@catalogService.getStreetTypesAzteca()}" th:selected="${''+type.id == updatePersonAddressForm.roadType} ? true : false"
                                                        th:value="${type.id}" th:text="${type.type}"></option>
                                            </th:block>
                                            <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                                                <option th:selected="${''+type.id == updatePersonAddressForm?.roadType} ? true : false" th:each="type : ${@catalogService.getStreetTypes()}"
                                                        th:value="${type.id}" th:text="${type.type}"></option>
                                            </th:block>
                                        </th:block>
                                    </select>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="custom-row">
                            <div class="col-md-6 pl-0">
                                <div class="card-title">Dirección</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{roadName}" name="roadName"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Número</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{houseNumber}" name="houseNumber"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Departamento</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{interior}" name="interior"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-row">
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Manzana</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{manzana}" name="manzana"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Lote</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{lote}" name="lote"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Tipo de zona</div>
                                <div class="input-material field" >
                                    <select name="zoneType" th:disabled="${!editable}" id="zoneType" th:field="*{zoneType}">
                                        <option value="" hidden="hidden"></option>
                                        <th:block th:if="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                                            <option th:each="area : ${@catalogService.getAreaTypesAzteca()}" th:value="${area.id}" th:text="${area.name}" th:selected="${''+area.id == updatePersonAddressForm.zoneType} ? true : false"></option>
                                        </th:block>
                                        <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                                            <th:block th:if="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).ACCESO)}">
                                                <option th:selected="${''+area.id == updatePersonAddressForm.zoneType} ? true : false" th:each="area : ${@catalogService.getAreaTypesAcceso()}" th:value="${area.id}" th:text="${area.name}"></option>
                                            </th:block>
                                            <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).ACCESO)}">
                                                <option th:selected="${''+area.id == updatePersonAddressForm.zoneType} ? true : false" th:each="area : ${@catalogService.getAreaType()}" th:value="${area.id}" th:text="${area.name}"></option>
                                            </th:block>
                                        </th:block>
                                    </select>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Nombre zona</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" th:field="*{zoneName}" name="zoneName"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-row">
                            <div class="col-md-12 pl-0">
                                <div class="card-title">Referencia</div>
                                <div class="input-material field">
                                    <input type="text" th:disabled="${!editable}" name="reference" th:field="*{reference}"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-row">
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Latitud</div>
                                <div class="input-material field">
                                    <input type="text" th:field="*{latitude}" name="latitude" id="latitude" readonly="readonly"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 pl-0">
                                <div class="card-title">Longitud</div>
                                <div class="input-material field">
                                    <input type="text" th:field="*{longitude}" name="longitude" readonly="readonly"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="custom-row">
                            <div class="col-md-12 pl-0">
                                <div class="card-title">Geolocalización</div>
                                <div id="personAddressMap" style="height: 350px;"></div>
                            </div>
                        </div>

                        <div class="custom-row">
                            <div class="col-md-12 pl-0">
                                <div class="card-title">Ubicación</div>
                                <div class="input-material field">
                                    <input id="address" th:disabled="${!editable}" type="text" th:field="*{searchQuery}"/>
                                    <div class="errorContainer">
                                        <span class="help-block form-field-error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer" th:if="${editable}">
                    <button class="btn btn-outline btn-default principal-button-modal" th:onclick="'updatePersonAddress(\''+${type}+'\','+${loanId}+','+${personId}+')'">Guardar</button>
                    <button class="btn btn-outline btn-default" data-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript" th:if="${person?.documentType?.countryId == T(com.affirm.common.model.catalog.CountryParam).COUNTRY_PERU} and ${type} == 'home'">
        /*<![CDATA[*/

        $departmentHome = $("div#modal_address_home #frmUpdatePersonAddressModal select[name=departamento]");
        $provinceHome = $("div#modal_address_home #frmUpdatePersonAddressModal select[name=provincia]");
        $districtHome = $("div#modal_address_home #frmUpdatePersonAddressModal select[name=distrito]");

        $departmentHome.on('change', function () {
            $.getJSON(/*[[@{/catalog/provinces/json}]]*/, {departmentId: $(this).val()}, function (data) {
                var placeholder = "";
                var options = '<option value="" hidden="hidden">' + placeholder + '</option>';
                if (data != null) {
                    for (var x = 0; x < data.length; x++) {
                        options += '<option value="' + data[x]['id'] + '" ' + '>' + data[x]['name'] + '</option>';
                    }
                }
                $provinceHome.html(options);
                $provinceHome.change();
            });
        });
        $provinceHome.on('change', function () {
            $.getJSON(/*[[@{/catalog/districts/json}]]*/, {
                departmentId: $departmentHome.val(),
                provinceId: $(this).val()
            }, function (data) {
                var placeholder = "";
                var options = '<option value="" hidden="hidden">' + placeholder + '</option>';
                if (data != null) {
                    for (var x = 0; x < data.length; x++) {
                        options += '<option value="' + data[x]['id'] + '">' + data[x]['name'] + '</option>';
                    }
                }
                $districtHome.html(options);
            });
        });

        /*]]>*/
    </script>

    <script th:inline="javascript" th:if="${person?.documentType?.countryId == T(com.affirm.common.model.catalog.CountryParam).COUNTRY_PERU} and ${type} == 'addressVerification'">
        /*<![CDATA[*/

        $departmentAddressVerification = $("#modal_address_addressVerification select[name=departamento]");
        $provinceAddressVerification = $("#modal_address_addressVerification select[name=provincia]");
        $districtAddressVerification = $("#modal_address_addressVerification select[name=distrito]");

        $departmentAddressVerification.on('change', function () {
            $.getJSON(/*[[@{/catalog/provinces/json}]]*/, {departmentId: $(this).val()}, function (data) {
                var placeholder = "";
                var options = '<option value="" hidden="hidden">' + placeholder + '</option>';
                if (data != null) {
                    for (var x = 0; x < data.length; x++) {
                        options += '<option value="' + data[x]['id'] + '" ' + '>' + data[x]['name'] + '</option>';
                    }
                }
                $provinceAddressVerification.html(options);
                $provinceAddressVerification.change();
            });
        });
        $provinceAddressVerification.on('change', function () {
            $.getJSON(/*[[@{/catalog/districts/json}]]*/, {
                departmentId: $departmentAddressVerification.val(),
                provinceId: $(this).val()
            }, function (data) {
                var placeholder = "";
                var options = '<option value="" hidden="hidden">' + placeholder + '</option>';
                if (data != null) {
                    for (var x = 0; x < data.length; x++) {
                        options += '<option value="' + data[x]['id'] + '">' + data[x]['name'] + '</option>';
                    }
                }
                $districtAddressVerification.html(options);
            });
        });

        /*]]>*/
    </script>

    <script th:inline="javascript" th:if="${person?.documentType?.countryId == T(com.affirm.common.model.catalog.CountryParam).COUNTRY_PERU} and ${type} == 'work'">
        /*<![CDATA[*/

        $departmentWork = $("#modal_address_work #frmUpdatePersonAddressModal select[name=departamento]");
        $provinceWork = $("#modal_address_work #frmUpdatePersonAddressModal select[name=provincia]");
        $districtWork = $("#modal_address_work #frmUpdatePersonAddressModal select[name=distrito]");

        $departmentWork.on('change', function () {
            $.getJSON(/*[[@{/catalog/provinces/json}]]*/, {departmentId: $(this).val()}, function (data) {
                var placeholder = "";
                var options = '<option value="" hidden="hidden">' + placeholder + '</option>';
                if (data != null) {
                    for (var x = 0; x < data.length; x++) {
                        options += '<option value="' + data[x]['id'] + '" ' + '>' + data[x]['name'] + '</option>';
                    }
                }
                $provinceWork.html(options);
                $provinceWork.change();
            });
        });
        $provinceWork.on('change', function () {
            $.getJSON(/*[[@{/catalog/districts/json}]]*/, {
                departmentId: $departmentWork.val(),
                provinceId: $(this).val()
            }, function (data) {
                var placeholder = "";
                var options = '<option value="" hidden="hidden">' + placeholder + '</option>';
                if (data != null) {
                    for (var x = 0; x < data.length; x++) {
                        options += '<option value="' + data[x]['id'] + '">' + data[x]['name'] + '</option>';
                    }
                }
                $districtWork.html(options);
            });
        });

        /*]]>*/
    </script>


    <script th:inline="javascript" th:if="${type} == 'home'">
        /*<![CDATA[*/

        // Setting validations
        var personAddressValidatorJson = /*[[${updatePersonAddressForm.validator.toJson(#locale)}]]*/null;
        if (personAddressValidatorJson != null) {
            jsonFormValidationHome = createFormValidationJson(JSON.parse(personAddressValidatorJson), $('div#modal_address_home #frmUpdatePersonAddressModal'));
            $('div#modal_address_home #frmUpdatePersonAddressModal').validateForm(jsonFormValidationHome);
        }

        // Mapa
        var addressLat = /*[[${updatePersonAddressForm?.latitude}]]*/null;
        var addressLon = /*[[${updatePersonAddressForm?.longitude}]]*/null;

        var defaultLat = /*[[${@countryContextService.getCountryDefaultMapLatitude(person?.documentType?.countryId)}]]*/null;
        var defaultLon = /*[[${@countryContextService.getCountryDefaultMapLongitude(person?.documentType?.countryId)}]]*/null;

        var personAddressMap = new google.maps.Map(document.querySelector('div#modal_address_home #personAddressMap'), {
            center: addressLat != null && addressLon != null ? {
                lat: addressLat,
                lng: addressLon
            } : {lat: defaultLat, lng: defaultLon},
            zoom: 14
        });

        // Marker IP
        var addressLocationMarker = new google.maps.Marker({
            map: personAddressMap,
            icon: 'https://maps.google.com/mapfiles/ms/micons/red.png',
            draggable: true,
            animation: google.maps.Animation.DROP,
            position: addressLat != null && addressLon != null ? {
                lat: addressLat,
                lng: addressLon
            } : {lat: defaultLat, lng: defaultLon}
        });
        addressLocationMarker.addListener('dragend', function (event) {
            console.log("dragend: " + event.latLng.lat() + " - " + event.latLng.lng())
            $("div#modal_address_home #frmUpdatePersonAddressModal input[name=latitude]").val(event.latLng.lat());
            $("div#modal_address_home #frmUpdatePersonAddressModal input[name=longitude]").val(event.latLng.lng());
        });

        // DIspara el Resize del mapa despues de 1000ms
        setTimeout(function () {
            google.maps.event.trigger(personAddressMap, "resize");
            if (addressLat != null && addressLon != null) {
                personAddressMap.setCenter(new google.maps.LatLng(addressLat, addressLon))
            }
        }, 1000);

        var mapLocation;
        var marker;
        var autocomplete;
        var autocompletedPlace = false;

        // Init the searchbox
        autocomplete = new google.maps.places.Autocomplete(
            (document.querySelector('div#modal_address_home #address')
            ), {
                types: ['geocode'],
                radius: 500
            });
        console.log(document.querySelector('div#modal_address_home #address'), autocomplete);

        var countryString = /*[[${@countryContextService.getCountryStringCode(person?.documentType?.countryId)}]]*/null;

        autocomplete.setComponentRestrictions(
            {'country': [countryString]});


        autocomplete.addListener('place_changed', function () {
            mapLocation = null;
            addressLocationMarker.setVisible(false);
            console.log("change");
            let place = autocomplete.getPlace();
            if (!place.geometry) {
                return;
            }
            let location = place.geometry.location;
            $("div#modal_address_home #latitude").val(location.lat());
            $("div#modal_address_home #longitude").val(location.lng());

            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
                personAddressMap.fitBounds(place.geometry.viewport);
            } else {
                personAddressMap.setCenter(place.geometry.location);
                personAddressMap.setZoom(14);  // Why 14? Because it looks good.
            }

            mapLocation = place.geometry.location;
            addressLocationMarker.setPosition(mapLocation);
            addressLocationMarker.setVisible(true);
            autocompletedPlace = true;
        });

        /*]]>*/
    </script>

    <script th:inline="javascript" th:if="${type} == 'addressVerification'">
        /*<![CDATA[*/

        // Setting validations
        var personAddressVerificationValidatorJson = /*[[${updatePersonAddressForm.validator.toJson(#locale)}]]*/null;
        if (personAddressVerificationValidatorJson != null) {
            jsonFormValidationAddressVerification = createFormValidationJson(JSON.parse(personAddressVerificationValidatorJson), $('div#modal_address_addressVerification #frmUpdatePersonAddressModal'));
            $('div#modal_address_addressVerification #frmUpdatePersonAddressModal').validateForm(jsonFormValidationAddressVerification);
        }

        // Mapa
        var addressLatV = /*[[${updatePersonAddressForm?.latitude}]]*/null;
        var addressLonV = /*[[${updatePersonAddressForm?.longitude}]]*/null;

        var defaultLatV = /*[[${@countryContextService.getCountryDefaultMapLatitude(person?.documentType?.countryId)}]]*/null;
        var defaultLonV = /*[[${@countryContextService.getCountryDefaultMapLongitude(person?.documentType?.countryId)}]]*/null;

        var personAddressMapV = new google.maps.Map(document.querySelector('div#modal_address_addressVerification #personAddressMap'), {
            center: addressLatV != null && addressLonV != null ? {
                lat: addressLatV,
                lng: addressLonV
            } : {lat: defaultLatV, lng: defaultLonV},
            zoom: 14
        });

        // Marker IP
        var addressLocationMarkerV = new google.maps.Marker({
            map: personAddressMapV,
            icon: 'https://maps.google.com/mapfiles/ms/micons/red.png',
            draggable: true,
            animation: google.maps.Animation.DROP,
            position: addressLatV != null && addressLonV != null ? {
                lat: addressLatV,
                lng: addressLonV
            } : {lat: defaultLatV, lng: defaultLonV}
        });
        addressLocationMarkerV.addListener('dragend', function (event) {
            console.log("dragend: " + event.latLng.lat() + " - " + event.latLng.lng())
            $("div#modal_address_addressVerification #frmUpdatePersonAddressModal input[name=latitude]").val(event.latLng.lat());
            $("div#modal_address_addressVerification #frmUpdatePersonAddressModal input[name=longitude]").val(event.latLng.lng());
        });

        // DIspara el Resize del mapa despues de 1000ms
        setTimeout(function () {
            google.maps.event.trigger(personAddressMapV, "resize");
            if (addressLatV != null && addressLonV != null) {
                personAddressMapV.setCenter(new google.maps.LatLng(addressLatV, addressLonV))
            }
        }, 1000);

        var mapLocationV;
        var markerV;
        var autocompleteV;
        var autocompletedPlaceV = false;

        // Init the searchbox
        autocompleteV = new google.maps.places.Autocomplete(
            (document.querySelector('div#modal_address_addressVerification #address')), {
                types: ['geocode'],
                radius: 500
            });

        var countryStringV = /*[[${@countryContextService.getCountryStringCode(person?.documentType?.countryId)}]]*/null;

        autocompleteV.setComponentRestrictions(
            {'country': [countryStringV]});


        autocompleteV.addListener('place_changed', function () {
            mapLocationV = null;
            addressLocationMarkerV.setVisible(false);

            let place = autocompleteV.getPlace();
            if (!place.geometry) {
                return;
            }
            let location = place.geometry.location;
            $("div#modal_address_addressVerification #latitude").val(location.lat());
            $("div#modal_address_addressVerification #longitude").val(location.lng());

            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
                personAddressMapV.fitBounds(place.geometry.viewport);
            } else {
                personAddressMapV.setCenter(place.geometry.location);
                personAddressMapV.setZoom(14);  // Why 14? Because it looks good.
            }

            mapLocationV = place.geometry.location;
            addressLocationMarkerV.setPosition(mapLocationV);
            addressLocationMarkerV.setVisible(true);
            autocompletedPlaceV = true;
        });

        /*]]>*/
    </script>

    <script th:inline="javascript" th:if="${type} == 'work'">
        /*<![CDATA[*/

        // Setting validations
        var personAddressValidatorJsonJob = /*[[${updatePersonAddressForm.validator.toJson(#locale)}]]*/null;
        if (personAddressValidatorJsonJob != null) {
            jsonFormValidationJob = createFormValidationJson(JSON.parse(personAddressValidatorJsonJob), $('#modal_address_work #frmUpdatePersonAddressModal'));
            $('#modal_address_work #frmUpdatePersonAddressModal').validateForm(jsonFormValidationJob);
        }

        // Mapa
        var addressLatJob = /*[[${updatePersonAddressForm?.latitude}]]*/null;
        var addressLonJob = /*[[${updatePersonAddressForm?.longitude}]]*/null;

        var defaultLatJob = /*[[${@countryContextService.getCountryDefaultMapLatitude(person?.documentType?.countryId)}]]*/null;
        var defaultLonJob = /*[[${@countryContextService.getCountryDefaultMapLongitude(person?.documentType?.countryId)}]]*/null;

        var personAddressMapJob = new google.maps.Map(document.querySelector('#modal_address_work #personAddressMap'), {
            center: addressLatJob != null && addressLonJob != null ? {
                lat: addressLatJob,
                lng: addressLonJob
            } : {lat: defaultLatJob, lng: defaultLonJob},
            zoom: 14
        });

        // Marker IP
        var addressLocationMarkerJob = new google.maps.Marker({
            map: personAddressMapJob,
            icon: 'https://maps.google.com/mapfiles/ms/micons/red.png',
            draggable: true,
            animation: google.maps.Animation.DROP,
            position: addressLatJob != null && addressLonJob != null ? {
                lat: addressLatJob,
                lng: addressLonJob
            } : {lat: defaultLatJob, lng: defaultLonJob}
        });
        addressLocationMarkerJob.addListener('dragend', function (event) {
            console.log("dragend: " + event.latLng.lat() + " - " + event.latLng.lng())
            $("#modal_address_work #frmUpdatePersonAddressModal input[name=latitude]").val(event.latLng.lat());
            $("#modal_address_work #frmUpdatePersonAddressModal input[name=longitude]").val(event.latLng.lng());
        });

        // DIspara el Resize del mapa despues de 1000ms
        setTimeout(function () {
            google.maps.event.trigger(personAddressMapJob, "resize");
            if (addressLatJob != null && addressLonJob != null) {
                personAddressMapJob.setCenter(new google.maps.LatLng(addressLatJob, addressLonJob))
            }
        }, 1000);

        var mapLocationJob;
        var markerJob;
        var autocompleteJob;
        var autocompletedPlaceJob = false;

        // Init the searchbox
        autocompleteJob = new google.maps.places.Autocomplete(
            (document.querySelector('#modal_address_work #address')), {
                types: ['geocode'],
                radius: 500
            });

        var countryStringJob = /*[[${@countryContextService.getCountryStringCode(person?.documentType?.countryId)}]]*/null;

        autocompleteJob.setComponentRestrictions(
            {'country': [countryStringJob]});


        autocompleteJob.addListener('place_changed', function () {
            mapLocationJob = null;
            addressLocationMarkerJob.setVisible(false);

            var place = autocompleteJob.getPlace();
            if (!place.geometry) {
                return;
            }
            var location = place.geometry.location;
            $("#modal_address_work #latitude").val(location.lat());
            $("#modal_address_work #longitude").val(location.lng());

            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
                personAddressMapJob.fitBounds(place.geometry.viewport);
            } else {
                personAddressMapJob.setCenter(place.geometry.location);
                personAddressMapJob.setZoom(14);  // Why 14? Because it looks good.
            }

            mapLocationJob = place.geometry.location;
            addressLocationMarkerJob.setPosition(mapLocationJob);
            addressLocationMarkerJob.setVisible(true);
            autocompletedPlaceJob = true;
        });

        /*]]>*/
    </script>

</th:block>

<th:block th:fragment="updateOccupationalPhoneNumberModal">
    <div class="modal-header">
        <strong>Teléfono laboral</strong>
    </div>
    <div class="modal-body">
        <form role="form" action="#" method="post" th:object="${occupationalPhoneNumberForm}"
              id="frmUpdateOccupationalPhoneNumber">
            <div class="form-row">
                <div class="col-md-4">
                    <div class="form-group" style="padding: 0px !important;">
                        <label>Tipo de teléfono</label>
                        <select th:field="*{typePhone}" class="form-control form-control-sm" id="selTypePhone">
                            <option th:value="${T(com.affirm.common.model.catalog.PhoneType).LANDLINE}">Fijo</option>
                            <option th:value="${T(com.affirm.common.model.catalog.PhoneType).CELLPHONE}">Celular</option>
                        </select>
                        <div class="errorContainer form-bo"></div>
                    </div>
                </div>
                <div class="col-md-2 pl-0" id="divPhoneCode">
                    <div class="form-group " style="padding: 0px !important;">
                        <label>Cód. área</label>
                        <input id="txtPhoneCode" type="text" th:field="*{phoneCode}" maxlength="4" class="form-control form-control-sm" placeholder="Código"/>
                        <div class="errorContainer form-bo"></div>
                    </div>
                </div>
                <div class="col-md-6 pl-0">
                    <div class="form-group" style="padding: 0px !important;">
                        <label>Número</label>
                        <input id="txtPhoneNumber" type="text" th:field="*{phoneNumber}" class="form-control form-control-sm" placeholder="Número"/>
                        <div class="errorContainer form-bo"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-default" id="cancelButtonSaveButton" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-info" id="saveButtonModal" th:onclick="'updateOccupationalPhoneNumber('+${loanId}+','+${personId}+')'">Guardar</button>
    </div>
    <script th:inline="javascript" >
        /*<![CDATA[*/
        $(function() {
            $('#selTypePhone').change(function() {
                if ($(this).val() == /*[[ ${T(com.affirm.common.model.catalog.PhoneType).LANDLINE} ]]*/null) {
                    $('#divPhoneCode').fadeIn();

                    if (/*[[${person?.documentType?.countryId != T(com.affirm.common.model.catalog.CountryParam).COUNTRY_COLOMBIA}]]*/) {
                        $('#txtPhoneNumber').mask('000-#');
                    }
                }
                else {
                    $('#divPhoneCode').hide();
                    $('#txtPhoneCode').val('');

                    if (/*[[${person?.documentType?.countryId != T(com.affirm.common.model.catalog.CountryParam).COUNTRY_COLOMBIA}]]*/) {
                        $('#txtPhoneNumber').mask('0000-#');
                    }
                }
            });

            $('#selTypePhone').change();
        });

        var occupationalPhoneValidatorJson = /*[[${occupationalPhoneNumberForm.validator.toJson(#locale)}]]*/null;
        if (occupationalPhoneValidatorJson != null) {
            jsonFormValidation = createFormValidationJson(JSON.parse(occupationalPhoneValidatorJson), $('#frmUpdateOccupationalPhoneNumber'));
            $('#frmUpdateOccupationalPhoneNumber').validateForm(jsonFormValidation);
        }

        /*]]>*/
    </script>
</th:block>

</html>