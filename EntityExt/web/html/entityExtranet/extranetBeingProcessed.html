<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/extranetTemplate"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&amp;subset=all" rel="stylesheet" type="text/css"/>
    <!-- Bootstrap DatePicker -->
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker-1.9/dist/css/bootstrap-datepicker3.min.css'}" />
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker-1.9/dist/js/bootstrap-datepicker.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker-1.9/dist/locales/bootstrap-datepicker.es.min.js'}"></script>
    <script th:src="@{/js/bo_tablefilter.js}"></script>

    <script>
        /*<![CDATA[*/

        $(document).ready(function(){

            $('tooltip-on').tooltip()

            $('svg.radial-progress').each(function( index, value ) {
                $(this).find($('circle.complete')).removeAttr( 'style' );
            });

            $(window).scroll(function(){
                $('svg.radial-progress').each(function( index, value ) {
                    // If svg.radial-progress is approximately 25% vertically into the window when scrolling from the top or the bottom
                    if (
                        $(window).scrollTop() > $(this).offset().top - ($(window).height() * 0.75) &&
                        $(window).scrollTop() < $(this).offset().top + $(this).height() - ($(window).height() * 0.25)
                    ) {
                        // Get percentage of progress
                        percent = $(value).data('percentage');
                        // Get radius of the svg's circle.complete
                        radius = $(this).find($('circle.complete')).attr('r');
                        // Get circumference (2πr)
                        circumference = 2 * Math.PI * radius;
                        // Get stroke-dashoffset value based on the percentage of the circumference
                        strokeDashOffset = circumference - ((percent * circumference) / 100);
                        // Transition progress for 1.25 seconds
                        $(this).find($('circle.complete')).animate({'stroke-dashoffset': strokeDashOffset}, 1250);
                    }
                });
            }).trigger('scroll');

        })
        /*]]>*/
    </script>




    <script th:inline="javascript">
        /*<![CDATA[*/
        var url = /*[[ @{/extranet-paginator/} ]]*/;
        var totalCount = [[${totalCount}]];
        var limitPaginator =  [[${limitPaginator}]];
        var pageName = [[${page}]];
        url += pageName;

        $(document).on('ready', function () {
            enableTableOptions($("#tableResults"), url, url+"/count", true, "#downloadTrayReport");
        });
        /*]]>*/
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var trayReport =/*[[${@entityExtranetService.canShowDownloadTrayReport(tray,#httpServletRequest,#locale)}]]*/null;
        var tray = /*[[${tray}]]*/null;
        var idDownloadButton =  "#downloadTrayReport";
        function executeDownloadReport() {
            let requestData = $('#form-termitated-list').serializeObject();
            let downloadButton = $(idDownloadButton);
            downloadButton.loading();
            defaultAjax({
                url: /*[[ @{/__${@entityExtranetTrayReportsController.URL}__}]]*/null,
                type: 'POST',
                data:{
                    tray,
                    trayReport,
                    creationFrom :  requestData.creationFrom || null,
                    creationTo :  requestData.creationTo || null,
                    search : requestData.searchValue || null,
                },
                success: function (data) {
                    downloadButton.unloading();
                    if(data != null) {
                        data = JSON.parse(data);
                        if(data.id) getReportStatus(data.id);
                    }
                },
                error: function(){
                    downloadButton.unloading();
                }
            });
        }

        function getReportStatus(reportId){
            let downloadButton = $(idDownloadButton);
            downloadButton.loading();
            defaultAjax({
                url: /*[[ @{/__${@entityExtranetTrayReportsController.URL}__}]]*/null,
                type: 'GET',
                data:{
                    reportId
                },
                success: function (data) {
                    downloadButton.unloading();
                    if(data != null) {
                        data = JSON.parse(data);
                        if(data.status == 'P' || data.status == "Q") {
                            downloadButton.loading();
                            setTimeout(()=>{getReportStatus(reportId);},3000);
                        }
                        else if(data.status == 'S'){
                            //DESCARGAR REPORTE
                            createElementToClick(reportId,data.url);
                        }
                        else if(data.status == 'F'){
                            swal({
                                title: "Oops...",
                                text: "Ha ocurrido un error al procesar la descarga",
                                imageUrl: "/img/icon-modal-error.svg",
                                confirmButtonColor: '#F7323F',
                                cancelButtonColor: '#3F3B3B',
                                imageSize: "66x66"
                            });
                        }
                    }
                },
                error: function(){
                    downloadButton.unloading();
                }
            });
        }

        function createElementToClick(id,url){
            if(!url) return;
            window.location.href = url;
            // let aElement= document.createElement('a');
            // aElement.setAttribute('href', url);
            // aElement.setAttribute('target', "_blank");
            // aElement.setAttribute('id', "report"+id);
            // aElement.style.display = "none";
            // document.body.appendChild(aElement);
            // document.getElementById("report"+id).click();
        }

        $(document).ready(function(){
            $(idDownloadButton).off('click').on('click', function(e){
                e.preventDefault();
                executeDownloadReport();
            })
        })
        /*]]>*/
    </script>
    <style>
        .text-left{
            text-align: left !important;
        }
    </style>
    <th:block th:replace="components/tracking :: social" />




</head>
<body>
<th:block layout:fragment="header">
<!--    <th:block th:replace="fragments/headers :: entityDashboardHeader "></th:block>-->
    <div class="clearfix"></div>
</th:block>
<th:block layout:fragment="content">
    <th:block th:replace="fragments/extranetSidebarFragments :: extranetEntitySidebar(currentPage=${page})"></th:block>
    <div class="page-content-wrapper">
        <div class="page-content">
            <div class="row w-creditos-procesados">
                <th:block th:replace="fragments/headers :: entityContentHeaderWithFilters "></th:block>
                <div class="col-xs-12">
                    <div id="creditsTable" class="tablefilter-table table-container">
                        <div class="table-responsive" style="overflow: auto">
                            <table id="tableResults" class=" table table-striped table-bordered table-hover table-checkable order-column dataTable">
                                <thead>
                                <th:block th:if="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).BANCO_DEL_SOL)}">
                                    <tr>
                                        <th>#</th>
                                        <th>Fec. Registro</th>
                                        <th>Código</th>
                                        <th>Tipo Doc.</th>
                                        <th>Número Doc.</th>
                                        <th>Nombre</th>
                                        <th>Fec.Nac</th>
                                        <th>Email</th>
                                        <th>Celular</th>
                                        <th>Monto</th>
                                        <th>Cuotas</th>
                                        <th>Cuota Promedio</th>
                                        <th>Tasa</th>
                                        <th>Telefono</th>
                                        <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                                            <th>E.Civil</th>
                                        </th:block>
                                        <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                                            <th>Direccion</th>
                                        </th:block>
                                        <th>Documentación</th>
                                    </tr>
                                </th:block>
                                <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).BANCO_DEL_SOL)}">
                                    <th:block th:replace="this :: headerBeingProcessed"></th:block>
                                </th:block>
                                </thead>
                                <tbody>
                                <th:block th:replace="this :: list"></th:block>
                                </tbody>
                            </table>
                            <th:block th:replace="fragments/footers :: paginatorFooter "></th:block>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block th:fragment="headerBeingProcessed">
    <th:block th:replace="/entityExtranet/fragments/extranetTableHeaderFragments :: headerBeingProcessed"></th:block>
</th:block>

<th:block th:fragment="bodyBeingProcessed">
    <th:block th:replace="/entityExtranet/fragments/extranetTableHeaderFragments :: bodyBeingProcessed"></th:block>
</th:block>

<th:block th:fragment="list">
    <th:block th:if="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).BANCO_DEL_SOL)}">
        <th:block th:if="${#lists.isEmpty(credits)}">
            <tr>
                <td colspan="10">No hay resultados</td>
            </tr>
        </th:block>
        <th:block th:unless="${#lists.isEmpty(credits)}">
            <tr th:each="credit, iterCredit : ${credits}"
                th:style="${credit?.observationReason?.id != null }? 'background-color:#FFFFCC'">
                <td th:text="${iterCredit.count}"></td>
                <td th:text="${@utilService.dateFormat(credit?.generationDate)}" th:attr="data-order=${@utilService.datetimeYearFirstFormat(credit?.inactiveWOScheduleDate)}"></td>
                <td>
                    <span th:if="${credit?.creditId == null}"  th:text="${credit?.code}"></span>
                    <a th:if="${credit?.creditId != null}" th:href="@{/credit/__${credit?.creditId}__}"
                       th:text="${credit?.code}"></a>
                </td>
                <td th:text="${credit?.personDocumentType?.name}"></td>
                <td th:text="${credit?.personDocumentNumber}"></td>
                <td th:text="${credit?.fullName}"></td>
                <td th:text="${@utilService.dateFormat(credit?.dateOfBirth)}" th:attr="data-order=${@utilService.datetimeYearFirstFormat(credit?.inactiveWOScheduleDate)}"></td>
                <td th:text="${credit?.email}"></td>
                <td th:text="${credit?.phone}"></td>
                <td th:text="${@utilService.doubleMoneyFormat(credit?.amount, credit?.currency)}"></td>
                <td th:text="${credit?.installments}"></td>
                <td th:text="${@utilService.doubleMoneyFormat(credit?.installmentAmountAvg,credit?.currency)}"></td>
                <td th:text="${credit?.nominalAnualRate}"></td>
                <td th:text="${credit?.phone}"></td>
                <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                    <td th:text="${credit?.maritalStatus?.status}"></td>
                </th:block>
                <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).AZTECA)}">
                    <td th:text="${credit?.address}"></td>
                </th:block>
                <td>
                    <a th:if="${credit?.creditId != null}" target="_blank" th:href="@{/userFile/__${credit?.id}__}" class="btn red btn-sm">
                        <i class="fa fa-file-pdf-o" style="font-size: 1.5em;margin-top: .25em;"></i>
                    </a>
                </td>
            </tr>
        </th:block>
    </th:block>
    <th:block th:unless="${@entityExtranetService.getLoggedUserEntity().containsEntityId(T(com.affirm.common.model.catalog.Entity).BANCO_DEL_SOL)}">
        <th:block th:replace="this :: bodyBeingProcessed"></th:block>
    </th:block>
</th:block>
</body>
</html>