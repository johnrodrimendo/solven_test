<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/extranetTemplate(sidebarClosed=true)"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/jquery.validate.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/additional-methods.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/swipebox/js/jquery.swipebox.min.js'}"></script>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/swipebox/css/swipebox.min.css'}" rel="stylesheet"/>
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/css/bootstrap-datepicker3.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/js/bootstrap-datepicker.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/locales/bootstrap-datepicker.es.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/jquery.validate.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/additional-methods.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.js'}"></script>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.css'}" rel="stylesheet"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/switchery/switchery.min.js'}"></script>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/switchery/switchery.min.css'}"
          rel="stylesheet"/>

    <!-- CounterUp -->
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/counterup/jquery.waypoints.min.js'}"
            type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/counterup/jquery.counterup.min.js'}"
            type="text/javascript"></script>

    <link rel="stylesheet" th:href="@{/css/company.css}" />

    <!-- TablePaginator -->
    <script th:src="@{/js/ext_tablepaginator.js}"></script>

    <script th:inline="javascript">
        Dropzone.autoDiscover = false;
    </script>

    <!-- Locale -->
    <script type="text/javascript">
        moment.locale('es');
    </script>
    <!-- / Locale -->


    <script th:inline="javascript">
        /*<![CDATA[*/
        function closeUploadUserFileModal() {

            if ($("#uploadUserFile").is(':visible')) {
                Dropzone.forElement("div#uploadUserFile").destroy();
                $('#response-block, #usersWillBeAdded').html('');
            }

            $('#uploadVehiclesheetFileModal').modal('hide');

        }
        var vehicleNumber;

        $(document).on('ready', function () {

            var formEmployer = $('#createEmployerForm');
            var jsonValidator = createFormValidationJson(JSON.parse(/*[[${form.validator.toJson(#locale)}]]*/), formEmployer);
            var vehicleToUpload;
            //formEmployer.validateForm(jsonValidator);


            $('#confirmUpload').on('click', function (event) {
                event.preventDefault();


                $('#confirmUpload').loading();

                defaultAjax({
                    url: /*[[@{/vehicles/file/confirm}]]*/null,
                    type: 'POST',
                    data: {
                        //bankArray: JSON.stringify(bankMappings),
                        vehiclesToUpload:JSON.stringify(vehiclesToUpload),
                        disablePrevious: $('#disablePrevious').prop('checked') ? false : true
                    },
                    success: function (data) {
                        resetTimer();
                        var dataJson = JSON.parse(data);

                        $('#confirmUpload').unloading();
                        $('#usersWillBeAdded').html('');
                        if (dataJson.toAdd > 0)
                            $('#usersWillBeAdded').html(successAjaxMessage('Se a&nacute;adieron ' + vehicleNumber + ' de vehiculos.<br/>'));
                        if (dataJson.toUpdate > 0)
                            $('#usersWillBeAdded').html(successAjaxMessage('Se actualizaron ' + vehicleNumber + ' de vehiculos.'));
//                        closeUploadUserFileModal();
                        setTimeout(function () {
                            location.reload();
                        }, 2000);
                    }
                    , error: function () {
                        $('#confirmUpload').unloading();
                        $('#response-block').html(errorAjaxMessage('Se produjo un error inesperado, <br/>por favor int&eacute;ntalo nuevamente o cont&aacute;ctanos.'));
                    }
                });

            });

            //javascript for modal

            $('#uploadFile').on('click', function (event) {

                event.preventDefault();
                $("#uploadUserFile").dropzone({
                    url: /*[[ @{/vehicles/file} ]]*/,
                    paramName: 'file',
                    maxFilesize: /*[[ ${@configuration.MAX_UPLOAD_FILE_SIZE_MB()} ]]*/, // MB
                    maxFiles: 1,
                    dictDefaultMessage: 'Arrastra el archivo excel para cargar o actualizar tu lista de vehiculos.',
                    dictFallbackMessage: "El navegador no soporta esta funcionalidad.",
                    dictFallbackText: 'Ocurrio un error.',
                    dictInvalidFileType: 'El formato no es v&aacute;lido.',
                    dictFileTooBig: 'El tamaño excede el l&iacute;mite.',
                    dictResponseError: 'Ocurrio un error.',
                    dictCancelUpload: 'La operaci&oacute;n fue cancelada.',
                    dictCancelUploadConfirmation: 'La operaci&oacute;n fue cancelada.',
                    dictMaxFilesExceeded: 'Solo se puede subir un archivo a la vez.',
                    acceptedFiles: 'application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/wps-office.xls',
                    headers: addCsrfToJsonHeaders({
                        'x-request-sender-type': 'ajax'
                    }),
                    init: function () {
                        this.on("success", function (file, response) {
                                resetTimer();
                                $('#confirmUpload').enableButton();
                                $('#confirmUpload').prop('disabled',false).css('opacity',1);
                                $('#uploadErrorContainer').html("").hide();
                                if(response.vehiclesToAdd==undefined){
                                    $('#usersWillBeAdded').html(successAjaxMessage('Hubo un error en la lectura de la hoja de vehiculos por favor revise  que no contenga errores y vuelva a intentar'));
                                    $('#confirmUpload').disableButton();
                                    $('#confirmUpload').prop('disabled',true).css('opacity',0.5);
                                }else{
                                    $('#usersWillBeAdded').html(successAjaxMessage('Se agregar&aacute;(n) ' + response.vehiclesToAdd + ' vehiculo(s)'));
                                    vehiclesToUpload=response.vehiclesArr;
                                    vehicleNumber=response.vehiclesToAdd;
                                }

                                if (response.vehiclesWithEmptyfields>0) {
                                    debugger;
                                    $('#uploadErrorContainer').append('Se ignorar&aacute;n <b>' + response.vehiclesWithEmptyfields +
                                        '</b> vehiculo(s) con campos vacios por favor revise si los campos estan completos<br/>');
                                    $('#uploadErrorContainer').show();
                                }

                                if (response.vehiclesWithUnkwonBrand>0) {
                                    debugger;
                                    $('#uploadErrorContainer').append('Se ignorar&aacute;n <b>' + response.vehiclesWithUnkwonBrand +
                                        '</b> vehiculo(s) con una marca desconocida revise si la marca esta correctamente escrita.<br/>');
                                    $('#uploadErrorContainer').show();
                                }

                                if (response.vehiclesRepeated>0) {
                                    debugger;
                                    $('#uploadErrorContainer').append('Se ignorar&aacute;n <b>' + response.vehiclesRepeated +
                                        '</b> vehiculo(s) que se encuentr&aacute;n repetido(s) revise si los datos estan correctamente escrito(s).<br/>');
                                    $('#uploadErrorContainer').show();
                                }

                                $('#actionButtons').fadeIn();
                                //closeUploadUserFileModal();
                            },
                            this.on('error', function (file, response) {
                                this.removeFile(file);
                                console.log(response);
                                $('#usersWillBeAdded').html('');
                                debugger;
                                if (response.constructor == Object) {
                                    if (response.type == "message")
                                        $('#response-block').html(errorAjaxMessage(response.message));
                                } else {
                                    if (response != null && response != '')
                                        $('#response-block').html(errorAjaxMessage(response));
                                    else
                                        $('#response-block').html(errorAjaxMessage('Se produjo un error inesperado, <br/>por favor inténtalo nuevamente o contáctanos.'));
                                }
                            }));
                    }
                });

                $("#bankMappings").hide();
                $("#bankMappingsContainer").html('');
                $("#uploadErrorContainer").hide();
                $('#actionButtons').hide();
                $('#uploadVehiclesheetFileModal').modal({backdrop: 'static', keyboard: false, show: true});

            });

            //javascript for modal

        });
        /*]]>*/
    </script>
</head>
<body>
<th:block layout:fragment="header">
<!--    <th:block th:replace="fragments/headers :: entityDashboardHeader "></th:block>-->
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"></div>
    <!-- END HEADER & CONTENT DIVIDER -->
</th:block>

<th:block layout:fragment="content">

    <!-- Sidebar -->
    <th:block th:replace="fragments/extranetSidebarFragments :: extranetEntitySidebar(currentPage='vehicles')"/>
    <!-- / Sidebar -->

    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <!-- BEGIN CONTENT BODY -->
        <div class="page-content">
            <div class="row">
                <div class="col-lg-12">
                    <div class="portlet light bordered">
                        <div class="portlet-title">
                            <div class="caption">
                                <span class="caption-subject font-green bold uppercase">Carga de Vehículos/ Garantías</span>
                            </div>
                        </div>
                        <div id="portlet-body" class="portlet-body">
                            <div shiro:hasPermission="vehicle:upload:store" class="row">
                                <div class="actions">
                                    <div class="btn-group">
                                        <a class="btn green btn-circle" href="javascript:;" data-toggle="dropdown"
                                           aria-expanded="true">
                                            <i class="fa fa-cog"></i> Acciones
                                            <i class="fa fa-angle-down"></i>
                                        </a>
                                        <ul class="dropdown-menu pull-right">
                                            <li>
                                                <a href="#" id="uploadFile">
                                                    <i class="fa fa-upload"></i> &nbsp;&nbsp;Subir Excel de vehiculos
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="row" style="overflow:auto">
                                <table id="tableResults" class="table table-bordered">
                                    <thead>
                                    <tr>
                                        <th>Marca</th>
                                        <th>Modelo</th>
                                        <th>Aceptado</th>
                                        <th>Año</th>
                                        <th>Kilometros</th>
                                        <th>Valor</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="vehicle: ${vehicleList}">
                                        <td th:text="${@catalogService.getMaintainedCarBrand(vehicle?.maintianedCarBrandId)?.getBrand()}"></td>
                                        <td th:text="${vehicle?.model}"></td>
                                        <td th:text="${vehicle?.getAcceptedValue()}"></td>
                                        <td th:text="${vehicle?.year}"></td>
                                        <td th:text="${@catalogService.getMileage(vehicle?.mileageId)?.mileage}"></td>
                                        <td th:text="${vehicle?.price}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- / Top summary -->
        </div>

        <div id="uploadVehiclesheetFileModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-top">
                        <div class="title-wrap">
                            <h4 class="title-modal">Subir nueva lista</h4>
                        </div>
                        <div class="corner-close">
                            <button class="icon icon-close" data-dismiss="modal" aria-label="Close"></button>
                        </div>
                    </div>
                    <div class="modal-middle text-center">
                        <div id="uploadUserFile" class="dropzone text-center"></div>
                        <div class="text-center">
                            <a th:href="@{/vehicles/excel/template}" class="btn green" download="campos_vehicle.xls"
                               style="margin-top: 1em"> Descargar Formato
                                <i class="fa fa-download"></i>
                            </a>
                        </div>

                        <div id="usersWillBeAdded"
                        style="text-align: left; margin-top: 1em;text-align:center;"></div>
                          <div class="block" style="padding: .5em;" id="response-block"></div>
                         <div class="errorMessage" id="uploadErrorContainer"
                         style="text-align: left; margin-bottom: 1em"></div>

                        <div id="actionButtons" style="display: none">
                            <button type="button" class="button black-button" onclick="closeUploadUserFileModal()">
                                Cancelar
                            </button>
                            <button type="button" class="button bg-red" id="confirmUpload">
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END CONTENT BODY -->
    </div>
    <!-- END CONTENT -->
</th:block>

</body>
</html>