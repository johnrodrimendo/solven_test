<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="templates/extranetTemplate"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&amp;subset=all" rel="stylesheet" type="text/css"/>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.css'}" rel="stylesheet"/>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/ekko-lightbox/dist/ekko-lightbox.min.css'}" rel="stylesheet"/>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/select2/css/select2.min.css'}" rel="stylesheet" type="text/css"/>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/select2/css/select2-bootstrap.min.css'}" rel="stylesheet" type="text/css"/>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/swipebox/css/swipebox.min.css'}" rel="stylesheet"/>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/css/bootstrap-datepicker3.min.css'}"/>

    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/jquery.validate.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/jquery-validation/dist/additional-methods.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/ekko-lightbox/dist/ekko-lightbox.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datetimepicker/bootstrap-datetimepicker.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/counterup/jquery.waypoints.min.js'}" type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/counterup/jquery.counterup.min.js'}" type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/swipebox/js/jquery.swipebox.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/flot/jquery.flot.min.js'}" type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/flot/jquery.flot.resize.min.js'}" type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/flot/jquery.flot.categories.min.js'}" type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/flot/jquery.flot.pie.min.js'}" type="text/javascript"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/locales/bootstrap-datepicker.es.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/select2/js/select2.full.min.js'}" type="text/javascript"></script>
    <script th:src="@{/js/bo_tablefilter.js}"></script>
    <!--Drop Zone-->
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.js'}"></script>
    <link th:href="${@urlService.externalUrl(#httpServletRequest) + '/dropzone/dist/min/dropzone.min.css'}"
          rel="stylesheet"/>
    <script>
        $(document).ready(function(){
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
    <style>
        .dropzone .dz-preview .dz-error-message {
            top: 150px !important;
        }
    </style>
    <script th:inline="javascript">
        Dropzone.autoDiscover = false;
        Dropzone.prototype.defaultOptions.dictRemoveFile = "Elimnar archivo";
        Dropzone.prototype.defaultOptions.dictCancelUpload = "Cancelar subida";
        Dropzone.prototype.defaultOptions.dictCancelUploadConfirmation = "¿Estás seguro de cancelar el proceso?";
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var url = /*[[ @{/__${@entityExtranetLoadNegativeBaseController.URL}__/upload}]]*/null;
        $(document).ready(function () {
            $('#product-selector').selectpicker();

            $("#submitUploadFile").click(function (e){
                e.preventDefault();
                var dZone = Dropzone.forElement("#uploadFileElement");
                setTimeout(function () {
                    dZone.processQueue();
                }, 1000);
            })

            $("#uploadFileElement").dropzone({
                url: url,
                paramName: 'file',
                maxFilesize: 5, // MB
                maxFiles: 1,
                addRemoveLinks: true,
                dictDefaultMessage: 'Arrastra un archivo aqu&#237; para subirlo, o haz click para seleccionar uno.',
                acceptedFiles: '.csv',
                dictInvalidFileType: 'No es posible subir este tipo de archivo',
                headers: addCsrfToJsonHeaders({
                    'x-request-sender-type': 'ajax'
                }),
                autoProcessQueue: false,
                maxfilesexceeded: function(file) {
                    this.removeAllFiles();
                    this.addFile(file);
                },
                init: function () {
                    this.on("addedfile", function (file) {
                        // Dropzone.forElement("#uploadFileElement").removeAllFiles();
                        $( "#submitUploadFile" ).prop( "disabled", false );
                        setTimeout(()=>{
                            if(!file.accepted){
                                $( "#submitUploadFile" ).prop( "disabled", true );
                                this.removeFile(file)
                                showErrorModal('No puede añadir este formato de archivo');
                            }
                        },1000)
                    });
                    this.on("success", function (file, response) {
                        if (response.length > 0) {
                            swal("", "Carga correcta del archivo.", "success");
                            setTimeout(function () {
                                $( "#submitUploadFile" ).prop( "disabled", true );
                                Dropzone.forElement("#uploadFileElement").removeAllFiles();
                            }, 2 * 1000);
                        } else {
                            showErrorModal('No se pudo leer uno o m&#225;s registros. Por favor, verifique que se hayan insertado los datos correctamente.');
                        }
                    });
                    // this.on("error", function (file, response) {
                    //     swal("", response.message, "error");
                    //     $( "#submitUploadFile" ).prop( "disabled", true );
                    //     Dropzone.forElement("#uploadFileElement").removeAllFiles();
                    // });
                    this.on("sending", function (file, xhr, data) {
                        data.append("action", $("#action-selector").val());
                    });

                }
            });
            $('#uploadFileDiv').show(300);

            function reloadResultsUploadPreApprovedBase() {
                defaultAjax({
                    url: /*[[ @{/__${@entityExtranetLoadNegativeBaseController.URL}__/upload/list}]]*/,
                    type: 'POST',
                    showLoading: false,
                    success: function (data) {
                        $('#loansLightResultTable').html(data);
                        $('[data-toggle="tooltip"]').tooltip();
                    }
                });
                setTimeout(reloadResultsUploadPreApprovedBase, 5000);
            }

            setTimeout(reloadResultsUploadPreApprovedBase, 5000);

        });

        /*]]>*/
    </script>

</head>
<body>
<th:block layout:fragment="header">
<!--    <th:block th:replace="fragments/headers :: entityDashboardHeader "></th:block>-->
    <div class="clearfix"></div>
</th:block>
<th:block layout:fragment="content">
    <th:block th:replace="fragments/extranetSidebarFragments :: extranetEntitySidebar(currentPage=${page})"></th:block>
    <div class="page-content-wrapper">
        <div class="page-content">
            <div class="row w-creditos-procesados">

                <th:block th:replace="fragments/headers :: entityContentHeader(title=${title})"></th:block>

                <div class="col-lg-12">
                    <div class="portlet light bordered tablefilter">
<!--                        <div class="portlet-title">-->
<!--                            <div class="caption">-->
<!--                                <span class="caption-subject font-green bold uppercase" th:text="${title}"></span>-->
<!--                            </div>-->
<!--                        </div>-->
                        <div class="portlet-body" style="width: 100%; display: flex; align-items: center;">

                            <div id="uploadFileDiv" class="col-sm-12 col-md-6 col-lg-4"
                                 style="display: none">
                                <div id="uploadFileElement" class="dropzone"></div>
                                <div>Formatos aceptados: .csv</div>
                            </div>

                            <div class="form-group">
                                <label class="control-label"><b></b><br/>Acción</label>
                                <select class="form-control input-sm form-control-sm selectpicker" id="action-selector" name="action">
                                    <option value="A" selected="true">Adicionar registros</option>
                                    <option value="O">Sobreescribir registros</option>
                                </select>
                            </div>

                            <button type="button" class="button" id="submitUploadFile" disabled="true">
                                <i class="fa fa-upload"></i> &nbsp;&nbsp;Subir archivo
                            </button>

                            <a th:if="${templateUrl != null}" th:href="${templateUrl}" target="_blank" style="margin-left: 15px">
                                <button type="button" class="button">
                                    <i class="fa fa-download"></i> &nbsp;&nbsp;Descargar plantilla
                                </button>
                            </a>
                        </div>
                </div>
            </div>
                <div class="col-lg-12">
                    <div class="portlet light bordered tablefilter">
                        <div class="portlet-title">
                            <div class="caption">
                                <span class="caption-subject font-green bold uppercase">HISTÓRICO DE CARGA</span>
                            </div>
                        </div>
                        <div class="portlet-body" style="width: 100%">
                            <div class="table-responsive" id="loansLightResultTable">
                                <th:block th:replace="this :: historicDataResults"></th:block>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        </div>
    </div>


</th:block>

<th:block th:fragment="historicDataResults">
    <table class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <th>Fec. Registro</th>
            <th>Fec. Procesamiento</th>
            <th>Acción</th>
            <th>Estatus</th>
        </tr>
        </thead>
        <tbody>
        <th:block th:if="${not #lists.isEmpty(historicData)}" th:each="report : ${historicData}">
            <tr>
                <td th:text="${@utilService.datetimeShortFormat(report.registerDate)}" th:attr="data-order=${@utilService.datetimeYearFirstFormat(report?.registerDate)}"></td>
                <td th:text="${@utilService.datetimeShortFormat(report.processDate)}" th:attr="data-order=${@utilService.datetimeYearFirstFormat(report?.processDate)}"></td>
                <th:block th:switch="${report.type}">
                    <td th:case="'A'">Adicionar registros</td>
                    <td th:case="'O'">Sobreescribir registros</td>
                </th:block>
                <th:block th:switch="${report.status}">
                    <td>
                        <th:block th:switch="${report.status}">
                            <th:block th:case="'P'"><span class="label label-xs label-warning">Pendiente</span></th:block>
                            <th:block th:case="'F'"><span class="label label-xs label-danger">Fallido</span></th:block>
                            <th:block th:case="'S'"><span class="label label-xs label-success">Procesada</span></th:block>
                        </th:block>
                        <i class="fa fa-info" th:if="${report.errorDetail?.customMessage != null}" style="margin-left: 5px" data-toggle="tooltip" th:title="${report.errorDetail?.customMessage}"></i>
                    </td>
                </th:block>
            </tr>
        </th:block>
        <th:block th:if="${#lists.isEmpty(historicData)}">
            <tr>
                <td colspan="4">
                    No hay resultados.
                </td>
            </tr>
        </th:block>
        </tbody>
    </table>
</th:block>

</body>
</html>