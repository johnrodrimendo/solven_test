<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8"/>
</head>
<body>

<th:block th:fragment="all">
    <th:block th:replace="components/tracking :: utm-capture">

    </th:block>

    <th:block th:replace="components/tracking :: social">

    </th:block>
</th:block>


<th:block th:fragment="social">
    <script>
        var GA_LOCAL_STORAGE_KEY = 'ga:clientId';
        var dataLayer = [{
            'clientId': localStorage.getItem(GA_LOCAL_STORAGE_KEY),
        }];
    </script>
    <!-- Google Tag Manager -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer', 'GTM-PD9QXBH');
        /*]]>*/
    </script>
    <!-- End Google Tag Manager -->
</th:block>

<th:block th:fragment="utm-capture">
    <script th:inline="javascript" async="async">
        /*<![CDATA[*/
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function setCookie(name, value, days){
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            var expires = "; expires=" + date.toGMTString();
            document.cookie = name + "=" + encodeURI(value) + expires + ";path=/";
        }

        function getParam(p){
            var match = RegExp('[?&]' + p + '=([^&]*)').exec(window.location.search);
            return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
        }


        var source = getParameterByName('utm_source');
        var medium = getParameterByName('utm_medium');
        var campaign = getParameterByName('utm_campaign');
        var term = getParameterByName('utm_term');
        var content = getParameterByName('utm_content');
        var marketingCampaignId = getParameterByName('marketing_campaign');

        var gclid = getParam('gclid');


        document.getElementsByName("utm_source").value = source;
        document.getElementsByName("utm_medium").value = medium;
        document.getElementsByName("utm_campaign").value = campaign;
        document.getElementsByName("utm_term").value = term;
        document.getElementsByName("utm_content").value = content;
        document.getElementsByName("marketing_campaign").value = marketingCampaignId;

        if(gclid){
            var gclsrc = getParam('gclsrc');
            if(!gclsrc || gclsrc.indexOf('aw') !== -1){
                setCookie('gclid', gclid, 90);
            }
        }

        if (!(source === null) && (sessionStorage.getItem("utm_source") === null || sessionStorage.getItem("utm_source") === undefined)) {
            sessionStorage.setItem("utm_source", source);
        }

        if (!(medium === null) && (sessionStorage.getItem("utm_medium") === null || sessionStorage.getItem("utm_medium") === undefined)) {
            sessionStorage.setItem("utm_medium", medium);
        }

        if (!(campaign === null) && (sessionStorage.getItem("utm_campaign") === null || sessionStorage.getItem("utm_campaign") === undefined)) {
            sessionStorage.setItem("utm_campaign", campaign);
        }

        if (!(term === null) && (sessionStorage.getItem("utm_term") === null || sessionStorage.getItem("utm_term") === undefined)) {
            sessionStorage.setItem("utm_term", term);
        }

        if (!(content === null) && (sessionStorage.getItem("utm_content") === null || sessionStorage.getItem("utm_content") === undefined)) {
            sessionStorage.setItem("utm_content", content);
        }

        if (!(marketingCampaignId === null) && (sessionStorage.getItem("marketing_campaign") === null || sessionStorage.getItem("marketing_campaign") === undefined)) {
            sessionStorage.setItem("marketing_campaign", marketingCampaignId);
        }
        /*]]>*/
    </script>
</th:block>

</body>
</html>