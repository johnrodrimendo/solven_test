<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="templates/defaultTemplate">

<head>
    <meta charset="ISO-8859-1"/>
    <title>Reporte de Pantallas</title>
    <script th:src="@{/js/bo_tablefilter.js}"></script>
    <link rel="stylesheet"
          th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/css/bootstrap-datepicker3.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/js/bootstrap-datepicker.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/locales/bootstrap-datepicker.es.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/moment/min/moment.min.js'}"></script>
    <link rel="stylesheet"
          th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-multiselect/css/bootstrap-multiselect.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-multiselect/js/bootstrap-multiselect.js'}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function () {
            $('#downloadTrackReportButton').click(function () {
                $('#trackReportValidationResult').text('');
                if ($('#trackReportFromFilter').val() == '' || $('#trackReportUntilFilter').val() == '') {
                    $('#trackReportValidationResult').text('Ingresa la fecha desde y hasta.');
                    return;
                }
                var baseUrl = /*[[@{/reporting/screenTrackReporting/export}]]*/null;

                defaultAjax({
                    url: baseUrl + "?fromFilter=" + $('#trackReportFromFilter').val() + "&untilFilter=" + $('#trackReportUntilFilter').val(),
                    type: 'GET',
                    success: function (data) {
                        location.reload();
                    }
                });
            });
            $('#downloadScreenReportButton').click(function () {
                $('#screenReportValidationResult').text('');
                if ($('#screenReportFromFilter').val() == '' || $('#screenReportUntilFilter').val() == '') {
                    $('#screenReportValidationResult').text('Ingresa la fecha desde y hasta.');
                    return;
                }
                var baseUrl = /*[[@{/reporting/screenReporting/export}]]*/null;

                defaultAjax({
                    url: baseUrl + "?" + $('#screenReportForm').serialize(),
                    type: 'GET',
                    success: function (data) {
                        location.reload();
                    }
                });
            });
        });

        function reloadResults() {
            defaultAjax({
                url: /*[[@{/reporting/screenReporting/list}]]*/,
                type: 'POST',
                showLoading: false,
                success: function (data) {
                    $('#resultScreenTable').html(data);
                }
            });

            defaultAjax({
                url: /*[[@{/reporting/screenTrackReporting/list}]]*/,
                type: 'POST',
                showLoading: false,
                success: function (data) {
                    $('#resultTrackScreenTable').html(data);
                }
            });

            setTimeout(reloadResults, 5000);
        }

        setTimeout(reloadResults, 5000);
        /*]]>*/
    </script>
</head>
<body>
<th:block layout:fragment="content">
    <div class="page-head"></div>
    <div class="page-content">
        <div class="container">
            <ul class="page-breadcrumb breadcrumb">
                <li>
                    <a th:href="@{/}">Home</a>
                    <i class="fa fa-circle"></i>
                </li>
                <li>
                    <span>Reportes</span>
                    <i class="fa fa-circle"></i>
                </li>
                <li>
                    <span>Reportes de Pantallas</span>
                </li>
            </ul>
            <div class="page-content-inner">
                <div class="row">
                    <div class="col-md-12 ">
                        <div class="row">
                            <div class="col-md-6 ">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div th:class="${@frontEndService.getDefaultPortletClass()}">
                                            <div class="portlet-title tabbable-line">
                                                <div th:class="${@frontEndService.getDefaultCaptionClass()}">
                                                    <span th:class="${@frontEndService.getDefaultCaptionSubjectClass()}">Reporte de Pantallas</span>
                                                </div>
                                                <div class="actions"></div>
                                            </div>
                                            <div class="portlet-body">
                                                <form id="screenReportForm">
                                                    <div class="form-row">
                                                        <!-- Fecha de registro -->
                                                        <div class="form-row col-md-7">
                                                            <div class="form-group col-md-6">
                                                                <label class="control-label"><b>Fecha reporte</b><br/>Desde</label>
                                                                <input id="screenReportFromFilter" name="fromFilter"
                                                                       type="text" class="form-control form-control-sm"
                                                                       placeholder="Desde"/>
                                                            </div>
                                                            <div class="form-group col-md-6">
                                                                <label class="control-label"><b></b><br/>Hasta</label>
                                                                <input id="screenReportUntilFilter" name="untilFilter"
                                                                       type="text" class="form-control form-control-sm"
                                                                       placeholder="Hasta"/>
                                                            </div>
                                                            <script th:inline="javascript">
                                                                /*<![CDATA[*/
                                                                var creationFromFilter = $('#screenReportFromFilter');
                                                                var creationToFilter = $('#screenReportUntilFilter');
                                                                datepicker(creationFromFilter);
                                                                datepicker(creationToFilter);

                                                                function datepicker(obj) {
                                                                    obj.datepicker({
                                                                        autoclose: true,
                                                                        format: "dd/mm/yyyy",
                                                                        focusOnShow: true,
                                                                        endDate: "today"
                                                                    });
                                                                }

                                                                creationFromFilter.on('change', function () {
                                                                    creationToFilter.datepicker('setStartDate', creationFromFilter.val());
                                                                });
                                                                /*]]>*/
                                                            </script>
                                                        </div>
                                                    </div>
                                                    <div class="form-row ">
                                                        <div class="form-group col-md-6">
                                                            <div><label
                                                                    class="control-label"><b>Productos</b><br/></label>
                                                            </div>
                                                            <select id="screenReportProductFilter"
                                                                    name="productFilter[]" multiple="multiple"
                                                                    class="form-control form-control-sm">
                                                                <option th:each="product : ${@catalogService.getProducts()}"
                                                                        th:value="${product.id}"
                                                                        th:text="${product.name}"></option>
                                                            </select>
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <div><label
                                                                    class="control-label"><b>Estados</b><br/></label>
                                                            </div>
                                                            <select id="screenReportStatusFilter" name="statusFilter[]"
                                                                    multiple="multiple"
                                                                    class="form-control form-control-sm">
                                                                <option th:each="status : ${@catalogService.getLoanApplicationStatuses(#locale)}"
                                                                        th:value="${status.id}"
                                                                        th:text="${status.status}"></option>
                                                            </select>
                                                        </div>
                                                        <script th:inline="javascript">
                                                            /*<![CDATA[*/
                                                            var screenReportProductFilter = $('#screenReportProductFilter');
                                                            var screenReportStatusFilter = $('#screenReportStatusFilter');
                                                            multiselect(screenReportProductFilter);
                                                            multiselect(screenReportStatusFilter);

                                                            function multiselect(obj) {
                                                                obj.multiselect({
                                                                    buttonWidth: '200px',
                                                                    nonSelectedText: 'Ninguno',
                                                                    numberDisplayed: 1,
                                                                    nSelectedText: ' Seleccionados'
                                                                });
                                                            }

                                                            /*]]>*/
                                                        </script>
                                                    </div>
                                                </form>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <button id="downloadScreenReportButton" type="button"
                                                                class="btn btn-info">Descargar Reporte
                                                        </button>
                                                    </div>
                                                    <div id="screenReportValidationResult"
                                                         class="col-md-4 font-red-thunderbird"></div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="portlet transparent">
                                                            <div class="portlet-title">
                                                                <div th:class="${@frontEndService.getDefaultCaptionClass()}">
                                                                    <span th:class="${@frontEndService.getDefaultCaptionSubjectClass()}">Historico de Reportes</span>
                                                                </div>
                                                            </div>
                                                            <div class="portlet-body">
                                                                <div class="table-responsive" id="resultScreenTable">
                                                                    <th:block
                                                                            th:replace="this :: screensresult"></th:block>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 ">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div th:class="${@frontEndService.getDefaultPortletClass()}">
                                            <div class="portlet-title tabbable-line">
                                                <div th:class="${@frontEndService.getDefaultCaptionClass()}">
                                                    <span th:class="${@frontEndService.getDefaultCaptionSubjectClass()}">Reporte de Pantallas Recorridas</span>
                                                </div>
                                                <div class="actions"></div>
                                            </div>
                                            <div class="portlet-body">
                                                <div class="form-row">

                                                    <div class="form-row col-md-7">
                                                        <div class="form-group col-md-6">
                                                            <label class="control-label"><b>Fecha reporte</b><br/>Desde</label>
                                                            <input id="trackReportFromFilter" type="text"
                                                                   class="form-control form-control-sm"
                                                                   placeholder="Desde"/>
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label class="control-label"><b></b><br/>Hasta</label>
                                                            <input id="trackReportUntilFilter" type="text"
                                                                   class="form-control form-control-sm"
                                                                   placeholder="Hasta"/>
                                                        </div>
                                                        <script th:inline="javascript">
                                                            /*<![CDATA[*/
                                                            var trackReportFromFilter = $('#trackReportFromFilter');
                                                            var trackReportUntilFilter = $('#trackReportUntilFilter');
                                                            datepicker(trackReportFromFilter);
                                                            datepicker(trackReportUntilFilter);

                                                            function datepicker(obj) {
                                                                obj.datepicker({
                                                                    autoclose: true,
                                                                    format: "dd/mm/yyyy",
                                                                    focusOnShow: true,
                                                                    endDate: "today"
                                                                });
                                                            }

                                                            trackReportFromFilter.on('change', function () {
                                                                trackReportUntilFilter.datepicker('setStartDate', trackReportFromFilter.val());
                                                            });
                                                            /*]]>*/
                                                        </script>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <button id="downloadTrackReportButton" type="button"
                                                                class="btn btn-info">Descargar Reporte
                                                        </button>
                                                    </div>
                                                    <div id="trackReportValidationResult"
                                                         class="col-md-4 font-red-thunderbird"></div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="portlet transparent">
                                                            <div class="portlet-title">
                                                                <div th:class="${@frontEndService.getDefaultCaptionClass()}">
                                                                    <span th:class="${@frontEndService.getDefaultCaptionSubjectClass()}">Historico de Reportes</span>
                                                                </div>
                                                            </div>
                                                            <div class="portlet-body">
                                                                <div class="table-responsive"
                                                                     id="resultTrackScreenTable">
                                                                    <th:block
                                                                            th:replace="this :: trackresult"></th:block>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div th:class="${@frontEndService.getDefaultPortletClass()}">
                            <div class="portlet-title tabbable-line">
                                <div th:class="${@frontEndService.getDefaultCaptionClass()}">
                                    <span th:class="${@frontEndService.getDefaultCaptionSubjectClass()}">Índice de Pantallas</span>
                                </div>
                                <div class="actions"></div>
                            </div>
                            <div class="portlet-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Denominación</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="question : ${processQuestions}">
                                            <td th:text="${question.id}"></td>
                                            <td th:text="${question.question}"></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="screensresult">
    <table class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <th>Fec. Registro</th>
            <th>Fec. Procesamiento</th>
            <th>Estatus</th>
            <th>Fecha de corte</th>
            <th>Productos</th>
            <th>Estados</th>
            <th>Url</th>
        </tr>
        </thead>
        <tbody>
        <th:block th:each="report : ${historicScreenReports}">
            <tr>
                <td th:text="${@utilService.datetimeShortFormat(report.registerDate)}"
                    th:attr="data-order=${@utilService.datetimeYearFirstFormat(report?.registerDate)}"></td>
                <td th:text="${@utilService.datetimeShortFormat(report.processDate)}"
                    th:attr="data-order=${@utilService.datetimeYearFirstFormat(report?.processDate)}"></td>
                <th:block th:switch="${report.status}">
                    <td th:case="'P'"><span class="label label-xs label-warning">Pendiente</span></td>
                    <td th:case="'F'"><span class="label label-xs label-danger">Fallido</span></td>
                    <td th:case="'S'"><span class="label label-xs label-success">Procesada</span></td>
                </th:block>
                <td th:text="${report.params != null and !report.params.isNull('startDate') ? report.params.get('startDate').toString() + ' - ' + report.params.get('endDate').toString() : '' }"></td>
                <td th:text="${report.params != null and !report.params.isNull('products') ? @utilService.getProductsFunnelByIds(report.params.get('products')) : ''}"></td>
                <td th:text="${report.params != null and !report.params.isNull('statuses') ? @utilService.getStatusesFunnelByIds(report.params.get('statuses')) : ''}"></td>
                <td>
                    <a th:if="${report.url != null}" th:href="${@reportsService.createReportDownloadUrl(report.id)}"
                       target="_blank">Descargar</a>
                </td>
            </tr>
        </th:block>
        </tbody>
    </table>
</th:block>

<th:block th:fragment="trackresult">
    <table class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <th>Fec. Registro</th>
            <th>Fec. Procesamiento</th>
            <th>Estatus</th>
            <th>Fecha de corte</th>
            <th>Url</th>
        </tr>
        </thead>
        <tbody>
        <th:block th:each="report : ${historicTrackScreenReports}">
            <tr>
                <td th:text="${@utilService.datetimeShortFormat(report.registerDate)}"
                    th:attr="data-order=${@utilService.datetimeYearFirstFormat(report?.registerDate)}"></td>
                <td th:text="${@utilService.datetimeShortFormat(report.processDate)}"
                    th:attr="data-order=${@utilService.datetimeYearFirstFormat(report?.processDate)}"></td>
                <th:block th:switch="${report.status}">
                    <td th:case="'P'"><span class="label label-xs label-warning">Pendiente</span></td>
                    <td th:case="'F'"><span class="label label-xs label-danger">Fallido</span></td>
                    <td th:case="'S'"><span class="label label-xs label-success">Procesada</span></td>
                </th:block>
                <td th:text="${report.params != null ? report.params.get('startDate').toString() + ' - ' + report.params.get('endDate').toString() : '' }"></td>
                <td>
                    <a th:if="${report.url != null}" th:href="${@reportsService.createReportDownloadUrl(report.id)}"
                       target="_blank">Descargar</a>
                </td>
            </tr>
        </th:block>
        </tbody>
    </table>
</th:block>

</body>

</html>