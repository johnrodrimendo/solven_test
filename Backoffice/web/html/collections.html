<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="templates/defaultTemplate">

<head>
    <meta charset="ISO-8859-1"/>
    <title>Cobranzas</title>
    <script th:src="@{/js/bo_tablefilter.js}"></script>
    <link rel="stylesheet" th:href="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/css/bootstrap-datepicker3.css'}"/>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/js/bootstrap-datepicker.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/bootstrap-datepicker/dist/locales/bootstrap-datepicker.es.min.js'}"></script>
    <script th:src="${@urlService.externalUrl(#httpServletRequest) + '/moment/min/moment.min.js'}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var contactResultCatalog = JSON.parse(/*[[${@utilService.toJson(@catalogService.getContactResults())}]]*/);
        function saveContactResult(contactResultId, creditId) {
            for (i = 0; i < contactResultCatalog.length; i++) {
                if (contactResultCatalog[i].id == contactResultId) {
                    openContactResultModal(creditId, contactResultId, contactResultCatalog[i].dateRequired, contactResultCatalog[i].amountRequired);
                    return;
                }
            }
        }
        function openContactResultModal(creditId, contactResultId, dateRequired, amountRequired) {
            $('#contactResultModalDate').val("");
            $('#contactResultModalAmount').val("");
            $('#contactResultModalComment').val("");
            $('#contactResultModalDate').datepicker({
                autoclose: true,
                toggleActive: true,
                format: "dd/mm/yyyy",
                startDate: "0d",
                defaultDate: new Date(),
            });
            dateRequired ? $('#contactResultModalDateDiv').show() : $('#contactResultModalDateDiv').hide();
            amountRequired ? $('#contactResultModalAmountDiv').show() : $('#contactResultModalAmountDiv').hide();
            $('#contactResultModal').modal();
            $('#contactResultModalSaveButton').off('click');
            $('#contactResultModalSaveButton').click(function () {
                registerContactResult(creditId, contactResultId);
            });
        }
        function registerFraud(creditId){
            var baseUrl = /*[[@{/credit/}]]*/;
            defaultAjax({
                url: baseUrl + creditId + "/registerFraud/",
                type: 'POST',
                success: function (data) {
                    toastr.success("Se registró la acción");
                }
            })
        }
        function registerContactResult(creditId, contactResultId) {
            var baseUrl = /*[[@{/credit/}]]*/;
            defaultAjax({
                url: baseUrl + creditId + "/registerCollectionContactResult/",
                type: 'POST',
                data: {
                    contactResultId: contactResultId,
                    date: $('#contactResultModalDate').val(),
                    amount: $('#contactResultModalAmount').val(),
                    comment: $('#contactResultModalComment').val()
                },
                success: function (data) {
                    toastr.success("Se registró la acción");
                    $('#contactResultModal').modal('hide');
                }
            })
        }
        /*]]>*/
    </script>
</head>

<body>

<th:block layout:fragment="content">
    <div class="page-head">
    </div>
    <div class="page-content">
        <div class="container">
            <ul class="page-breadcrumb breadcrumb">
                <li>
                    <a th:href="@{/}">Home</a>
                    <i class="fa fa-circle"></i>
                </li>
                <li>
                    <span>Cobranzas</span>
                </li>
            </ul>
            <div class="page-content-inner">
                <div class="row">
                    <div class="col-md-12 ">
                        <div th:class="${@frontEndService.getDefaultPortletClass()}+' tablefilter'">
                            <div class="portlet-title">
                                <div th:class="${@frontEndService.getDefaultCaptionClass()}">
                                    <span th:class="${@frontEndService.getDefaultCaptionSubjectClass()}">Cobranzas</span>
                                </div>
                                <div class="actions">
                                    <a th:class="${@frontEndService.defaultActionButtonClass}+' tablefilter-action-button'"
                                       href="javascript:;">
                                        <i class="fa fa-filter"></i> Filtros
                                    </a>
                                    <a th:class="${@frontEndService.defaultActionButtonClass}+' tablefilter-action-button-clean'" href="javascript:;">
                                        <i class="fa fa-filter"></i> Limpiar Filtros</a>
                                    <div class="table-paginator-info" style="display: inline-block;vertical-align: top;margin-top: .5em;margin-right: 1em;"></div>
                                </div>
                            </div>
                            <div class="portlet-title tablefilter-filters" style="display: none">
                                <form role="form" method="post" th:action="@{/collections/filter}">
                                    <div class="form-row">
                                        <!-- Producto -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />Producto</label>
                                            <select name="product" class="form-control input-sm form-control-sm">
                                                <option value=""></option>
                                                <option th:each="product : ${@catalogService.getProducts()}" th:value="${product.id}" th:text="${product.name}"></option>
                                            </select>
                                        </div>

                                        <!-- Cluster -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />Cluster</label>
                                            <select name="cluster" class="form-control input-sm form-control-sm">
                                                <option value=""></option>
                                                <option th:each="cluster : ${@catalogService.getClusters(#locale)}" th:value="${cluster.id}" th:text="${cluster.cluster}"></option>
                                            </select>
                                        </div>

                                        <!-- D.N.I. -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />D.N.I.</label>
                                            <input name="documentNumber" type="text" class="form-control input-sm form-control-sm"/>
                                        </div>

                                        <!-- Gestor asignado -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />Gestor asignado</label>
                                            <input name="collector" type="text" class="form-control input-sm form-control-sm"/>
                                        </div>

                                        <!-- Financiador -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />Financiador</label>
                                            <select name="entity" class="form-control input-sm form-control-sm">
                                                <option value=""></option>
                                                <option th:each="entity : ${@catalogService.getEntities()}" th:value="${entity.id}" th:text="${entity.shortName}"></option>
                                            </select>
                                        </div>

                                        <!-- Empleador -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />Empleador</label>
                                            <select name="employer" class="form-control input-sm form-control-sm">
                                                <option value=""></option>
                                                <option th:each="employer : ${@catalogService.getEmployers()}" th:value="${employer.id}" th:text="${employer.name}"></option>
                                            </select>
                                        </div>

                                        <!--  Tramo -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />Tramo</label>
                                            <select name="tranche" class="form-control input-sm form-control-sm">
                                                <option value=""></option>
                                                <option th:each="tranche : ${@catalogService.getTranches()}" th:value="${tranche.id}" th:text="${tranche.tranche}"></option>
                                            </select>
                                        </div>

                                        <!-- La pausa -->
                                        <div class="form-group col-md-1">
                                            <label class="control-label"><b></b><br />La pausa</label>
                                            <select name="paused" class="form-control input-sm form-control-sm">
                                                <option value="" hidden="hidden">La pausa</option>
                                                <option value="true">Pausado</option>
                                                <option value="false">No pausado</option>
                                            </select>
                                        </div>

                                        <!-- Fecha -->
                                        <div class="form-row col-md-2">
                                            <div class="form-group col-md-6">
                                                <label class="control-label"><b>Fec. ingreso a mora</b><br />Desde</label>
                                                <input id="dueDateFrom" name="dueDateFrom" type="text" class="form-control input-sm form-control-sm" th:value="${period1From != null ? @utilService.dateCustomFormat(period1From, 'dd-MM-yyyy', #locale) : ''}" />
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label class="control-label"><b></b><br/>Hasta</label>
                                                <input id="dueDateTo" name="dueDateTo" type="text" class="form-control input-sm form-control-sm" th:value="${period1To != null ? @utilService.dateCustomFormat(period1To, 'dd-MM-yyyy', #locale) : ''}" />
                                            </div>
                                            <script th:inline="javascript">
                                                /*<![CDATA[*/
                                                var dueDateFrom = $('#dueDateFrom');
                                                var dueDateTo = $('#dueDateTo');
                                                datepicker(dueDateFrom);
                                                datepicker(dueDateTo);
                                                function datepicker( obj ){
                                                    obj.datepicker({
                                                        autoclose: true,
                                                        format: "dd/mm/yyyy",
                                                        focusOnShow: true,
                                                        endDate: "today"
                                                    });
                                                }
                                                dueDateFrom.on('change', function () {
                                                    dueDateTo.datepicker('setStartDate', dueDateFrom.val());
                                                });
                                                /*]]>*/
                                            </script>
                                        </div>
                                    </div>

                                </form>
                            </div>
                            <div class="portlet-body">
                                <div id="collectionsTable" class="tablefilter-table"
                                     th:switch="${#lists.isEmpty(creditCollection?.results)}">
                                    <div th:case="true">
                                        <p>No hay resultados</p>
                                    </div>
                                    <div th:case="false" id="table">
                                        <th:block th:replace="this :: list"></th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BEGIN MODAL -->
    <div id="contactResultModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="content">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6" id="contactResultModalDateDiv">
                                <div class="form-group">
                                    <label class="control-label" for="contactResultModalDate">Seleccione la fecha de
                                        contacto</label>
                                    <input type="text" id="contactResultModalDate" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-6" id="contactResultModalAmountDiv">
                                <div class="form-group">
                                    <label class="control-label" for="contactResultModalAmount">Monto promesa de
                                        pago</label>
                                    <input type="text" id="contactResultModalAmount" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="control-label" for="contactResultModalComment">Comentarios</label>
                                    <textarea cols="2" id="contactResultModalComment" class="form-control"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                        <button id="contactResultModalSaveButton" type="button" class="btn btn-info">
                            Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END MODAL -->
</th:block>

<th:block th:fragment="list">
    <th:block th:switch="${#lists.isEmpty(creditCollection)}">
        <p th:case="true">No hay resultados</p>

        <table th:case="false" id="tableResults" class="table table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th>País</th>
                <th>Crédito</th>
                <th>Vencimiento</th>
                <th>Cliente</th>
                <th>Datos contacto</th>
                <th>Producto</th>
                <th>Condiciones</th>
                <th>Cluster</th>
                <th>Gestor asignado</th>
                <th>Financiador</th>
                <th>Cuota</th>
                <th>Monto a abonar</th>
                <!--<th>Monto sgt. cuota a abonar</th>-->
                <th>Situación</th>
                <th>Tramo</th>
                <th>La pausa</th>
                <th>Resultado</th>
                <th></th>
                <th></th>
            </tr>
            </thead>

            <tbody th:attr="data-table-paginator-total=${creditCollection?.meta?.total}">
            <tr th:each="coll, iterColl : ${creditCollection?.results}"
                th:style="'background-color:'+${loan?.lineColor}">
                <td th:text="${iterColl.count}"></td>
                <td>
                    <div class="choose-country">
                        <span th:class="'c-language c' + ${coll?.country?.id}"></span>
                    </div>
                </td>
                <td>
                    <a th:href="@{/person(personId=${coll?.personContactInformation?.personId}, tab='credits')}"
                       th:text="${coll?.code}"></a></td>
                <td th:text="${@utilService.dateFormat(coll?.dueDate)}" th:attr="data-order=${@utilService.datetimeYearFirstFormat(coll?.dueDate)}"></td>
                <td th:text="${coll?.getFullName()}"></td>
                <td>
                    <dl class="dl-vertical">
                        <dd th:text="${coll?.personContactInformation?.email}"></dd>
                        <dd><span th:text="'('+${coll?.personContactInformation?.phoneCountryCode}+') '"></span>
                            <span th:text="${coll?.personContactInformation?.phoneNumber}"></span></dd>
                    </dl>
                </td>
                <td th:text="${coll?.product?.name}"></td>
                <td th:text="${coll?.getCreditDescription(@utilService)}"></td>
                <td align="center" th:text="${coll?.cluster?.cluster}"></td>
                <td></td>
                <td th:text="${coll?.entity?.shortName}"></td>
                <td align="center" th:text="${coll?.maxInstallmentId} + ' (' + ${coll?.countInstallments} + ')'"></td>
                <!--<td align="right"-->
                    <!--th:text="${@utilService.doubleMoneyFormat(coll?.pendingInstallmentAmount, T(com.affirm.system.configuration.Configuration).SOLES_CURRENCY)}"></td>-->
                <td align="right"
                    th:text="${@utilService.doubleMoneyFormat(coll?.collection, T(com.affirm.system.configuration.Configuration).SOLES_CURRENCY)}"></td>
                <td th:if="${coll?.getDaysInArrears() &lt; 1 and !coll?.getExpiring()}"><span
                        class="label label-sm label-success">Al día</span>
                </td>
                <td th:if="${coll?.getExpiring()} "><span
                        class="label label-sm label-warning" th:text="'Por vencer'"></span>
                </td>
                <td th:if="${coll?.getDaysInArrears() &gt; 0 and !coll?.getExpiring()}"><span
                        class="label label-sm label-danger f"
                        th:text="${coll?.getDaysInArrears()} + ' días vencido'"></span>
                </td>
                <td th:text="${coll?.getTranche()}"></td>
                <td></td>
                <td></td>
                <td>
                    <div class="btn-group">
                        <a th:class="${@frontEndService.getDefaultInsidePortletButtonClass()}"
                           href="javascript:;" data-toggle="dropdown"
                           aria-expanded="false">
                            Acciones <i class="fa fa-angle-down"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="dropdown-submenu pull-left" style="width: 100%">
                                <a href="javascript:;" tabindex="-1"
                                   class="font-grey-gallery sbold">Contacto</a>
                                <ul class="dropdown-menu">
                                    <li th:each="contact : ${@catalogService.getContactResultsByType('Contacto')}">
                                        <a href="javascript:;"
                                           th:onclick="'saveContactResult('+${contact.id}+','+${coll?.id}+')'"
                                           th:text="${contact.result}"></a>
                                    </li>
                                </ul>
                            </li>
                            <li class="dropdown-submenu pull-left" style="width: 100%">
                                <a href="javascript:;" class="font-grey-gallery sbold">No
                                    contacto</a>
                                <ul class="dropdown-menu">
                                    <li th:each="contact : ${@catalogService.getContactResultsByType('No Contacto')}">
                                        <a href="javascript:;"
                                           th:onclick="'saveContactResult('+${contact.id}+','+${coll?.id}+')'"
                                           th:text="${contact.result}"></a>
                                    </li>
                                </ul>
                            </li>
                            <li class="pull-left" style="width: 100%">
                                <a href="javascript:;"
                                   th:onclick="'registerFraud('+${coll?.id}+')'"
                                   class="font-grey-gallery sbold">Registra Fraude</a>
                            </li>
                        </ul>
                    </div>
                </td>
                <td>
                    <a target="_blank" class="label label-sm label-info"
                       th:href="@{/person/viewextranet(userId=${coll.userId})}">VER
                        EXTRANET</a>
                </td>
            </tr>
            </tbody>
        </table>
        <script th:inline="javascript">
        /*<![CDATA[*/
            UtilModule.reindexOnReload();
        /*]]>*/
    </script>
    </th:block>

</th:block>

</body>

</html>